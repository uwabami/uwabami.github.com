<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>schroot&#58;お手軽コンテナ(?)</title>
<meta name="description" content="Youhei SASAKI's official site. My Interest: Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian">
<link rel="stylesheet" href="/css/main.css" >
<link rel="stylesheet" href="/assets/fontawesome/css/all.min.css" >
<link rel="canonical" href="/cc-env/DebianSchroot.html">

<link rel="alternate" hreflang="ja" href="/cc-env/DebianSchroot.html" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.min.js"></script>
    <script src="/assets/js/respond.min.js"></script>
<![endif]-->
<link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="/css/cc-env.css" >
  </head>
  <body>
    <span id="page-top"></span>
    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">Youhei SASAKI's official site</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
        
        <li><a class="page-link" href="/research/index.html">Research</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Software<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/software/index.html">Repository</a></li>
            <li><a href="/cc-env/index.html">Computer Memo</a></li>
          </ul>
        </li>
        <li><a class="page-link" href="https://uwabami.junkhub.org/log">Blog</a></li>
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
        
          
        
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

    <div class="container">
      <div class="content">
        <div class="row">
          <div class="page-header col-xs-12">
            
            <h1>schroot&amp;#58;お手軽コンテナ(?)</h1>
            
            <ul class="breadcrumb">
  
  <li><a href="/index.html">Top</a></li>
  
  
    
    
      
  <li><a href="/cc-env/index.html">Cc-env</a></li>
      
    
  
    
    
  
</ul>

          </div>
          <div class="col-xs-12">
            <div id="toc-wrapper">
<nav id="table-of-contents">
<h2>&#30446;&#27425;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3881d60">始めに.</a></li>
<li><a href="#org8c95507">パッケージの導入</a></li>
<li><a href="#org55d4711">chroot 環境作成</a></li>
<li><a href="#orge99c8b9">schroot の設定</a></li>
<li><a href="#org453d282">chroot 環境の log 管理</a></li>
<li><a href="#org7ec9bc6">chroot 環境のデーモンの起動</a></li>
<li><a href="#orgce57679">参考文献</a></li>
</ul>
</div>
</nav>
</div>
<a href="#toc-toggle" class="btn toc-btn" id="toc-toggle">&#30446;&#27425;</a>
<p>
Related <a href='index.html'>Index</a>
</p>

<div id="outline-container-org3881d60" class="outline-2">
<h2 id="org3881d60">始めに.</h2>
<div class="outline-text-2" id="text-org3881d60">
<p>
前は 「sid の中で lenny を飼う」でしたけど.
まあ, やっている事は同じです.
</p>

<p>
chrootはカーネル、ハードウェア、ネットワーク、ポート、メモリ、
プロセス等々を共有しつつ,
ルートディレクトリ(/)を切り替えることでシステムを分離する技術です.
作成しているパッケージの後方互換の為に, 親環境は sid だけど
chroot の中で stable 環境を作成します.
</p>

<p>
親環境は amd64 の sid で, chroot で持つのは
</p>
<ul class="org-ul">
<li>/src/chroot/stable-amd64</li>
<li>/src/chroot/stable-i386</li>
</ul>
<p>
とします.
</p>
</div>
</div>
<div id="outline-container-org8c95507" class="outline-2">
<h2 id="org8c95507">パッケージの導入</h2>
<div class="outline-text-2" id="text-org8c95507">
<p>
<code>debootstrap</code> と <code>schroot</code> を導入しておきます.
</p>
<pre class="example">
% suro aptitude install debootstrap schroot
</pre>
</div>
</div>
<div id="outline-container-org55d4711" class="outline-2">
<h2 id="org55d4711">chroot 環境作成</h2>
<div class="outline-text-2" id="text-org55d4711">
<p>
以下は stable-amd64 を作成する場合のお話.
</p>

<p>
先ず <code>debootstrap</code> で <code>/src/chroot/stable-amd64</code> に必要なパッケージを導入しておきます.
</p>
<pre class="example">
% sudo mkdir -p /src/chroot/stable-amd64
% sudo debootstrap --variant=minbase \
                   --arch=amd64 \
                   jessie
                   /srv/chroot/jessie-amd64 http://ftp.jp.debian.org/debian
...
I: Base system installed successfully.
</pre>
<p>
で終了.
</p>

<p>
<code>minbase</code> で作成すると locale が設定されてなかったりするので,
schroot でログイン後に適宜設定すると良いだろう.
</p>
</div>
</div>

<div id="outline-container-orge99c8b9" class="outline-2">
<h2 id="orge99c8b9">schroot の設定</h2>
<div class="outline-text-2" id="text-orge99c8b9">
<p>
schroot では, 個々の環境毎に「profile」を指定することで, 柔軟な環境設定が可能となっている.
例えば, 何も指定しない場合には <code>/etc/schroot/default</code> 以下のファイルが設定に使用され,
</p>
<ul class="org-ul">
<li><code>/etc/schroot/default/copyfiles</code>: <code>/etc/resolv.conf</code> のコピー</li>
<li><code>/etc/schroot/default/fstab</code>: <code>$HOME</code> 等の bind mount</li>
<li><code>/etc/schroot/default/nssdatabases</code>: 認証に使用するファイル等のコピー</li>
</ul>
<p>
が行なわれる(以前は <code>/etc/shadow</code> をコピーして, なんてやっていたが, 今は不要).
</p>

<p>
作成した <code>/src/chroot/stable-amd64</code> の設定を <code>/etc/schroot/schroot.conf</code> に,
例えば以下の様に書いておく:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #FFFF7F;">stable-amd64</span>]
<span style="color: #7F7FFF;">description</span>=Debian stable amd64
<span style="color: #7F7FFF;">directory</span>=/src/chroot/stable-amd64
<span style="color: #7F7FFF;">users</span>=[&#12371;&#12398; schroot &#29872;&#22659;&#12434;&#21033;&#29992;&#12391;&#12365;&#12427;&#12518;&#12540;&#12470;&#12398;&#21517;&#21069;]
<span style="color: #7F7FFF;">root-groups</span>=[root &#12392;&#12375;&#12390;&#12525;&#12464;&#12452;&#12531;&#12391;&#12365;&#12427;&#35242;&#29872;&#22659;&#12398;&#12464;&#12523;&#12540;&#12503;&#12398;&#25351;&#23450;]
<span style="color: #7F7FFF;">aliases</span>=stable,default
<span style="color: #7F7FFF;">type</span>=directory
<span style="color: #7F7FFF;">profile</span>=desktop
</pre>
</div>
<p>
この場合,
</p>
<ul class="org-ul">
<li>chroot 環境として実 directory を利用</li>
<li>profile として <code>/etc/schroot/desktop</code> 以下のファイルを利用</li>
</ul>
<p>
となる.
</p>

<p>
以上が終わったら,
</p>
<pre class="example">
% schroot -c default             [chroot 環境へ login]
...
% schroot -c default -p          [環境変数を引き継いで login]
...
% schroot -c default -p icedove     [直接 chroot 環境下の プログラムを起動]
...
% schroot -c default -u root     [root として login]
</pre>
<p>
なんて事ができるようになる.
</p>

<p>
<code>type</code> には lvm-snapshot や aufs も指定できるので, その気になれば割と便利に使える筈(試していないけれど).
</p>
</div>
</div>
<div id="outline-container-org453d282" class="outline-2">
<h2 id="org453d282">chroot 環境の log 管理</h2>
<div class="outline-text-2" id="text-org453d282">
<p>
親環境が rsyslogd ならば, <i>etc/rsyslog.d</i> あたりに
</p>
<div class="org-src-container">
<pre class="src src-conf">$AddUnixListenSocket /var/chroot/stable-amd64/dev/log
</pre>
</div>
<p>
と書いておくと chroot 環境の /dev/log も見に行ってくれる.
</p>
</div>
</div>
<div id="outline-container-org7ec9bc6" class="outline-2">
<h2 id="org7ec9bc6">chroot 環境のデーモンの起動</h2>
<div class="outline-text-2" id="text-org7ec9bc6">
<p>
以前のメモ.
</p>

<p>
武藤さんが載せていたスクリプトをそのまま仕込むことにする.
とりあえずは syslog-ng と cron だけ.
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a5a5a6;">#</span><span style="color: #a5a5a6;">!/bin/</span><span style="color: #FF7F7F;">sh</span>
<span style="color: #BF7FFF;">revw</span>(){
  <span style="color: #7FBFFF;">set</span> -- <span style="color: #7FFF7F;">"$@"</span>
  <span style="color: #7F7FFF;">r</span>=<span style="color: #7FFF7F;">""</span>
  <span style="color: #FF7F7F;">while</span> [ $<span style="color: #7F7FFF;">#</span> -gt 0 ]; <span style="color: #FF7F7F;">do</span>
    <span style="color: #7F7FFF;">w</span>=$<span style="color: #7F7FFF;">1</span>; <span style="color: #7FBFFF;">shift</span>
    <span style="color: #7F7FFF;">r</span>=<span style="color: #7FFF7F;">"$w $r"</span>
  <span style="color: #FF7F7F;">done</span>
  <span style="color: #7FBFFF;">echo</span> <span style="color: #7FFF7F;">"$r"</span>
}
<span style="color: #7FBFFF;">echo</span> <span style="color: #7FFF7F;">"start services (chroot sid):"</span>
<span style="color: #7F7FFF;">services</span>=<span style="color: #7FFF7F;">"anacron cron"</span>
<span style="color: #FF7F7F;">if</span> [ <span style="color: #7FFF7F;">"$1"</span> = <span style="color: #7FFF7F;">"stop"</span> ]; <span style="color: #FF7F7F;">then</span>
  <span style="color: #7F7FFF;">services</span>=$(revw $<span style="color: #7F7FFF;">services</span>)
<span style="color: #FF7F7F;">fi</span>
<span style="color: #FF7F7F;">for</span> s<span style="color: #FF7F7F;"> in</span> $<span style="color: #7F7FFF;">services</span>; <span style="color: #FF7F7F;">do</span>
  schroot -q -c stable-amd64 /etc/init.d/$<span style="color: #7F7FFF;">s</span> $<span style="color: #7F7FFF;">1</span>
<span style="color: #FF7F7F;">done</span>
</pre>
</div>
<p>
systemd 環境下だと systemctl で起動するのが良いのかなぁ.
試していないけれど.
</p>
</div>
</div>
<div id="outline-container-orgce57679" class="outline-2">
<h2 id="orgce57679">参考文献</h2>
<div class="outline-text-2" id="text-orgce57679">
<ul class="org-ul">
<li><a href="http://kmuto.jp/d/index.cgi/debian/debootstrap.htm">Etch/Sidの上にSarge環境を作る方法</a></li>
<li><a href="https://wiki.debian.org/Schroot">Schroot - Debian Wiki</a></li>
</ul>
</div>
</div>

          </div>
          <a href="#page-top" class="pagetop btn top-btn">Top</a>
        </div> <!-- /.row -->
      </div> <!-- /.content -->
    </div> <!-- /.container -->
    <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-xs-12">
        <p>
          
          &copy; 2006 - 2017
          <a href="mailto:uwabami@gfd-dennou.org"></a>,
          Lastupdate: 2017-01-22 18:53:04 +0000
          <br />
          <span class="generator"> Powered by
            <a href="http://orgmode.org/" target="_blank" title="Org-mode">Org-mode</a>
            +
            <a href="http://jekyllrb.com/" target="_blank" title="Jekyll" >Jekyll</a>
            +
            <a href="http://nkmr6194.github.io/Umi/" target="_blank">Umi</a> &amp;
            <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>
          </span>
        </p>
      </div> <!-- /.col-sm-12 -->
    </div> <!-- /.row -->
  </div> <!-- /.container -->
</footer>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90872419-1', 'auto');
  ga('send', 'pageview');
</script>

    <script src="/assets/js/org-toc.js"></script>
  </body>
</html>
