<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>schroot:お手軽コンテナ(?)</title>
<meta name="description" content="My Interest: Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian">
<link rel="stylesheet" href="/css/main.css" >
<link rel="canonical" href="/cc-env/DebianSchroot.html">

<link rel="alternate" hreflang="ja" href="/cc-env/DebianSchroot.html" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.min.js"></script>
    <script src="/assets/js/respond.min.js"></script>
<![endif]-->
<link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="/css/cc-env.css" >
  </head>
  <body>
    <span id="page-top"></span>
    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">Youhei SASAKI's official site</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
        
        <li><a class="page-link" href="/research/index.html">Research</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Software<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/software/index.html">Repository</a></li>
            <li><a href="/cc-env/index.html">Computer Memo</a></li>
          </ul>
        </li>
        <li><a class="page-link" href="https://uwabami.junkhub.org/log">Blog</a></li>
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
        
          
        
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

    <div class="container">
      <div class="content">
        <div class="row">
          <div class="page-header col-xs-12">
            
            <h1>schroot:お手軽コンテナ(?)</h1>
            
            <ul class="breadcrumb">
  
  <li><a href="/index.html">Top</a></li>
  
  
    
    
      
  <li><a href="/cc-env/index.html">Cc-env</a></li>
      
    
  
    
    
  
</ul>

          </div>
          <div class="col-xs-12">
            <p>Related <a href="wiki:index">Index</a></p>
<h2><a id="始めに."><span class='anchor'>_</span></a>始めに.</h2>
<p>前は 「sid の中で lenny を飼う」でしたけど.
  まあ, やっている事は同じです.</p>
<p>chrootはカーネル、ハードウェア、ネットワーク、ポート、メモリ、
  プロセス等々を共有しつつ,
  ルートディレクトリ(/)を切り替えることでシステムを分離する技術です.
  作成しているパッケージの後方互換の為に, 親環境は sid だけど
  chroot の中で stable 環境を作成します.</p>
<p>親環境は amd64 の sid で, chroot で持つのは</p>
<ul>
  <li>/src/chroot/stable-amd64</li>
  <li>/src/chroot/stable-i386</li>
</ul>
<p>とします.</p>
<h2><a id="パッケージの導入"><span class='anchor'>_</span></a>パッケージの導入</h2>
<p><code>debootstrap</code> と <code>schroot</code> を導入しておきます.</p>
<pre class="example">
% suro aptitude install debootstrap schroot
</pre>
<h2><a id="chroot 環境作成"><span class='anchor'>_</span></a>chroot 環境作成</h2>
<p>以下は stable-amd64 を作成する場合のお話.</p>
<p>先ず <code>debootstrap</code> で <code>/src/chroot/stable-amd64</code> に必要なパッケージを導入しておきます.</p>
<pre class="example">
% sudo mkdir -p /src/chroot/stable-amd64
% sudo debootstrap --variant=minbase \
                   --arch=amd64 \
                   jessie
                   /srv/chroot/jessie-amd64 http://ftp.jp.debian.org/debian
...
I: Base system installed successfully.
</pre>
<p>で終了.</p>
<p><code>minbase</code> で作成すると locale が設定されてなかったりするので,
  schroot でログイン後に適宜設定すると良いだろう.</p>
<h2><a id="schroot の設定"><span class='anchor'>_</span></a>schroot の設定</h2>
<p>schroot では, 個々の環境毎に「profile」を指定することで, 柔軟な環境設定が可能となっている.
  例えば, 何も指定しない場合には <code>/etc/schroot/default</code> 以下のファイルが設定に使用され,</p>
<ul>
  <li><code>/etc/schroot/default/copyfiles</code>: <code>/etc/resolv.conf</code> のコピー</li>
  <li><code>/etc/schroot/default/fstab</code>: <code>$HOME</code> 等の bind mount</li>
  <li><code>/etc/schroot/default/nssdatabases</code>: 認証に使用するファイル等のコピー</li>
</ul>
<p>が行なわれる(以前は <code>/etc/shadow</code> をコピーして, なんてやっていたが, 今は不要).</p>
<p>作成した <code>/src/chroot/stable-amd64</code> の設定を <code>/etc/schroot/schroot.conf</code> に,
  例えば以下の様に書いておく:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">stable</span><span class="o">-</span><span class="n">amd64</span><span class="o">]</span>
<span class="n">description</span><span class="o">=</span><span class="no">Debian</span> <span class="n">stable</span> <span class="n">amd64</span>
<span class="n">directory</span><span class="o">=</span><span class="sr">/src/</span><span class="n">chroot</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">amd64</span>
<span class="n">users</span><span class="o">=[</span><span class="err">この</span> <span class="n">schroot</span> <span class="err">環境を利用できるユーザの名前</span><span class="o">]</span>
<span class="n">root</span><span class="o">-</span><span class="n">groups</span><span class="o">=[</span><span class="n">root</span> <span class="err">としてログインできる親環境のグループの指定</span><span class="o">]</span>
<span class="n">aliases</span><span class="o">=</span><span class="n">stable</span><span class="p">,</span><span class="n">default</span>
<span class="n">type</span><span class="o">=</span><span class="n">directory</span>
<span class="n">profile</span><span class="o">=</span><span class="n">desktop</span>
</pre></div>
<p>この場合,</p>
<ul>
  <li>chroot 環境として実 directory を利用</li>
  <li>profile として <code>/etc/schroot/desktop</code> 以下のファイルを利用</li>
</ul>
<p>となる.</p>
<p>以上が終わったら,</p>
<pre class="example">
% schroot -c default             [chroot 環境へ login]
...
% schroot -c default -p          [環境変数を引き継いで login]
...
% schroot -c default -p icedove     [直接 chroot 環境下の プログラムを起動]
...
% schroot -c default -u root     [root として login]
</pre>
<p>なんて事ができるようになる.</p>
<p><code>type</code> には lvm-snapshot や aufs も指定できるので, その気になれば割と便利に使える筈(試していないけれど).</p>
<h2><a id="chroot 環境の log 管理"><span class='anchor'>_</span></a>chroot 環境の log 管理</h2>
<p>親環境が rsyslogd ならば, <em>etc/rsyslog.d</em> あたりに</p>
<div class="highlight"><pre><span></span><span class="vg">$AddUnixListenSocket</span> <span class="sr">/var/</span><span class="n">chroot</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">amd64</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">log</span>
</pre></div>
<p>と書いておくと chroot 環境の /dev/log も見に行ってくれる.</p>
<h2><a id="chroot 環境のデーモンの起動"><span class='anchor'>_</span></a>chroot 環境のデーモンの起動</h2>
<p>以前のメモ.</p>
<p>武藤さんが載せていたスクリプトをそのまま仕込むことにする.
  とりあえずは syslog-ng と cron だけ.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
revw<span class="o">()&#123;</span>
  <span class="nb">set</span> -- <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
  <span class="nv">r</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
  <span class="k">while</span> <span class="o">[</span> <span class="nv">$#</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">w</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span> <span class="nb">shift</span>
    <span class="nv">r</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$w</span><span class="s2"> </span><span class="nv">$r</span><span class="s2">&quot;</span>
  <span class="k">done</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$r</span><span class="s2">&quot;</span>
<span class="o">}</span>
<span class="nb">echo</span> <span class="s2">&quot;start services (chroot sid):&quot;</span>
<span class="nv">services</span><span class="o">=</span><span class="s2">&quot;anacron cron&quot;</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">services</span><span class="o">=</span><span class="k">$(</span>revw <span class="nv">$services</span><span class="k">)</span>
<span class="k">fi</span>
<span class="k">for</span> s in <span class="nv">$services</span><span class="p">;</span> <span class="k">do</span>
  schroot -q -c stable-amd64 /etc/init.d/<span class="nv">$s</span> <span class="nv">$1</span>
<span class="k">done</span>
</pre></div>
<p>systemd 環境下だと systemctl で起動するのが良いのかなぁ.
  試していないけれど.</p>
<h2><a id="参考文献"><span class='anchor'>_</span></a>参考文献</h2>
<ul>
  <li><a href="http://kmuto.jp/d/index.cgi/debian/debootstrap.htm">Etch/Sidの上にSarge環境を作る方法</a></li>
  <li><a href="https://wiki.debian.org/Schroot">Schroot - Debian Wiki</a></li>
</ul>


          </div>
          <a href="#page-top" class="pagetop btn top-btn">Top</a>
        </div> <!-- /.row -->
      </div> <!-- /.content -->
    </div> <!-- /.container -->
    <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-xs-12">
        <p>
          
          &copy; 2006 - 2018
          <a href="mailto:uwabami@gfd-dennou.org"></a>,
          Lastupdate: 2018-10-16 19:46:39
          <br />
          <span class="generator"> Powered by
            <a href="http://orgmode.org/" target="_blank" title="Org-mode">Org-mode</a>
            +
            <a href="http://jekyllrb.com/" target="_blank" title="Jekyll" >Jekyll</a>
            +
            <a href="http://nkmr6194.github.io/Umi/" target="_blank">Umi</a> &amp;
            <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>
          </span>
        </p>
      </div> <!-- /.col-sm-12 -->
    </div> <!-- /.row -->
  </div> <!-- /.container -->
</footer>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90872419-1', 'auto');
  ga('send', 'pageview');
</script>

    <script src="/assets/js/org-toc.js"></script>
  </body>
</html>
