<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mail 環境の設定</title>
<meta name="description" content="My Interest: Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian">
<link rel="stylesheet" href="/css/main.css" >
<link rel="canonical" href="/cc-env/DebianMail.html">

<link rel="alternate" hreflang="ja" href="/cc-env/DebianMail.html" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.min.js"></script>
    <script src="/assets/js/respond.min.js"></script>
<![endif]-->
<link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="/css/cc-env.css" >
  </head>
  <body>
    <span id="page-top"></span>
    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">Youhei SASAKI's official site</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
        
        <li><a class="page-link" href="/research/index.html">Research</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Software<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/software/index.html">Repository</a></li>
            <li><a href="/cc-env/index.html">Computer Memo</a></li>
          </ul>
        </li>
        <li><a class="page-link" href="https://uwabami.junkhub.org/log">Blog</a></li>
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
        
          
        
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

    <div class="container">
      <div class="content">
        <div class="row">
          <div class="page-header col-xs-12">
            
            <h1>Mail 環境の設定</h1>
            
            <ul class="breadcrumb">
  
  <li><a href="/index.html">Top</a></li>
  
  
    
    
      
  <li><a href="/cc-env/index.html">Cc-env</a></li>
      
    
  
    
    
  
</ul>

          </div>
          <div class="col-xs-12">
            <p>Related: <a href="wiki:index">Index</a> <a href="id:591f6b0d-55ff-48eb-b095-401cdfa0d536">Debian</a></p>
<h2><a id="始めに"><span class='anchor'>_</span></a>始めに</h2>
<p>メールに関するアレコレ.
  ネットワーク接続を意識したくないので,
  送受信用のサーバを手元に置いて MUA はなるべくここを叩くようにしている.</p>
<h2><a id="送信設定: Exim4"><span class='anchor'>_</span></a>送信設定: Exim4</h2>
<p>smarthost での送信だけなら Exim4 が軽量で楽。
  他にも幾つか選択肢はある。気になるなら <a href="https://wiki.debian.org/Debate/DefaultMTA">Debian Wiki: DefaultMTA</a> あたり参照のこと。
  欲しい機能は</p>
<ul>
  <li>上流の MTA への smarthost 送信。</li>
  <li>offline 時の queue</li>
  <li>localhost:25 での待受</li>
</ul>
<p>なので、軽いしとりあえず Exim4 をそのまま使っている。</p>
<pre class="example">
$ sudo -s
# dpkg-reconfigure -plow exim4-config
  メール設定の一般的なタイプ: 2. スマートホストでメール送信; SMTP または fetchmail で受信する
  システムメール名: localhost
  入力側 SMTP 接続をリスンする IP アドレス: 127.0.0.1
  メールを受け取るその他の宛先: [空白]
  メールをリレーするマシン: [空白]
  送出スマートホストの IP アドレスまたはホスト名: スマートホスト用の送信サーバ::587
  送出するメールでローカルメール名を隠しますか? no
  DNS クエリの数を最小限に留めますか (ダイヤルオンデマンド)? no
  ローカルメールの配送方式: 1. /var/mail/ 内の mbox 形式
  設定を小さなファイルに分割しますか?: no
  root と postmaster のメール受信者: 適当に設定
</pre>
<p>そのあと, <code>/etc/exim4/passwd.client</code> 内で, スマートホストの設定</p>
<div class="highlight"><pre><span></span><span class="err">スマートホスト送信サーバ</span><span class="p">:</span><span class="o">[</span><span class="err">アカウント</span><span class="o">]</span><span class="p">:</span><span class="o">[</span><span class="err">パスワード</span><span class="o">]</span>
</pre></div>
<p>そして必要なら <code>/etc/exim4/email-addresses</code> に置換するリストを適当に記述.
  最低限 root と ユーザ宛(uid=1000) のメール送信先は設定しておく.</p>
<pre class="example">
$ sudo -s
# upate-exim4.conf
# sudo /etc/init.d/exim4 restart
</pre>
<p>あとは適当にテストとかしてみると良い.</p>
<p>(2012/07/30) このままだと message-id が &#8220;乱数列@hostname&#8221; になるので
  <code>/etc/exim4/exim4.conf.template</code> あたりに</p>
<div class="highlight"><pre><span></span><span class="n">message_id_header_domain</span> <span class="o">=</span> <span class="err">ドメイン名</span>
<span class="n">message_id_header_text</span>   <span class="o">=</span> <span class="err">ホスト名</span>
</pre></div>
<p>を追加して <code>update-exim4.conf</code> を走らせておくと良い。</p>
<p>ローカル配送先を適宜設定したい場合には</p>
<div class="highlight"><pre><span></span><span class="no">MAILDIR_HOME_MAILDIR_LOCATION</span> <span class="o">=</span> <span class="vg">$home</span><span class="o">/</span><span class="no">Maildir</span><span class="o">/</span><span class="no">INBOX</span>
</pre></div>
<h2><a id="送信設定: msmtp"><span class='anchor'>_</span></a>送信設定: msmtp</h2>
<p><a href="id:544e8091-614a-4784-a889-78651a923d6c">Wanderlust</a> からメールを送る時には,
  <code>msmtp</code> を使っている.</p>
<p>sendmail コマンド互換かつ enverope-from に応じて送信に利用する
  SMTP サーバを切り替えられる, というのが良い.
  本当は Gmail に SMTP サーバを登録しておいて, exim4 の smarthost で
  Gmail に丸投げしたかったのだけれど,
  Gmail のメールサーバは <code>Reply-To</code> を上書きしたりして行儀が良くない.</p>
<p>msmtp 自体の設定はいたって普通だが, queue が面倒?
  結局 Emacs からは <code>sendmail</code> として</p>
<p>を叩くことで, ネットワーク接続がある場合には即座に送信,
  無い場合には queuing, という風に動作を切り替えている.</p>
<p>あとは NetworkManager の dispatcher として msmtp-runqueue を走らせれば良い.</p>
<h2><a id="受信"><span class='anchor'>_</span></a>受信</h2>
<p>受信/閲覧は</p>
<ul>
  <li><a href="http://isync.sourceforge.net/">isync</a> で、リモートの IMAP サーバのメールをローカルに Maildir 形式で保存</li>
  <li>ローカルで dovecot-imapd を起動してメールを閲覧</li>
</ul>
<p>としている.</p>
<p>最近の MUA は多かれ少なかれ IMAP 接続でも手元にメールを持ってくるので,
  このメールの重複をなんとかしたいのだけれども,
  例えば Wanderlust なんかで Maildir を直接見にいくと Emacs の反応があまり芳しくない.</p>
<p>以前 <a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0247">第247回 Offlineimap＋Dovecotによる快適メール環境：Ubuntu Weekly Recipe</a> なんて記事を書いた。
  その時は offlineimap を使っていたのだけれども</p>
<ul>
  <li>遅い。特に 2014 年あたりから Gmail の同期が体感できるレベルで遅くなった</li>
  <li>偶に block するし、imap の接続数が酷い事になる。</li>
</ul>
<p>ということで、2015 年から <a href="http://isync.sourceforge.net/">isync: free IMAP and MailDir mailbox synchronizer</a> に移行した。</p>
<h3><a id="mbsync/isync"><span class='anchor'>_</span></a>mbsync/isync</h3>
<p>isync/mbsync はリモートの IMAP サーバとローカルの Maildir を同期するソフトウェア。</p>
<h4><a id="インストール"><span class='anchor'>_</span></a>インストール</h4>
<p>実行バイナリは <code>isync</code> もしくは <code>mbsync</code> 。以前の名前が <code>isync</code> なので、Debian のパッケージ名はそのままである。</p>
<pre class="example">
$ sudo apt-get install isync
</pre>
<p>apt 万歳</p>
<h4><a id="設定"><span class='anchor'>_</span></a>設定</h4>
<p>設定ファイルは <code>~/.mbsyncrc</code>.
  設定例は以下:</p>
<ul>
  <li><code>~/Maildir/</code> 以下にサーバのメールを同期する</li>
  <li><code>~/Maildir/INBOX.mobile.XXX</code> に imap.mobile.com のメールを同期.
    <ul>
      <li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
    </ul>
  </li>
  <li><code>~/Maildir/INBOX.Gmail.XXX</code> に Gmail のメールを同期
    <ul>
      <li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
      <li><code>[Gmail]/</code> というラベルを上手く扱えないので、同期チャンネルを複数設定することで対応
        <ul>
          <li>今のところ SPAM 堕ちしたメールの確認のためだけに <code>~/Maildir/INBOX.Gmail.Junk</code> のみ確認している</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><code>~/Maildir/INBOX</code> に <code>work.example.com</code> のメールを同期
    <ul>
      <li><code>work.example.com</code> メールサーバのディレクトリが <code>work/2014</code> 等と &#8220;/&#8221; 区切りになっているので <code>Flatten: .</code> で
        <code>INBOX.work.2014</code> 等に変換する。そのために <code>MaildirStore</code> を複数設定している</li>
      <li><code>Pattern: * !*mobile* !*Gmail*</code> で同期から除外する <code>Maildir</code> を指定する</li>
    </ul>
  </li>
  <li>PassCmd で gpg 暗号化した netrc 形式のファイルからパスワードを取得している.
    <ul>
      <li>これ、User なんかにも使えないかなぁ、とか思ったり</li>
    </ul>
  </li>
</ul>
<p>今のところ特に使用に際して困った事はおきていない。</p>
<div class="highlight"><pre><span></span><span class="no">IMAPAccount</span> <span class="n">mobile</span>
<span class="no">Host</span> <span class="n">mobile</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="no">User</span> <span class="no">TheMobileUserAccount</span>
<span class="no">PassCmd</span> <span class="s2">&quot;echo $&#123;PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n &#39;s,^machine mobile.example.com .*password </span><span class="se">\\</span><span class="s2">\([^ ]*</span><span class="se">\\</span><span class="s2">) port.*,</span><span class="se">\\</span><span class="s2">1,p&#39;)}&quot;</span>
<span class="no">Port</span> <span class="mi">993</span>
<span class="no">UseIMAPS</span> <span class="n">yes</span>
<span class="no">RequireSSL</span> <span class="n">yes</span>
<span class="no">UseTLSv1</span><span class="o">.</span><span class="mi">2</span> <span class="n">yes</span>
<span class="no">CertificateFile</span> <span class="sr">/etc/ss</span><span class="n">l</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">crt</span>

<span class="no">IMAPAccount</span> <span class="n">work</span>
<span class="no">Host</span> <span class="n">work</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="no">User</span> <span class="no">TheWorkUserAccount</span>
<span class="no">PassCmd</span> <span class="s2">&quot;echo $&#123;PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n &#39;s,^machine work.example.com .*password </span><span class="se">\\</span><span class="s2">\([^ ]*</span><span class="se">\\</span><span class="s2">) port.*,</span><span class="se">\\</span><span class="s2">1,p&#39;)}&quot;</span>
<span class="no">Port</span> <span class="mi">993</span>
<span class="no">UseIMAPS</span> <span class="n">yes</span>
<span class="no">RequireSSL</span> <span class="n">yes</span>
<span class="no">UseTLSv1</span><span class="o">.</span><span class="mi">2</span> <span class="n">yes</span>
<span class="no">CertificateFile</span> <span class="sr">/etc/ss</span><span class="n">l</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">crt</span>

<span class="no">IMAPAccount</span> <span class="n">gmail</span>
<span class="no">Host</span> <span class="n">imap</span><span class="o">.</span><span class="n">gmail</span><span class="o">.</span><span class="n">com</span>
<span class="no">User</span> <span class="no">GmailMailAddress</span>
<span class="no">PassCmd</span> <span class="s2">&quot;echo $&#123;PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n &#39;s,^machine imap.gmail.com .*password </span><span class="se">\\</span><span class="s2">\([^ ]*</span><span class="se">\\</span><span class="s2">) port.*,</span><span class="se">\\</span><span class="s2">1,p&#39;)}&quot;</span>
<span class="no">Port</span> <span class="mi">993</span>
<span class="no">UseIMAPS</span> <span class="n">yes</span>
<span class="no">RequireSSL</span> <span class="n">yes</span>
<span class="no">UseTLSv1</span><span class="o">.</span><span class="mi">2</span> <span class="n">yes</span>
<span class="no">CertificateFile</span> <span class="sr">/etc/ss</span><span class="n">l</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">crt</span>

<span class="no">IMAPStore</span> <span class="n">work</span><span class="o">-</span><span class="n">remote</span>
<span class="no">Account</span> <span class="n">work</span>
<span class="no">UseNamespace</span> <span class="n">no</span>

<span class="no">IMAPStore</span> <span class="n">work</span><span class="o">-</span><span class="n">remote</span>
<span class="no">Account</span> <span class="n">work</span>

<span class="no">IMAPStore</span> <span class="n">gmail</span><span class="o">-</span><span class="n">remote</span>
<span class="no">Account</span> <span class="n">gmail</span>
<span class="no">UseNamespace</span> <span class="n">yes</span>

<span class="no">MaildirStore</span> <span class="n">local</span>
<span class="no">Path</span> <span class="o">~</span><span class="sr">/Maildir/</span>
<span class="no">Inbox</span> <span class="o">~</span><span class="sr">/Maildir/</span><span class="no">INBOX</span>

<span class="no">MaildirStore</span> <span class="n">work</span><span class="o">-</span><span class="n">local</span>
<span class="no">Path</span> <span class="o">~</span><span class="sr">/Maildir/</span>
<span class="no">Inbox</span> <span class="o">~</span><span class="sr">/Maildir/</span><span class="no">INBOX</span>
<span class="no">Flatten</span> <span class="o">.</span>

<span class="no">Channel</span> <span class="n">mobile</span>
<span class="no">Master</span> <span class="ss">:mobile</span><span class="o">-</span><span class="ss">remote</span><span class="p">:</span>
<span class="no">Slave</span> <span class="ss">:local:INBOX</span><span class="o">.</span><span class="n">mobile</span><span class="o">.</span>
<span class="no">Patterns</span> <span class="no">INBOX</span> <span class="no">Junk</span> <span class="no">Archives</span> <span class="no">Sent</span> <span class="no">Drafts</span> <span class="no">Trash</span>
<span class="no">Create</span> <span class="no">Both</span>
<span class="no">Expunge</span> <span class="no">Both</span>
<span class="no">Sync</span> <span class="n">all</span>
<span class="no">SyncState</span> <span class="o">*</span>

<span class="no">Channel</span> <span class="n">gmail</span>
<span class="no">Master</span> <span class="ss">:gmail</span><span class="o">-</span><span class="ss">remote</span><span class="p">:</span>
<span class="no">Slave</span> <span class="ss">:local:INBOX</span><span class="o">.</span><span class="n">Gmail</span><span class="o">.</span>
<span class="no">Patterns</span> <span class="no">INBOX</span>
<span class="no">Create</span> <span class="no">Both</span>
<span class="no">Expunge</span> <span class="no">Both</span>
<span class="no">Sync</span> <span class="n">all</span>
<span class="no">SyncState</span> <span class="o">*</span>

<span class="no">Channel</span> <span class="n">gmail</span><span class="o">-</span><span class="n">junk</span>
<span class="no">Master</span> <span class="s2">&quot;:gmail-remote:[Gmail]/&amp;j,dg0TDhMPww6w-&quot;</span>
<span class="no">Slave</span> <span class="ss">:local:INBOX</span><span class="o">.</span><span class="n">Gmail</span><span class="o">.</span><span class="n">Junk</span>
<span class="no">Patterns</span> <span class="o">*</span>
<span class="no">Create</span> <span class="no">Both</span>
<span class="no">Expunge</span> <span class="no">Both</span>
<span class="no">Sync</span> <span class="n">all</span>
<span class="no">SyncState</span> <span class="o">*</span>

<span class="no">Channel</span> <span class="n">work</span>
<span class="no">Master</span> <span class="ss">:work</span><span class="o">-</span><span class="ss">remote</span><span class="p">:</span>
<span class="no">Slave</span> <span class="ss">:work</span><span class="o">-</span><span class="ss">local</span><span class="p">:</span>
<span class="no">Patterns</span> <span class="o">*</span> <span class="o">!*</span><span class="n">mobile</span><span class="o">*</span> <span class="o">!*</span><span class="no">Gmail</span><span class="o">*</span>
<span class="no">Create</span> <span class="no">Both</span>
<span class="no">Expunge</span> <span class="no">Both</span>
<span class="no">Sync</span> <span class="n">all</span>
<span class="no">SyncState</span> <span class="o">*</span>
</pre></div>
<p>上手く設定できているなら</p>
<pre class="example">
mbsync -l mobile
</pre>
<p>などとして、同期する <code>Maildir</code> を確認すると良い。
  リモートとローカルでどういうマッピングがされているかわかるだろう。
  25万通(6.5G)の同期にだいたい 3 時間ぐらい。
  回線速度に依存するだろうけれど、offlineimap より目に見えて速い(気がする)。
  また、IMAP Pipeline で処理されているので、サーバ上の IMAP connection の数は 1 つのみだった。</p>
<h4><a id="cron での動作"><span class='anchor'>_</span></a>cron での動作</h4>
<p>認証に GPG を使っており、認証に Gnome Keyring を用いているので
  必要な環境変数を読み込んでから実行するようにする.
  先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
sleep <span class="m">5</span>
<span class="c1"># Export the dbus session address on startup so it can be used by cron</span>
touch <span class="nv">$HOME</span>/.Xdbus
chmod <span class="m">600</span> <span class="nv">$HOME</span>/.Xdbus
env <span class="p">|</span> grep DBUS_SESSION_BUS_ADDRESS &gt; <span class="nv">$HOME</span>/.Xdbus
env <span class="p">|</span> grep GPG_AGENT_INFO &gt;&gt; <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">&#39;export DBUS_SESSION_BUS_ADDRESS&#39;</span> &gt;&gt; <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">&#39;export GPG_AGENT_INFO&#39;</span> &gt;&gt; <span class="nv">$HOME</span>/.Xdbus
</pre></div>
<p><code>~/.config/autostart</code> 以下に適当な名前で</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="no">Desktop</span> <span class="no">Entry</span><span class="o">]</span>
<span class="no">Type</span><span class="o">=</span><span class="no">Application</span>
<span class="no">Exec</span><span class="o">=</span><span class="sr">/home/u</span><span class="n">wabami</span><span class="o">/.</span><span class="n">mua</span><span class="o">/</span><span class="n">export_x_info</span><span class="o">.</span><span class="n">sh</span>
<span class="no">Hidden</span><span class="o">=</span><span class="kp">false</span>
<span class="no">NoDisplay</span><span class="o">=</span><span class="kp">false</span>
<span class="n">X</span><span class="o">-</span><span class="no">GNOME</span><span class="o">-</span><span class="no">Autostart</span><span class="o">-</span><span class="n">enabled</span><span class="o">=</span><span class="kp">true</span>
<span class="no">Name</span><span class="o">=</span><span class="no">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
<span class="no">Comment</span><span class="o">=</span><span class="no">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
</pre></div>
<p>を用意しておく.</p>
<p>あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
  必要に応じて GnomeKeyring による認証が行なわれる.
  cron で実行されるスクリプトは, 例えば</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1"># -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c1">################################################################################</span>
<span class="c1"># for personal settings</span>
<span class="nv">PID</span><span class="o">=</span>~/Maildir/mbsync.pid
<span class="nv">CONF</span><span class="o">=</span>~/.mbsyncrc
<span class="c1"># for gnome-keyring:</span>
. <span class="si">$&#123;</span><span class="nv">HOME</span><span class="si">}</span>/.Xdbus
<span class="c1"># check network is avaliable</span>
nm-online -x  <span class="m">2</span>&gt;/dev/null <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="c1"># check another offlineimap</span>
timelimit -T <span class="m">300</span> -t <span class="m">300</span> mbsync -c <span class="nv">$CONF</span> -a <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
</pre></div>
<p>とか。mbsync 自体の timeout や PID  管理ができないので、 <code>timelinit</code> コマンドで処理をするようにしている。
  実際は、二回目以降の同期は(回線速度に依存するだろうけれど) 20 秒ぐらい。</p>
<h3><a id="dovecot"><span class='anchor'>_</span></a>dovecot</h3>
<h4><a id="インストール"><span class='anchor'>_</span></a>インストール</h4>
<p>最低限 IMAP での接続ができれば良いので</p>
<pre class="example">
% sudo apt-get install dovecot-imapd
</pre>
<p>apt 万歳</p>
<h4><a id="設定"><span class='anchor'>_</span></a>設定</h4>
<p>最低限の設定として、</p>
<ul>
  <li>localhost で起動. 認証は PAM に任せる(login パスワードと同じ)</li>
  <li>Maildir 形式で mbsync(もしくは offlineimap)で同期したMaildirを読む.</li>
  <li>IMAP もしくは IMAP over SSL のみ</li>
</ul>
<p>ための設定を行なう</p>
<p>以下、設定ファイル中のコメント行を除いた部分だけを記載しているので注意
  (コメント消すなんてとんでもない!)。</p>
<p>先ず待受サーバ。
  どの IP アドレスで待ち受けるかは <code>/etc/dovecot/dovecot.conf</code> にあるので</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">listen</span> <span class="o">=</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="o">...</span>
</pre></div>
<p>あたりを修正しておく。</p>
<p>認証は
  <code>/etc/dovecot/conf.d/10-auth.conf</code> 内で</p>
<div class="highlight"><pre><span></span><span class="n">disable_plain_text_auth</span> <span class="o">=</span> <span class="n">no</span>
<span class="n">auth_mechanisms</span> <span class="o">=</span> <span class="n">plain</span>
<span class="o">!</span><span class="kp">include</span> <span class="n">auth</span><span class="o">-</span><span class="nb">system</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">ext</span>
</pre></div>
<p>を有効に。include されている auth-system.conf.ext の中身は</p>
<div class="highlight"><pre><span></span><span class="n">passdb</span> <span class="p">&#123;</span>
  <span class="n">driver</span> <span class="o">=</span> <span class="n">pam</span>
<span class="p">}</span>
<span class="n">userdb</span> <span class="p">&#123;</span>
  <span class="n">driver</span> <span class="o">=</span> <span class="n">passwd</span>
<span class="p">}</span>
</pre></div>
<p>だけが有効。これで pam 経由でパスワードログインするようになる.</p>
<p>次に Maildir の設定。 <code>/etc/dovecot/conf.d/10-mail.conf</code> 内で</p>
<div class="highlight"><pre><span></span><span class="n">mail_location</span> <span class="o">=</span> <span class="ss">maildir</span><span class="p">:</span><span class="o">%</span><span class="n">h</span><span class="o">/</span><span class="ss">Maildir</span><span class="p">:</span><span class="no">INBOX</span><span class="o">=%</span><span class="n">h</span><span class="o">/</span><span class="no">Maildir</span><span class="o">/</span><span class="ss">INBOX</span><span class="p">:</span><span class="no">LAYOUT</span><span class="o">=</span><span class="n">fs</span>
<span class="n">namespace</span> <span class="n">inbox</span> <span class="p">&#123;</span>
  <span class="n">inbox</span> <span class="o">=</span> <span class="n">yes</span>
<span class="p">}</span>
</pre></div>
<p>あたりを修正しておく。</p>
<p>最後に IMAP over SSL の設定。 <code>/etc/dovecot/conf.d/10-ssl.conf</code> で証明書の設定をする:</p>
<div class="highlight"><pre><span></span><span class="n">ssl_cert</span> <span class="o">=</span> <span class="o">&lt;</span><span class="sr">/etc/ss</span><span class="n">l</span><span class="o">/</span><span class="kp">private</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">dovecot</span><span class="o">.</span><span class="n">pem</span>
<span class="n">ssl_key</span> <span class="o">=</span> <span class="o">&lt;</span><span class="sr">/etc/ss</span><span class="n">l</span><span class="o">/</span><span class="kp">private</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">dovecot</span><span class="o">.</span><span class="n">key</span>
<span class="n">ssl_protocols</span> <span class="o">=</span> <span class="o">!</span><span class="no">SSLv2</span> <span class="o">!</span><span class="no">SSLv3</span>
</pre></div>
<p>その後に <code>/etc/dovecot/conf.d/10-master.conf</code> 内の <code>imap-login</code> 部分を修正</p>
<div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">imap</span><span class="o">-</span><span class="n">login</span> <span class="p">&#123;</span>
  <span class="n">inet_listener</span> <span class="n">imap</span> <span class="p">&#123;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ssl</span> <span class="o">=</span> <span class="n">no</span>
  <span class="p">}</span>
  <span class="n">inet_listener</span> <span class="n">imaps</span> <span class="p">&#123;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">993</span>
    <span class="n">ssl</span> <span class="o">=</span> <span class="n">yes</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>これで再起動すると <code>/etc/ssl/private</code> に置いた SSL 証明書を使って <code>127.0.1.1:993</code> で IMAP サーバが起動する。Listen を 127.0.0.1 に絞るなら SSL でのアクセスは不要かもしれない。</p>
<h3><a id="以下, obsolete"><span class='anchor'>_</span></a>以下, obsolete</h3>
<p>検索は mu (maildir-utils) を使うようになったし,
  メールの同期には mbsync を使うようになったので, 以下は昔のお話.</p>
<h4><a id="検索: Solr"><span class='anchor'>_</span></a>検索: Solr</h4>
<p>Dovecot には FTS(Full Text Search) 用の plugin が幾つかある。
  ここでは Solr を試してみる</p>
<p>とりあえず jetty で solar を動かすことに:</p>
<pre class="example">
% sudo aptitude -R solr-jetty dovecot-solr
</pre>
<p>Jetty の起動設定は <code>/etc/default/jetty8</code> にあるので</p>
<div class="highlight"><pre><span></span><span class="no">NO_START</span><span class="o">=</span><span class="mi">0</span>
<span class="no">JETTY_HOST</span><span class="o">=</span><span class="n">localhost</span>
<span class="no">JETTY_PORT</span><span class="o">=</span><span class="mi">8089</span>
</pre></div>
<p>としておく。dovecot 用の scheme.xml は <code>dovecot-solr</code> をインストールすると <code>/usr/share/dovecot/solr-scheme.xml</code> にインストールされるので、これを <code>/etc/solr/conf/scheme.xml</code> にコピー</p>
<pre class="example">
% cd /etc/solr/conf
% sudo cp scheme.xml scheme.xml.bak
% sudo cp /usr/share/dovecot/solr-schemex.ml scheme.xml
</pre>
<p>その後で <code>/etc/dovecot/conf.d/10-imap.conf</code> 内の mail_plugins 行に</p>
<div class="highlight"><pre><span></span><span class="n">mail_plugins</span> <span class="o">=</span> <span class="n">fts</span> <span class="n">fts_solr</span>
</pre></div>
<p>を追加しておく。
  IMAP でしか使わないのであれば <code>20-imap.conf</code> に指定すれば良いのだが、この場合は <code>doveadm fts rescan -u USERNAME</code> ができない。
  最後に <code>/etc/dovecot/conf.d/90-plugin.conf</code> で</p>
<div class="highlight"><pre><span></span><span class="n">plugin</span> <span class="p">&#123;</span>
  <span class="n">fts_autoindex</span> <span class="o">=</span> <span class="n">yes</span>
  <span class="n">fts</span> <span class="o">=</span> <span class="n">solr</span>
  <span class="n">fts_solr</span> <span class="o">=</span> <span class="k">break</span><span class="o">-</span><span class="n">imap</span><span class="o">-</span><span class="n">search</span> <span class="n">url</span><span class="o">=</span><span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="ss">localhost</span><span class="p">:</span><span class="mi">8089</span><span class="o">/</span><span class="n">solr</span><span class="o">/</span>
<span class="p">}</span>
</pre></div>
<p>としておく。これで jetty8 および dovecot を再起動すると、検索が効く様になる&#8230;?</p>
<h4><a id="検索: Solr で日本語"><span class='anchor'>_</span></a>検索: Solr で日本語</h4>
<p><code>scheme.xml</code> の修正が必要。
  とりあえず</p>
<ul>
  <li><code>/etc/solr/conf/scheme.xml</code> より <code>text_cjk</code> および <code>text_ja</code> の部分を抜き出して, dovecot の提供していた <code>scheme.xml</code> に追加</li>
  <li><code>hdr,body,subject</code> を <code>text_cjk</code> で解析するように</li>
</ul>
<p>してみた.</p>
<p>diff は以下:</p>
<div class="highlight"><pre><span></span><span class="gd">--- solr-schema.xml 2015-05-10 20:52:33.375358006 +0900</span>
<span class="gi">+++ schema.xml  2015-05-10 20:37:37.358195292 +0900</span>
<span class="gu">@@ -13,6 +13,62 @@</span>
     &lt;fieldType name=&quot;long&quot; class=&quot;solr.TrieLongField&quot; /&gt;
     &lt;fieldType name=&quot;boolean&quot; class=&quot;solr.BoolField&quot; /&gt;

<span class="gi">+    &lt;!-- CJK bigram (see text_ja for a Japanese configuration using morphological analysis) --&gt;</span>
<span class="gi">+    &lt;fieldType name=&quot;text_cjk&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot;&gt;</span>
<span class="gi">+      &lt;analyzer&gt;</span>
<span class="gi">+        &lt;tokenizer class=&quot;solr.StandardTokenizerFactory&quot;/&gt;</span>
<span class="gi">+        &lt;!-- normalize width before bigram, as e.g. half-width dakuten combine  --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.CJKWidthFilterFactory&quot;/&gt;</span>
<span class="gi">+        &lt;!-- for any non-CJK --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.LowerCaseFilterFactory&quot;/&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.CJKBigramFilterFactory&quot;/&gt;</span>
<span class="gi">+      &lt;/analyzer&gt;</span>
<span class="gi">+    &lt;/fieldType&gt;</span>
<span class="gi">+    &lt;fieldType name=&quot;text_ja&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot; autoGeneratePhraseQueries=&quot;false&quot;&gt;</span>
<span class="gi">+      &lt;analyzer&gt;</span>
<span class="gi">+      &lt;!-- Kuromoji Japanese morphological analyzer/tokenizer (JapaneseTokenizer)</span>
<span class="gi">+</span>
<span class="gi">+           Kuromoji has a search mode (default) that does segmentation useful for search.  A heuristic</span>
<span class="gi">+           is used to segment compounds into its parts and the compound itself is kept as synonym.</span>
<span class="gi">+</span>
<span class="gi">+           Valid values for attribute mode are:</span>
<span class="gi">+              normal: regular segmentation</span>
<span class="gi">+              search: segmentation useful for search with synonyms compounds (default)</span>
<span class="gi">+            extended: same as search mode, but unigrams unknown words (experimental)</span>
<span class="gi">+</span>
<span class="gi">+           For some applications it might be good to use search mode for indexing and normal mode for</span>
<span class="gi">+           queries to reduce recall and prevent parts of compounds from being matched and highlighted.</span>
<span class="gi">+           Use &lt;analyzer type=&quot;index&quot;&gt; and &lt;analyzer type=&quot;query&quot;&gt; for this and mode normal in query.</span>
<span class="gi">+</span>
<span class="gi">+           Kuromoji also has a convenient user dictionary feature that allows overriding the statistical</span>
<span class="gi">+           model with your own entries for segmentation, part-of-speech tags and readings without a need</span>
<span class="gi">+           to specify weights.  Notice that user dictionaries have not been subject to extensive testing.</span>
<span class="gi">+</span>
<span class="gi">+           User dictionary attributes are:</span>
<span class="gi">+                     userDictionary: user dictionary filename</span>
<span class="gi">+             userDictionaryEncoding: user dictionary encoding (default is UTF-8)</span>
<span class="gi">+</span>
<span class="gi">+           See lang/userdict_ja.txt for a sample user dictionary file.</span>
<span class="gi">+</span>
<span class="gi">+           See http://wiki.apache.org/solr/JapaneseLanguageSupport for more on Japanese language support.</span>
<span class="gi">+        --&gt;</span>
<span class="gi">+        &lt;tokenizer class=&quot;solr.JapaneseTokenizerFactory&quot; mode=&quot;search&quot;/&gt;</span>
<span class="gi">+        &lt;!--&lt;tokenizer class=&quot;solr.JapaneseTokenizerFactory&quot; mode=&quot;search&quot; userDictionary=&quot;lang/userdict_ja.txt&quot;/&gt;--&gt;</span>
<span class="gi">+        &lt;!-- Reduces inflected verbs and adjectives to their base/dictionary forms (辞書形) --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.JapaneseBaseFormFilterFactory&quot;/&gt;</span>
<span class="gi">+        &lt;!-- Removes tokens with certain part-of-speech tags --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.JapanesePartOfSpeechStopFilterFactory&quot; tags=&quot;lang/stoptags_ja.txt&quot; enablePositionIncrements=&quot;true&quot;/&gt;</span>
<span class="gi">+        &lt;!-- Normalizes full-width romaji to half-width and half-width kana to full-width (Unicode NFKC subset) --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.CJKWidthFilterFactory&quot;/&gt;</span>
<span class="gi">+        &lt;!-- Removes common tokens typically not useful for search, but have a negative effect on ranking --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.StopFilterFactory&quot; ignoreCase=&quot;true&quot; words=&quot;lang/stopwords_ja.txt&quot; enablePositionIncrements=&quot;true&quot; /&gt;</span>
<span class="gi">+        &lt;!-- Normalizes common katakana spelling variations by removing any last long sound character (U+30FC) --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.JapaneseKatakanaStemFilterFactory&quot; minimumLength=&quot;4&quot;/&gt;</span>
<span class="gi">+        &lt;!-- Lower-cases romaji characters --&gt;</span>
<span class="gi">+        &lt;filter class=&quot;solr.LowerCaseFilterFactory&quot;/&gt;</span>
<span class="gi">+      &lt;/analyzer&gt;</span>
<span class="gi">+    &lt;/fieldType&gt;</span>
<span class="gi">+</span>
     &lt;fieldType name=&quot;text&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot;&gt;
       &lt;analyzer type=&quot;index&quot;&gt;
         &lt;tokenizer class=&quot;solr.StandardTokenizerFactory&quot;/&gt;
<span class="gu">@@ -43,14 +99,14 @@</span>
    &lt;field name=&quot;box&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; required=&quot;true&quot; /&gt;
    &lt;field name=&quot;user&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; required=&quot;true&quot; /&gt;

<span class="gd">-   &lt;field name=&quot;hdr&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;</span>
<span class="gd">-   &lt;field name=&quot;body&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;</span>
<span class="gi">+   &lt;field name=&quot;hdr&quot; type=&quot;text_cjk&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;</span>
<span class="gi">+   &lt;field name=&quot;body&quot; type=&quot;text_cjk&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;</span>

    &lt;field name=&quot;from&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;
    &lt;field name=&quot;to&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;
    &lt;field name=&quot;cc&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;
    &lt;field name=&quot;bcc&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;
<span class="gd">-   &lt;field name=&quot;subject&quot; type=&quot;text&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;</span>
<span class="gi">+   &lt;field name=&quot;subject&quot; type=&quot;text_cjk&quot; indexed=&quot;true&quot; stored=&quot;false&quot; /&gt;</span>

    &lt;!-- Used by Solr internally: --&gt;
    &lt;field name=&quot;_version_&quot; type=&quot;long&quot; indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
</pre></div>
<h4><a id="offlineimap"><span class='anchor'>_</span></a>offlineimap</h4>
<p>(2015/05/10) 以前使っていた時のメモ。もう使わないけれど、たまに検索でココを見に来ている人がいるみたいなので、残しておくことに。
  <a href="http://offlineimap.org/">OfflineIMAP</a> は,ネットワーク上にあるIMAPサーバと手元のMaildir/IMAPサーバの同期を取るためのソフトウェア.</p>
<h5><a id="インストール"><span class='anchor'>_</span></a>インストール</h5>
<p>apt万歳, ってことで.</p>
<pre class="example">
$ sudo apt-get install offlineimap
</pre>
<h5><a id="設定"><span class='anchor'>_</span></a>設定</h5>
<p>現状, 以下の通り:</p>
<ul>
  <li><a href="http://offlineimap.org/">OfflineIMAP</a> のメタ情報は <code>~/Mail/offlineimap</code> 以下に格納</li>
  <li>同期するサーバは二箇所:
    <ul>
      <li>Main サーバのメールは <code>~/Mail/imap</code> 以下に格納.
        <ul>
          <li>この際, IMAP Namespace である <code>INBOX.</code> を除外して <code>Maildir</code> を作成</li>
          <li><code>~/Mail/imap/[Gmail]</code> は同期しない</li>
        </ul>
      </li>
      <li>Gmail のメールは <code>~/Mail/imap/[Gmail]/</code> 以下に格納</li>
    </ul>
  </li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># -*- mode: conf; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c1"># offlineimaprc</span>
<span class="c1">#</span>
<span class="c1"># Copyright(C) 2011 Youhei SASAKI All rights reserved.</span>
<span class="c1"># $Lastupdate: 2014-07-26 18:25:07$</span>
<span class="c1">#</span>
<span class="c1"># Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;</span>
<span class="c1"># License: WTFPL</span>
<span class="c1">#</span>
<span class="c1"># Code:</span>
<span class="o">[</span><span class="n">general</span><span class="o">]</span>
<span class="c1"># メタデータの格納先</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="o">~</span><span class="sr">/Mail/o</span><span class="n">fflineimap</span>
<span class="c1"># 補助関数が定義されたファイルの置き場所</span>
<span class="n">pythonfile</span> <span class="o">=</span> <span class="o">~</span><span class="sr">/.mua/o</span><span class="n">fflineimap_utils</span><span class="o">.</span><span class="n">py</span>
<span class="c1"># 同期するサーバの設定</span>
<span class="n">accounts</span> <span class="o">=</span> <span class="no">Main</span><span class="p">,</span> <span class="no">Gmail</span>
<span class="c1"># 同期するアカウントの数</span>
<span class="n">maxsyncaccounts</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># UI の設定. cron で同期する場合には quiet の方が良い</span>
<span class="n">ui</span> <span class="o">=</span> <span class="n">basic</span>
<span class="n">socktimeout</span> <span class="o">=</span> <span class="mi">600</span>
<span class="c1"># 高速化(?)</span>
<span class="n">fsync</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Gmail 用の設定: ここで設定する名前は accounts に揃える</span>
<span class="o">[</span><span class="no">Account</span> <span class="no">Gmail</span><span class="o">]</span>
<span class="n">localrepository</span> <span class="o">=</span> <span class="no">LocalGmail</span>
<span class="n">remoterepository</span> <span class="o">=</span> <span class="no">RemoteGmail</span>
<span class="n">maxsize</span> <span class="o">=</span> <span class="mi">2000000000</span>
<span class="n">status_backend</span> <span class="o">=</span> <span class="n">sqlite</span>
<span class="c1"># quick = 1 だとフラグは同期されない</span>
<span class="c1"># &#39;[Gmail]/全てのメール&#39; を同期するなら quick = 1 の方が良い?</span>
<span class="n">quick</span> <span class="o">=</span> <span class="mi">0</span>

<span class="o">[</span><span class="no">Repository</span> <span class="no">LocalGmail</span><span class="o">]</span>
<span class="c1"># Gmail の手元の設定</span>
<span class="n">type</span> <span class="o">=</span> <span class="no">Maildir</span>
<span class="c1"># Maildir の格納場所</span>
<span class="n">localfolders</span> <span class="o">=</span> <span class="o">~</span><span class="sr">/Mail/im</span><span class="n">ap</span><span class="o">/[</span><span class="no">Gmail</span><span class="o">]</span>
<span class="n">restoreatime</span> <span class="o">=</span> <span class="n">no</span>
<span class="c1"># IMAP のセパレータの変換: Mailbox の &quot;.&quot; が &quot;/&quot; となり,</span>
<span class="c1"># ディレクトリが作成される</span>
<span class="n">sep</span> <span class="o">=</span> <span class="sr">/</span>

<span class="sr">[Repository RemoteGmail]</span>
<span class="sr"># Gmail との接続設定: type = IMAP でも良い?</span>
<span class="sr">type = Gmail</span>
<span class="sr"># remote&#123;pass,user}eval は offlineimap_utils.py で定義した関数</span>
<span class="sr">remoteusereval = get_username(&quot;imap.gmail.com&quot;)</span>
<span class="sr">remotepasseval = get_password(&quot;imap.gmail.com&quot;)</span>
<span class="sr">maxsize = 2000000000</span>
<span class="sr">realdelete = no</span>
<span class="sr"># 同時接続数. 並列実行可能なので適宜</span>
<span class="sr"># サーバに怒られない程度に</span>
<span class="sr">maxconnections = 5</span>
<span class="sr"># remote -&gt; local 時のフォルダ名変換(正規表現)</span>
<span class="sr">nametrans = lambda foldername: re.sub(&#39;^INBOX&#39;,&#39;&#39;, (re.sub(&#39;^\[Gmail\]/</span><span class="s1">&#39;,&#39;&#39;, foldername)))</span>
<span class="s1"># 同期するフォルダの設定: Gmail 側で IMAP で表示するラベル設定しておく, でも良いかも.</span>
<span class="s1">folderfilter = lambda foldername: foldername in [</span>
<span class="s1">             &#39;</span><span class="no">INBOX</span><span class="s1">&#39;,                   # -&gt; &#39;</span><span class="o">~</span><span class="sr">/Mail/im</span><span class="n">ap</span><span class="o">/[</span><span class="no">Gmail</span><span class="o">]</span><span class="s1">&#39; になる</span>
<span class="s1">             &#39;</span><span class="o">[</span><span class="no">Gmail</span><span class="o">]/&amp;</span><span class="n">j</span><span class="p">,</span><span class="n">dg0TDhMPww6w</span><span class="o">-</span><span class="s1">&#39; # -&gt; &#39;</span><span class="o">~</span><span class="sr">/Mail/im</span><span class="n">ap</span><span class="o">/[</span><span class="no">Gmail</span><span class="o">]/&amp;</span><span class="n">j</span><span class="p">,</span><span class="n">dg0TDhMPww6w</span><span class="o">-</span><span class="s1">&#39; になる</span>
<span class="s1">             ]</span>
<span class="s1">sslcacertfile = /etc/ssl/certs/ca-certificates.crt</span>

<span class="s1"># Main サーバの設定: ここで設定する名前は [general] accounts に揃える</span>
<span class="s1">[Account Main]</span>
<span class="s1">localrepository = LocalMain</span>
<span class="s1">remoterepository = RemoteMain</span>
<span class="s1">status_backend = sqlite</span>
<span class="s1">maxsize = 2000000000</span>
<span class="s1">quick = 0</span>

<span class="s1">[Repository LocalMain]</span>
<span class="s1"># 手元の設定</span>
<span class="s1">type = Maildir</span>
<span class="s1"># Maildir の格納場所</span>
<span class="s1">localfolders = ~/Mail/imap</span>
<span class="s1">restoreatime = no</span>
<span class="s1"># local -&gt; remote での名前変換</span>
<span class="s1"># LocaltoRemoteTransnameINBOX は offlineimap_utils.py で定義した関数</span>
<span class="s1">nametrans = LocalToRemoteTransnameINBOX</span>
<span class="s1"># &#39;</span><span class="no">Maildir</span><span class="o">/</span><span class="n">imap</span><span class="o">/[</span><span class="no">Gmail</span><span class="o">]</span><span class="s1">&#39; は同期しない</span>
<span class="s1">folderfilter = lambda folder: not folder.startswith(&#39;</span><span class="o">[</span><span class="no">Gmail</span><span class="o">]</span><span class="s1">&#39;)</span>
<span class="s1">sep = /</span>

<span class="s1">[Repository RemoteMain]</span>
<span class="s1">type = IMAP</span>
<span class="s1">ssl = yes</span>
<span class="s1"># certificates がデフォルトで探せない?</span>
<span class="s1">sslcacertfile = /etc/ssl/certs/ca-certificates.crt</span>
<span class="s1">remotehost = [main server]</span>
<span class="s1"># remote&#123;pass,user}eval は offlineimap_utils.py で定義した関数</span>
<span class="s1">remoteusereval = get_username(&quot;[main server]&quot;)</span>
<span class="s1">remotepasseval = get_password(&quot;[main server]&quot;)</span>
<span class="s1">maxsize = 2000000000</span>
<span class="s1">maxconnections = 5</span>
<span class="s1"># remote -&gt; local での名前の変換</span>
<span class="s1"># RemotetoLocalTransnameINBOX は offlineimap_utils.py で定義した関数</span>
<span class="s1">nametrans = RemoteToLocalTransnameINBOX</span>
<span class="s1"># 同期 *しない* フォルダの選択</span>
<span class="s1">folderfilter = lambda foldername: foldername not in [</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">Drafts</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">Trash</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2006</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2007</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2008</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2009</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2010</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2011</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2012</span><span class="s1">&#39;,</span>
<span class="s1">            &#39;</span><span class="no">INBOX</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">zz2013</span><span class="err">&#39;</span>
            <span class="o">]</span>
</pre></div>
<p><code>offlineimap_utils.py</code> の中身は以下の通り:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># -*- coding: utf-8</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># # Auth via GnomeKeyring</span>
<span class="kn">import</span> <span class="nn">gtk</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="nn">gnomekeyring</span> <span class="kn">as</span> <span class="nn">gkey</span>
<span class="c1"># Ad hoc fix for Striptime behavior</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_TIME</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

<span class="c1">##################</span>
<span class="c1"># Gnome keyring  #</span>
<span class="c1">##################</span>

<span class="k">class</span> <span class="nc">Keyring</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyring</span> <span class="o">=</span> <span class="n">gkey</span><span class="o">.</span><span class="n">get_default_keyring_sync</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">&#123;</span><span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="p">}</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">gkey</span><span class="o">.</span><span class="n">find_items_sync</span><span class="p">(</span><span class="n">gkey</span><span class="o">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="n">gkey</span><span class="o">.</span><span class="n">DeniedError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">&#123;</span><span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="p">}</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">gkey</span><span class="o">.</span><span class="n">find_items_sync</span><span class="p">(</span><span class="n">gkey</span><span class="o">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">secret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">&#123;</span>
                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="p">,</span>
                <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">gkey</span><span class="o">.</span><span class="n">item_create_sync</span><span class="p">(</span><span class="n">gkey</span><span class="o">.</span><span class="n">get_default_keyring_sync</span><span class="p">(),</span>
                <span class="n">gkey</span><span class="o">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_username</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">keyring</span> <span class="o">=</span> <span class="n">Keyring</span><span class="p">(</span><span class="s2">&quot;offlineimap&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s2">&quot;imap&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyring</span><span class="o">.</span><span class="n">get_credentials</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">username</span>

<span class="k">def</span> <span class="nf">get_password</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">keyring</span> <span class="o">=</span> <span class="n">Keyring</span><span class="p">(</span><span class="s2">&quot;offlineimap&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s2">&quot;imap&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyring</span><span class="o">.</span><span class="n">get_credentials</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">password</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="n">server</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&quot;server: &quot;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&quot;username: &quot;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;password: &quot;</span><span class="p">)</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;confirm password: &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;password doesn&#39;t match confirmation!&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">keyring</span> <span class="o">=</span> <span class="n">Keyring</span><span class="p">(</span><span class="s2">&quot;offlineimap&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s2">&quot;imap&quot;</span><span class="p">)</span>
        <span class="n">keyring</span><span class="o">.</span><span class="n">set_credentials</span><span class="p">((</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

<span class="c1">############################</span>
<span class="c1"># NameTrans &#39;INBOX&#39; suffix #</span>
<span class="c1">############################</span>
<span class="c1"># add &#39;INBOX&#39; suffix</span>
<span class="k">def</span> <span class="nf">LocalToRemoteTransnameINBOX</span><span class="p">(</span><span class="n">foldername</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">foldername</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s2">&quot;INBOX&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s2">&quot;INBOX.&quot;</span> <span class="o">+</span> <span class="n">foldername</span>
    <span class="k">return</span> <span class="n">retval</span>

<span class="c1"># remove &#39;INBOX&#39; suffix</span>
<span class="k">def</span> <span class="nf">RemoteToLocalTransnameINBOX</span><span class="p">(</span><span class="n">foldername</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">foldername</span> <span class="o">==</span> <span class="s2">&quot;INBOX&quot;</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;^INBOX\.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">foldername</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retval</span>
</pre></div>
<p>IMAP の名前空間が複雑な(?)場合には, 適宜正規表現を追加すると良い.</p>
<h5><a id="cron での動作"><span class='anchor'>_</span></a>cron での動作</h5>
<p>認証に GnomeKeyring を使っているので <code>DBUS_SESSION_BUS_ADDRESS</code> を設定してから
  実行するようにする.
  先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
sleep <span class="m">5</span>
<span class="c1"># Export the dbus session address on startup so it can be used by cron</span>
touch <span class="nv">$HOME</span>/.Xdbus
chmod <span class="m">600</span> <span class="nv">$HOME</span>/.Xdbus
env <span class="p">|</span> grep DBUS_SESSION_BUS_ADDRESS &gt; <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">&#39;export DBUS_SESSION_BUS_ADDRESS&#39;</span> &gt;&gt; <span class="nv">$HOME</span>/.Xdbus
</pre></div>
<p><code>~/.config/autostart</code> 以下に適当な名前で</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="no">Desktop</span> <span class="no">Entry</span><span class="o">]</span>
<span class="no">Type</span><span class="o">=</span><span class="no">Application</span>
<span class="no">Exec</span><span class="o">=</span><span class="sr">/home/u</span><span class="n">wabami</span><span class="o">/.</span><span class="n">mua</span><span class="o">/</span><span class="n">export_x_info</span><span class="o">.</span><span class="n">sh</span>
<span class="no">Hidden</span><span class="o">=</span><span class="kp">false</span>
<span class="no">NoDisplay</span><span class="o">=</span><span class="kp">false</span>
<span class="n">X</span><span class="o">-</span><span class="no">GNOME</span><span class="o">-</span><span class="no">Autostart</span><span class="o">-</span><span class="n">enabled</span><span class="o">=</span><span class="kp">true</span>
<span class="no">Name</span><span class="o">=</span><span class="no">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
<span class="no">Comment</span><span class="o">=</span><span class="no">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
</pre></div>
<p>を用意しておく.</p>
<p>あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
  必要に応じて GnomeKeyring による認証が行なわれる.
  cron で実行されるスクリプトは, 例えば</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1"># -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c1"># $Lastupdate: 2014-07-15 11:52:22$</span>
<span class="c1"># Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;</span>
<span class="c1"># License: WTFPL</span>
<span class="c1">################################################################################</span>
<span class="c1"># for personal settings</span>
<span class="nv">OFFLINEIMAP_PID</span><span class="o">=</span>~/Mail/offlineimap/pid
<span class="nv">OFFLINEIMAP_CONF</span><span class="o">=</span>~/.offlineimaprc
<span class="nv">UI</span><span class="o">=</span>quiet
<span class="nb">echo</span> <span class="s2">&quot;******************************************************************&quot;</span>
<span class="nb">echo</span> <span class="sb">`</span><span class="nv">LANG</span><span class="o">=</span>C date<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;******************************************************************&quot;</span>
<span class="c1"># for gnome-keyring:</span>
. <span class="si">$&#123;</span><span class="nv">HOME</span><span class="si">}</span>/.Xdbus
<span class="c1"># check network is avaliable</span>
nm-online -x <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="c1"># check another offlineimap</span>
<span class="o">[</span> <span class="k">$(</span>ps -p <span class="sb">`</span>cat <span class="nv">$OFFLINEIMAP_PID</span><span class="sb">`</span> -o pid --no-heading<span class="k">)</span> <span class="o">]</span> <span class="se">\</span>
  <span class="o">||</span> nice -n <span class="m">19</span> offlineimap -c <span class="nv">$OFFLINEIMAP_CONF</span> -u <span class="nv">$UI</span> -o  <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</pre></div>
<p>とか.</p>


          </div>
          <a href="#page-top" class="pagetop btn top-btn">Top</a>
        </div> <!-- /.row -->
      </div> <!-- /.content -->
    </div> <!-- /.container -->
    <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-xs-12">
        <p>
          
          &copy; 2006 - 2018
          <a href="mailto:uwabami@gfd-dennou.org"></a>,
          Lastupdate: 2018-10-16 19:46:22
          <br />
          <span class="generator"> Powered by
            <a href="http://orgmode.org/" target="_blank" title="Org-mode">Org-mode</a>
            +
            <a href="http://jekyllrb.com/" target="_blank" title="Jekyll" >Jekyll</a>
            +
            <a href="http://nkmr6194.github.io/Umi/" target="_blank">Umi</a> &amp;
            <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>
          </span>
        </p>
      </div> <!-- /.col-sm-12 -->
    </div> <!-- /.row -->
  </div> <!-- /.container -->
</footer>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90872419-1', 'auto');
  ga('send', 'pageview');
</script>

    <script src="/assets/js/org-toc.js"></script>
  </body>
</html>
