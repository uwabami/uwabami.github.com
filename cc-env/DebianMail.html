---
title: Mail 環境の設定
date: 2017-02-20 17:57:23
layout: cc-env
lang: ja
ref: cc-env/DebianMail
permalink: /cc-env/DebianMail.html
---
<div id="toc-wrapper">
<nav id="table-of-contents">
<h2>&#30446;&#27425;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge99516c">始めに</a></li>
<li><a href="#org778b89a">送信設定: Exim4</a></li>
<li><a href="#orgadebf72">送信設定: msmtp</a></li>
<li><a href="#orged459f5">受信</a>
<ul>
<li><a href="#org7abcb25">mbsync/isync</a>
<ul>
<li><a href="#orgabfac31">インストール</a></li>
<li><a href="#org813998b">設定</a></li>
<li><a href="#org5d2d440">cron での動作</a></li>
</ul>
</li>
<li><a href="#org9e83b12">dovecot</a>
<ul>
<li><a href="#org5123ec2">インストール</a></li>
<li><a href="#orga039fb0">設定</a></li>
</ul>
</li>
<li><a href="#org981070b">以下, obsolete</a>
<ul>
<li><a href="#org08c598a">検索: Solr</a></li>
<li><a href="#org445f854">検索: Solr で日本語</a></li>
<li><a href="#org59e01d8">offlineimap</a>
<ul>
<li><a href="#orgdbce8fb">インストール</a></li>
<li><a href="#orgeafc4dd">設定</a></li>
<li><a href="#org9a0907c">cron での動作</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
</div>
<a href="#toc-toggle" class="btn toc-btn" id="toc-toggle">&#30446;&#27425;</a>
<p>
Related: <a href='index.html'>Index</a> <a href="index.html#ID-591f6b0d-55ff-48eb-b095-401cdfa0d536">Debian</a>
</p>
<div id="outline-container-orge99516c" class="outline-2">
<h2 id="orge99516c">始めに</h2>
<div class="outline-text-2" id="text-orge99516c">
<p>
メールに関するアレコレ.
ネットワーク接続を意識したくないので,
送受信用のサーバを手元に置いて MUA はなるべくここを叩くようにしている.
</p>
</div>
</div>
<div id="outline-container-org778b89a" class="outline-2">
<h2 id="org778b89a">送信設定: Exim4</h2>
<div class="outline-text-2" id="text-org778b89a">
<p>
smarthost での送信だけなら Exim4 が軽量で楽。
他にも幾つか選択肢はある。気になるなら <a href="https://wiki.debian.org/Debate/DefaultMTA">Debian Wiki: DefaultMTA</a> あたり参照のこと。
欲しい機能は
</p>
<ul class="org-ul">
<li>上流の MTA への smarthost 送信。</li>
<li>offline 時の queue</li>
<li>localhost:25 での待受</li>
</ul>
<p>
なので、軽いしとりあえず Exim4 をそのまま使っている。
</p>
<pre class="example">
$ sudo -s
# dpkg-reconfigure -plow exim4-config
  メール設定の一般的なタイプ: 2. スマートホストでメール送信; SMTP または fetchmail で受信する
  システムメール名: localhost
  入力側 SMTP 接続をリスンする IP アドレス: 127.0.0.1
  メールを受け取るその他の宛先: [空白]
  メールをリレーするマシン: [空白]
  送出スマートホストの IP アドレスまたはホスト名: スマートホスト用の送信サーバ::587
  送出するメールでローカルメール名を隠しますか? no
  DNS クエリの数を最小限に留めますか (ダイヤルオンデマンド)? no
  ローカルメールの配送方式: 1. /var/mail/ 内の mbox 形式
  設定を小さなファイルに分割しますか?: no
  root と postmaster のメール受信者: 適当に設定
</pre>
<p>
そのあと, <code>/etc/exim4/passwd.client</code> 内で, スマートホストの設定
</p>
<div class="org-src-container">
<pre class="src src-conf">スマートホスト送信サーバ:[アカウント]:[パスワード]
</pre>
</div>
<p>
そして必要なら <code>/etc/exim4/email-addresses</code> に置換するリストを適当に記述.
最低限 root と ユーザ宛(uid=1000) のメール送信先は設定しておく.
</p>
<pre class="example">
$ sudo -s
# upate-exim4.conf
# sudo /etc/init.d/exim4 restart
</pre>
<p>
あとは適当にテストとかしてみると良い.
</p>

<p>
(2012/07/30) このままだと message-id が "乱数列@hostname" になるので
<code>/etc/exim4/exim4.conf.template</code> あたりに
</p>
<div class="org-src-container">
<pre class="src src-conf">message_id_header_domain = ドメイン名
message_id_header_text   = ホスト名
</pre>
</div>
<p>
を追加して <code>update-exim4.conf</code> を走らせておくと良い。
</p>

<p>
ローカル配送先を適宜設定したい場合には
</p>
<div class="org-src-container">
<pre class="src src-conf">MAILDIR_HOME_MAILDIR_LOCATION = $home/Maildir/INBOX
</pre>
</div>
</div>
</div>
<div id="outline-container-orgadebf72" class="outline-2">
<h2 id="orgadebf72">送信設定: msmtp</h2>
<div class="outline-text-2" id="text-orgadebf72">
<p>
<a href="Emacs.html#ID-544e8091-614a-4784-a889-78651a923d6c">Wanderlust</a> からメールを送る時には,
<code>msmtp</code> を使っている.
</p>

<p>
sendmail コマンド互換かつ enverope-from に応じて送信に利用する
SMTP サーバを切り替えられる, というのが良い.
本当は Gmail に SMTP サーバを登録しておいて, exim4 の smarthost で
Gmail に丸投げしたかったのだけれど,
Gmail のメールサーバは <code>Reply-To</code> を上書きしたりして行儀が良くない.
</p>

<p>
msmtp 自体の設定はいたって普通だが, queue が面倒?
結局 Emacs からは <code>sendmail</code> として
</p>
<div class="org-src-container">
<pre class="src src-sh">#!/bin/sh
ARGS="$*"
msmtp-enqueue.sh $ARGS 1&gt;/dev/null
`LANG=ja_JP.UTF-8 nmcli dev status | grep -v 管理無し | grep -q 接続済み` &amp;&amp; \
    msmtp-runqueue.sh 2&gt;&amp;1 1&gt;/dev/null
exit 0
</pre>
</div>
<p>
を叩くことで, ネットワーク接続がある場合には即座に送信,
無い場合には queuing, という風に動作を切り替えている.
</p>

<p>
あとは NetworkManager の dispatcher として msmtp-runqueue を走らせれば良い.
</p>
</div>
</div>
<div id="outline-container-orged459f5" class="outline-2">
<h2 id="orged459f5">受信</h2>
<div class="outline-text-2" id="text-orged459f5">
<p>
受信/閲覧は
</p>
<ul class="org-ul">
<li><a href="http://isync.sourceforge.net/">isync</a> で、リモートの IMAP サーバのメールをローカルに Maildir 形式で保存</li>
<li>ローカルで dovecot-imapd を起動してメールを閲覧</li>
</ul>
<p>
としている.
</p>

<p>
最近の MUA は多かれ少なかれ IMAP 接続でも手元にメールを持ってくるので,
このメールの重複をなんとかしたいのだけれども,
例えば Wanderlust なんかで Maildir を直接見にいくと Emacs の反応があまり芳しくない.
</p>

<p>
以前 <a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0247">第247回 Offlineimap＋Dovecotによる快適メール環境：Ubuntu Weekly Recipe</a> なんて記事を書いた。
その時は offlineimap を使っていたのだけれども
</p>
<ul class="org-ul">
<li>遅い。特に 2014 年あたりから Gmail の同期が体感できるレベルで遅くなった</li>
<li>偶に block するし、imap の接続数が酷い事になる。</li>
</ul>
<p>
ということで、2015 年から <a href="http://isync.sourceforge.net/">isync: free IMAP and MailDir mailbox synchronizer</a> に移行した。
</p>
</div>
<div id="outline-container-org7abcb25" class="outline-3">
<h3 id="org7abcb25">mbsync/isync</h3>
<div class="outline-text-3" id="text-org7abcb25">
<p>
isync/mbsync はリモートの IMAP サーバとローカルの Maildir を同期するソフトウェア。
</p>
</div>
<div id="outline-container-orgabfac31" class="outline-4">
<h4 id="orgabfac31">インストール</h4>
<div class="outline-text-4" id="text-orgabfac31">
<p>
実行バイナリは <code>isync</code> もしくは <code>mbsync</code> 。以前の名前が <code>isync</code> なので、Debian のパッケージ名はそのままである。
</p>
<pre class="example">
$ sudo apt-get install isync
</pre>
<p>
apt 万歳
</p>
</div>
</div>
<div id="outline-container-org813998b" class="outline-4">
<h4 id="org813998b">設定</h4>
<div class="outline-text-4" id="text-org813998b">
<p>
設定ファイルは <code>~/.mbsyncrc</code>.
設定例は以下:
</p>
<ul class="org-ul">
<li><code>~/Maildir/</code> 以下にサーバのメールを同期する</li>
<li><code>~/Maildir/INBOX.mobile.XXX</code> に imap.mobile.com のメールを同期.
<ul class="org-ul">
<li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
</ul></li>
<li><code>~/Maildir/INBOX.Gmail.XXX</code> に Gmail のメールを同期
<ul class="org-ul">
<li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
<li><code>[Gmail]/</code> というラベルを上手く扱えないので、同期チャンネルを複数設定することで対応
<ul class="org-ul">
<li>今のところ SPAM 堕ちしたメールの確認のためだけに <code>~/Maildir/INBOX.Gmail.Junk</code> のみ確認している</li>
</ul></li>
</ul></li>
<li><code>~/Maildir/INBOX</code> に <code>work.example.com</code> のメールを同期
<ul class="org-ul">
<li><code>work.example.com</code> メールサーバのディレクトリが <code>work/2014</code> 等と "/" 区切りになっているので <code>Flatten: .</code> で
<code>INBOX.work.2014</code> 等に変換する。そのために <code>MaildirStore</code> を複数設定している</li>
<li><code>Pattern: * !*mobile* !*Gmail*</code> で同期から除外する <code>Maildir</code> を指定する</li>
</ul></li>
<li>PassCmd で gpg 暗号化した netrc 形式のファイルからパスワードを取得している.
<ul class="org-ul">
<li>これ、User なんかにも使えないかなぁ、とか思ったり</li>
</ul></li>
</ul>
<p>
今のところ特に使用に際して困った事はおきていない。
</p>
<div class="org-src-container">
<pre class="src src-conf">IMAPAccount mobile
Host mobile.example.com
User TheMobileUserAccount
PassCmd "echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine mobile.example.com .*password \\\([^ ]*\\) port.*,\\1,p')}"
Port 993
UseIMAPS yes
RequireSSL yes
UseTLSv1.2 yes
CertificateFile /etc/ssl/certs/ca-certificates.crt

IMAPAccount work
Host work.example.com
User TheWorkUserAccount
PassCmd "echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine work.example.com .*password \\\([^ ]*\\) port.*,\\1,p')}"
Port 993
UseIMAPS yes
RequireSSL yes
UseTLSv1.2 yes
CertificateFile /etc/ssl/certs/ca-certificates.crt

IMAPAccount gmail
Host imap.gmail.com
User GmailMailAddress
PassCmd "echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine imap.gmail.com .*password \\\([^ ]*\\) port.*,\\1,p')}"
Port 993
UseIMAPS yes
RequireSSL yes
UseTLSv1.2 yes
CertificateFile /etc/ssl/certs/ca-certificates.crt

IMAPStore work-remote
Account work
UseNamespace no

IMAPStore work-remote
Account work

IMAPStore gmail-remote
Account gmail
UseNamespace yes

MaildirStore local
Path ~/Maildir/
Inbox ~/Maildir/INBOX

MaildirStore work-local
Path ~/Maildir/
Inbox ~/Maildir/INBOX
Flatten .

Channel mobile
Master :mobile-remote:
Slave :local:INBOX.mobile.
Patterns INBOX Junk Archives Sent Drafts Trash
Create Both
Expunge Both
Sync all
SyncState *

Channel gmail
Master :gmail-remote:
Slave :local:INBOX.Gmail.
Patterns INBOX
Create Both
Expunge Both
Sync all
SyncState *

Channel gmail-junk
Master ":gmail-remote:[Gmail]/&amp;j,dg0TDhMPww6w-"
Slave :local:INBOX.Gmail.Junk
Patterns *
Create Both
Expunge Both
Sync all
SyncState *

Channel work
Master :work-remote:
Slave :work-local:
Patterns * !*mobile* !*Gmail*
Create Both
Expunge Both
Sync all
SyncState *
</pre>
</div>
<p>
上手く設定できているなら
</p>
<pre class="example">
mbsync -l mobile
</pre>
<p>
などとして、同期する <code>Maildir</code> を確認すると良い。
リモートとローカルでどういうマッピングがされているかわかるだろう。
25万通(6.5G)の同期にだいたい 3 時間ぐらい。
回線速度に依存するだろうけれど、offlineimap より目に見えて速い(気がする)。
また、IMAP Pipeline で処理されているので、サーバ上の IMAP connection の数は 1 つのみだった。
</p>
</div>
</div>
<div id="outline-container-org5d2d440" class="outline-4">
<h4 id="org5d2d440">cron での動作</h4>
<div class="outline-text-4" id="text-org5d2d440">
<p>
認証に GPG を使っており、認証に Gnome Keyring を用いているので
必要な環境変数を読み込んでから実行するようにする.
先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意:
</p>
<div class="org-src-container">
<pre class="src src-sh">#!/bin/bash
sleep 5
# Export the dbus session address on startup so it can be used by cron
touch $HOME/.Xdbus
chmod 600 $HOME/.Xdbus
env | grep DBUS_SESSION_BUS_ADDRESS &gt; $HOME/.Xdbus
env | grep GPG_AGENT_INFO &gt;&gt; $HOME/.Xdbus
echo 'export DBUS_SESSION_BUS_ADDRESS' &gt;&gt; $HOME/.Xdbus
echo 'export GPG_AGENT_INFO' &gt;&gt; $HOME/.Xdbus
</pre>
</div>
<p>
<code>~/.config/autostart</code> 以下に適当な名前で
</p>
<div class="org-src-container">
<pre class="src src-conf">[Desktop Entry]
Type=Application
Exec=/home/uwabami/.mua/export_x_info.sh
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Name=Xdbus infomation exporter
Comment=Xdbus infomation exporter
</pre>
</div>
<p>
を用意しておく.
</p>

<p>
あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
必要に応じて GnomeKeyring による認証が行なわれる.
cron で実行されるスクリプトは, 例えば
</p>
<div class="org-src-container">
<pre class="src src-sh">#!/bin/sh
# -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-
################################################################################
# for personal settings
PID=~/Maildir/mbsync.pid
CONF=~/.mbsyncrc
# for gnome-keyring:
. ${HOME}/.Xdbus
# check network is avaliable
nm-online -x  2&gt;/dev/null || exit 0
# check another offlineimap
timelimit -T 300 -t 300 mbsync -c $CONF -a 2&gt;&amp;1 || exit 0
</pre>
</div>
<p>
とか。mbsync 自体の timeout や PID  管理ができないので、 <code>timelinit</code> コマンドで処理をするようにしている。
実際は、二回目以降の同期は(回線速度に依存するだろうけれど) 20 秒ぐらい。
</p>
</div>
</div>
</div>
<div id="outline-container-org9e83b12" class="outline-3">
<h3 id="org9e83b12">dovecot</h3>
<div class="outline-text-3" id="text-org9e83b12">
</div><div id="outline-container-org5123ec2" class="outline-4">
<h4 id="org5123ec2">インストール</h4>
<div class="outline-text-4" id="text-org5123ec2">
<p>
最低限 IMAP での接続ができれば良いので
</p>
<pre class="example">
% sudo apt-get install dovecot-imapd
</pre>
<p>
apt 万歳
</p>
</div>
</div>
<div id="outline-container-orga039fb0" class="outline-4">
<h4 id="orga039fb0">設定</h4>
<div class="outline-text-4" id="text-orga039fb0">
<p>
最低限の設定として、
</p>
<ul class="org-ul">
<li>localhost で起動. 認証は PAM に任せる(login パスワードと同じ)</li>
<li>Maildir 形式で mbsync(もしくは offlineimap)で同期したMaildirを読む.</li>
<li>IMAP もしくは IMAP over SSL のみ</li>
</ul>
<p>
ための設定を行なう
</p>

<p>
以下、設定ファイル中のコメント行を除いた部分だけを記載しているので注意
(コメント消すなんてとんでもない!)。
</p>

<p>
先ず待受サーバ。
どの IP アドレスで待ち受けるかは <code>/etc/dovecot/dovecot.conf</code> にあるので
</p>
<div class="org-src-container">
<pre class="src src-conf">...
listen = 127.0.0.1
...
</pre>
</div>
<p>
あたりを修正しておく。
</p>

<p>
認証は
<code>/etc/dovecot/conf.d/10-auth.conf</code> 内で
</p>
<div class="org-src-container">
<pre class="src src-conf">disable_plain_text_auth = no
auth_mechanisms = plain
!include auth-system.conf.ext
</pre>
</div>
<p>
を有効に。include されている auth-system.conf.ext の中身は
</p>
<div class="org-src-container">
<pre class="src src-conf">passdb {
  driver = pam
}
userdb {
  driver = passwd
}
</pre>
</div>
<p>
だけが有効。これで pam 経由でパスワードログインするようになる.
</p>

<p>
次に Maildir の設定。 <code>/etc/dovecot/conf.d/10-mail.conf</code> 内で
</p>
<div class="org-src-container">
<pre class="src src-conf">mail_location = maildir:%h/Maildir:INBOX=%h/Maildir/INBOX:LAYOUT=fs
namespace inbox {
  inbox = yes
}
</pre>
</div>
<p>
あたりを修正しておく。
</p>

<p>
最後に IMAP over SSL の設定。 <code>/etc/dovecot/conf.d/10-ssl.conf</code> で証明書の設定をする:
</p>
<div class="org-src-container">
<pre class="src src-conf">ssl_cert = &lt;/etc/ssl/private/ssl-cert-dovecot.pem
ssl_key = &lt;/etc/ssl/private/ssl-cert-dovecot.key
ssl_protocols = !SSLv2 !SSLv3
</pre>
</div>
<p>
その後に <code>/etc/dovecot/conf.d/10-master.conf</code> 内の <code>imap-login</code> 部分を修正
</p>
<div class="org-src-container">
<pre class="src src-conf">service imap-login {
  inet_listener imap {
    port = 0
    ssl = no
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}
</pre>
</div>
<p>
これで再起動すると <code>/etc/ssl/private</code> に置いた SSL 証明書を使って <code>127.0.1.1:993</code> で IMAP サーバが起動する。Listen を 127.0.0.1 に絞るなら SSL でのアクセスは不要かもしれない。
</p>
</div>
</div>
</div>
<div id="outline-container-org981070b" class="outline-3">
<h3 id="org981070b">以下, obsolete</h3>
<div class="outline-text-3" id="text-org981070b">
<p>
検索は mu (maildir-utils) を使うようになったし,
メールの同期には mbsync を使うようになったので, 以下は昔のお話.
</p>
</div>
<div id="outline-container-org08c598a" class="outline-4">
<h4 id="org08c598a">検索: Solr</h4>
<div class="outline-text-4" id="text-org08c598a">
<p>
Dovecot には FTS(Full Text Search) 用の plugin が幾つかある。
ここでは Solr を試してみる
</p>

<p>
とりあえず jetty で solar を動かすことに:
</p>
<pre class="example">
% sudo aptitude -R solr-jetty dovecot-solr
</pre>

<p>
Jetty の起動設定は <code>/etc/default/jetty8</code> にあるので
</p>
<div class="org-src-container">
<pre class="src src-conf">NO_START=0
JETTY_HOST=localhost
JETTY_PORT=8089
</pre>
</div>
<p>
としておく。dovecot 用の scheme.xml は <code>dovecot-solr</code> をインストールすると <code>/usr/share/dovecot/solr-scheme.xml</code> にインストールされるので、これを <code>/etc/solr/conf/scheme.xml</code> にコピー
</p>
<pre class="example">
% cd /etc/solr/conf
% sudo cp scheme.xml scheme.xml.bak
% sudo cp /usr/share/dovecot/solr-schemex.ml scheme.xml
</pre>
<p>
その後で <code>/etc/dovecot/conf.d/10-imap.conf</code> 内の mail<sub>plugins</sub> 行に
</p>
<div class="org-src-container">
<pre class="src src-conf">mail_plugins = fts fts_solr
</pre>
</div>
<p>
を追加しておく。
IMAP でしか使わないのであれば <code>20-imap.conf</code> に指定すれば良いのだが、この場合は <code>doveadm fts rescan -u USERNAME</code> ができない。
最後に <code>/etc/dovecot/conf.d/90-plugin.conf</code> で
</p>
<div class="org-src-container">
<pre class="src src-conf">plugin {
  fts_autoindex = yes
  fts = solr
  fts_solr = break-imap-search url=http://localhost:8089/solr/
}
</pre>
</div>
<p>
としておく。これで jetty8 および dovecot を再起動すると、検索が効く様になる&#x2026;?
</p>
</div>
</div>
<div id="outline-container-org445f854" class="outline-4">
<h4 id="org445f854">検索: Solr で日本語</h4>
<div class="outline-text-4" id="text-org445f854">
<p>
<code>scheme.xml</code> の修正が必要。
とりあえず
</p>
<ul class="org-ul">
<li><code>/etc/solr/conf/scheme.xml</code> より <code>text_cjk</code> および <code>text_ja</code> の部分を抜き出して, dovecot の提供していた <code>scheme.xml</code> に追加</li>
<li><code>hdr,body,subject</code> を <code>text_cjk</code> で解析するように</li>
</ul>
<p>
してみた.
</p>

<p>
diff は以下:
</p>
<div class="org-src-container">
<pre class="src src-diff">--- solr-schema.xml 2015-05-10 20:52:33.375358006 +0900
+++ schema.xml  2015-05-10 20:37:37.358195292 +0900
@@ -13,6 +13,62 @@
     &lt;fieldType name="long" class="solr.TrieLongField" /&gt;
     &lt;fieldType name="boolean" class="solr.BoolField" /&gt;

+    &lt;!-- CJK bigram (see text_ja for a Japanese configuration using morphological analysis) --&gt;
+    &lt;fieldType name="text_cjk" class="solr.TextField" positionIncrementGap="100"&gt;
+      &lt;analyzer&gt;
+        &lt;tokenizer class="solr.StandardTokenizerFactory"/&gt;
+        &lt;!-- normalize width before bigram, as e.g. half-width dakuten combine  --&gt;
+        &lt;filter class="solr.CJKWidthFilterFactory"/&gt;
+        &lt;!-- for any non-CJK --&gt;
+        &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
+        &lt;filter class="solr.CJKBigramFilterFactory"/&gt;
+      &lt;/analyzer&gt;
+    &lt;/fieldType&gt;
+    &lt;fieldType name="text_ja" class="solr.TextField" positionIncrementGap="100" autoGeneratePhraseQueries="false"&gt;
+      &lt;analyzer&gt;
+      &lt;!-- Kuromoji Japanese morphological analyzer/tokenizer (JapaneseTokenizer)
+
+           Kuromoji has a search mode (default) that does segmentation useful for search.  A heuristic
+           is used to segment compounds into its parts and the compound itself is kept as synonym.
+
+           Valid values for attribute mode are:
+              normal: regular segmentation
+              search: segmentation useful for search with synonyms compounds (default)
+            extended: same as search mode, but unigrams unknown words (experimental)
+
+           For some applications it might be good to use search mode for indexing and normal mode for
+           queries to reduce recall and prevent parts of compounds from being matched and highlighted.
+           Use &lt;analyzer type="index"&gt; and &lt;analyzer type="query"&gt; for this and mode normal in query.
+
+           Kuromoji also has a convenient user dictionary feature that allows overriding the statistical
+           model with your own entries for segmentation, part-of-speech tags and readings without a need
+           to specify weights.  Notice that user dictionaries have not been subject to extensive testing.
+
+           User dictionary attributes are:
+                     userDictionary: user dictionary filename
+             userDictionaryEncoding: user dictionary encoding (default is UTF-8)
+
+           See lang/userdict_ja.txt for a sample user dictionary file.
+
+           See http://wiki.apache.org/solr/JapaneseLanguageSupport for more on Japanese language support.
+        --&gt;
+        &lt;tokenizer class="solr.JapaneseTokenizerFactory" mode="search"/&gt;
+        &lt;!--&lt;tokenizer class="solr.JapaneseTokenizerFactory" mode="search" userDictionary="lang/userdict_ja.txt"/&gt;--&gt;
+        &lt;!-- Reduces inflected verbs and adjectives to their base/dictionary forms (辞書形) --&gt;
+        &lt;filter class="solr.JapaneseBaseFormFilterFactory"/&gt;
+        &lt;!-- Removes tokens with certain part-of-speech tags --&gt;
+        &lt;filter class="solr.JapanesePartOfSpeechStopFilterFactory" tags="lang/stoptags_ja.txt" enablePositionIncrements="true"/&gt;
+        &lt;!-- Normalizes full-width romaji to half-width and half-width kana to full-width (Unicode NFKC subset) --&gt;
+        &lt;filter class="solr.CJKWidthFilterFactory"/&gt;
+        &lt;!-- Removes common tokens typically not useful for search, but have a negative effect on ranking --&gt;
+        &lt;filter class="solr.StopFilterFactory" ignoreCase="true" words="lang/stopwords_ja.txt" enablePositionIncrements="true" /&gt;
+        &lt;!-- Normalizes common katakana spelling variations by removing any last long sound character (U+30FC) --&gt;
+        &lt;filter class="solr.JapaneseKatakanaStemFilterFactory" minimumLength="4"/&gt;
+        &lt;!-- Lower-cases romaji characters --&gt;
+        &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
+      &lt;/analyzer&gt;
+    &lt;/fieldType&gt;
+
     &lt;fieldType name="text" class="solr.TextField" positionIncrementGap="100"&gt;
       &lt;analyzer type="index"&gt;
         &lt;tokenizer class="solr.StandardTokenizerFactory"/&gt;
@@ -43,14 +99,14 @@
    &lt;field name="box" type="string" indexed="true" stored="true" required="true" /&gt;
    &lt;field name="user" type="string" indexed="true" stored="true" required="true" /&gt;

-   &lt;field name="hdr" type="text" indexed="true" stored="false" /&gt;
-   &lt;field name="body" type="text" indexed="true" stored="false" /&gt;
+   &lt;field name="hdr" type="text_cjk" indexed="true" stored="false" /&gt;
+   &lt;field name="body" type="text_cjk" indexed="true" stored="false" /&gt;

    &lt;field name="from" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="to" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="cc" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="bcc" type="text" indexed="true" stored="false" /&gt;
-   &lt;field name="subject" type="text" indexed="true" stored="false" /&gt;
+   &lt;field name="subject" type="text_cjk" indexed="true" stored="false" /&gt;

    &lt;!-- Used by Solr internally: --&gt;
    &lt;field name="_version_" type="long" indexed="true" stored="true"/&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org59e01d8" class="outline-4">
<h4 id="org59e01d8">offlineimap</h4>
<div class="outline-text-4" id="text-org59e01d8">
<p>
(2015/05/10) 以前使っていた時のメモ。もう使わないけれど、たまに検索でココを見に来ている人がいるみたいなので、残しておくことに。
<a href="http://offlineimap.org/">OfflineIMAP</a> は,ネットワーク上にあるIMAPサーバと手元のMaildir/IMAPサーバの同期を取るためのソフトウェア.
</p>
</div>
<div id="outline-container-orgdbce8fb" class="outline-5">
<h5 id="orgdbce8fb">インストール</h5>
<div class="outline-text-5" id="text-orgdbce8fb">
<p>
apt万歳, ってことで.
</p>
<pre class="example">
$ sudo apt-get install offlineimap
</pre>
</div>
</div>
<div id="outline-container-orgeafc4dd" class="outline-5">
<h5 id="orgeafc4dd">設定</h5>
<div class="outline-text-5" id="text-orgeafc4dd">
<p>
現状, 以下の通り:
</p>
<ul class="org-ul">
<li><a href="http://offlineimap.org/">OfflineIMAP</a> のメタ情報は <code>~/Mail/offlineimap</code> 以下に格納</li>
<li>同期するサーバは二箇所:
<ul class="org-ul">
<li>Main サーバのメールは <code>~/Mail/imap</code> 以下に格納.
<ul class="org-ul">
<li>この際, IMAP Namespace である <code>INBOX.</code> を除外して <code>Maildir</code> を作成</li>
<li><code>~/Mail/imap/[Gmail]</code> は同期しない</li>
</ul></li>
<li>Gmail のメールは <code>~/Mail/imap/[Gmail]/</code> 以下に格納</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-conf"># -*- mode: conf; coding: utf-8-unix; indent-tabs-mode: nil -*-
# offlineimaprc
#
# Copyright(C) 2011 Youhei SASAKI All rights reserved.
# $Lastupdate: 2014-07-26 18:25:07$
#
# Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;
# License: WTFPL
#
# Code:
[general]
# メタデータの格納先
metadata = ~/Mail/offlineimap
# 補助関数が定義されたファイルの置き場所
pythonfile = ~/.mua/offlineimap_utils.py
# 同期するサーバの設定
accounts = Main, Gmail
# 同期するアカウントの数
maxsyncaccounts = 2
# UI の設定. cron で同期する場合には quiet の方が良い
ui = basic
socktimeout = 600
# 高速化(?)
fsync = false

# Gmail 用の設定: ここで設定する名前は accounts に揃える
[Account Gmail]
localrepository = LocalGmail
remoterepository = RemoteGmail
maxsize = 2000000000
status_backend = sqlite
# quick = 1 だとフラグは同期されない
# '[Gmail]/全てのメール' を同期するなら quick = 1 の方が良い?
quick = 0

[Repository LocalGmail]
# Gmail の手元の設定
type = Maildir
# Maildir の格納場所
localfolders = ~/Mail/imap/[Gmail]
restoreatime = no
# IMAP のセパレータの変換: Mailbox の "." が "/" となり,
# ディレクトリが作成される
sep = /

[Repository RemoteGmail]
# Gmail との接続設定: type = IMAP でも良い?
type = Gmail
# remote{pass,user}eval は offlineimap_utils.py で定義した関数
remoteusereval = get_username("imap.gmail.com")
remotepasseval = get_password("imap.gmail.com")
maxsize = 2000000000
realdelete = no
# 同時接続数. 並列実行可能なので適宜
# サーバに怒られない程度に
maxconnections = 5
# remote -&gt; local 時のフォルダ名変換(正規表現)
nametrans = lambda foldername: re.sub('^INBOX','', (re.sub('^\[Gmail\]/','', foldername)))
# 同期するフォルダの設定: Gmail 側で IMAP で表示するラベル設定しておく, でも良いかも.
folderfilter = lambda foldername: foldername in [
             'INBOX',                   # -&gt; '~/Mail/imap/[Gmail]' になる
             '[Gmail]/&amp;j,dg0TDhMPww6w-' # -&gt; '~/Mail/imap/[Gmail]/&amp;j,dg0TDhMPww6w-' になる
             ]
sslcacertfile = /etc/ssl/certs/ca-certificates.crt

# Main サーバの設定: ここで設定する名前は [general] accounts に揃える
[Account Main]
localrepository = LocalMain
remoterepository = RemoteMain
status_backend = sqlite
maxsize = 2000000000
quick = 0

[Repository LocalMain]
# 手元の設定
type = Maildir
# Maildir の格納場所
localfolders = ~/Mail/imap
restoreatime = no
# local -&gt; remote での名前変換
# LocaltoRemoteTransnameINBOX は offlineimap_utils.py で定義した関数
nametrans = LocalToRemoteTransnameINBOX
# 'Maildir/imap/[Gmail]' は同期しない
folderfilter = lambda folder: not folder.startswith('[Gmail]')
sep = /

[Repository RemoteMain]
type = IMAP
ssl = yes
# certificates がデフォルトで探せない?
sslcacertfile = /etc/ssl/certs/ca-certificates.crt
remotehost = [main server]
# remote{pass,user}eval は offlineimap_utils.py で定義した関数
remoteusereval = get_username("[main server]")
remotepasseval = get_password("[main server]")
maxsize = 2000000000
maxconnections = 5
# remote -&gt; local での名前の変換
# RemotetoLocalTransnameINBOX は offlineimap_utils.py で定義した関数
nametrans = RemoteToLocalTransnameINBOX
# 同期 *しない* フォルダの選択
folderfilter = lambda foldername: foldername not in [
            'INBOX.Drafts',
            'INBOX.Trash',
            'INBOX.archive.zz2006',
            'INBOX.archive.zz2007',
            'INBOX.archive.zz2008',
            'INBOX.archive.zz2009',
            'INBOX.archive.zz2010',
            'INBOX.archive.zz2011',
            'INBOX.archive.zz2012',
            'INBOX.archive.zz2013'
            ]
</pre>
</div>
<p>
<code>offlineimap_utils.py</code> の中身は以下の通り:
</p>
<div class="org-src-container">
<pre class="src src-python">#!/usr/bin/python
# -*- coding: utf-8
import sys
import re
import os
# # Auth via GnomeKeyring
import gtk
from getpass import getpass
import gnomekeyring as gkey
# Ad hoc fix for Striptime behavior
import locale
locale.setlocale(locale.LC_TIME, 'C')

##################
# Gnome keyring  #
##################

class Keyring(object):
    def __init__(self, name, server, protocol):
        self._name = name
        self._server = server
        self._protocol = protocol
        self._keyring = gkey.get_default_keyring_sync()

    def has_credentials(self):
        try:
            attrs = {"server": self._server, "protocol": self._protocol}
            items = gkey.find_items_sync(gkey.ITEM_NETWORK_PASSWORD, attrs)
            return len(items) &gt; 0
        except gkey.DeniedError:
            return False

    def get_credentials(self):
        attrs = {"server": self._server, "protocol": self._protocol}
        items = gkey.find_items_sync(gkey.ITEM_NETWORK_PASSWORD, attrs)
        return (items[0].attributes["user"], items[0].secret)

    def set_credentials(self, (user, pw)):
        attrs = {
                "user": user,
                "server": self._server,
                "protocol": self._protocol,
            }
        gkey.item_create_sync(gkey.get_default_keyring_sync(),
                gkey.ITEM_NETWORK_PASSWORD, self._name, attrs, pw, True)

def get_username(server):
    keyring = Keyring("offlineimap", server, "imap")
    (username, password) = keyring.get_credentials()
    return username

def get_password(server):
    keyring = Keyring("offlineimap", server, "imap")
    (username, password) = keyring.get_credentials()
    return password

if __name__ == '__main__':
        server = raw_input("server: ")
        user = raw_input("username: ")
        password = getpass("password: ")
        confirm = getpass("confirm password: ")
        if password != confirm:
            print "password doesn't match confirmation!"
            sys.exit(1)
        keyring = Keyring("offlineimap", server, "imap")
        keyring.set_credentials((user, password))

############################
# NameTrans 'INBOX' suffix #
############################
# add 'INBOX' suffix
def LocalToRemoteTransnameINBOX(foldername):
    if (foldername == ""):
        retval = "INBOX"
    else:
        retval = "INBOX." + foldername
    return retval

# remove 'INBOX' suffix
def RemoteToLocalTransnameINBOX(foldername):
    if (foldername == "INBOX"):
        retval = ""
    else:
        retval = re.sub("^INBOX\.", "", foldername)
    return retval
</pre>
</div>
<p>
IMAP の名前空間が複雑な(?)場合には, 適宜正規表現を追加すると良い.
</p>
</div>
</div>
<div id="outline-container-org9a0907c" class="outline-5">
<h5 id="org9a0907c">cron での動作</h5>
<div class="outline-text-5" id="text-org9a0907c">
<p>
認証に GnomeKeyring を使っているので <code>DBUS_SESSION_BUS_ADDRESS</code> を設定してから
実行するようにする.
先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意
</p>
<div class="org-src-container">
<pre class="src src-sh">#!/bin/bash
sleep 5
# Export the dbus session address on startup so it can be used by cron
touch $HOME/.Xdbus
chmod 600 $HOME/.Xdbus
env | grep DBUS_SESSION_BUS_ADDRESS &gt; $HOME/.Xdbus
echo 'export DBUS_SESSION_BUS_ADDRESS' &gt;&gt; $HOME/.Xdbus
</pre>
</div>
<p>
<code>~/.config/autostart</code> 以下に適当な名前で
</p>
<div class="org-src-container">
<pre class="src src-conf">[Desktop Entry]
Type=Application
Exec=/home/uwabami/.mua/export_x_info.sh
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Name=Xdbus infomation exporter
Comment=Xdbus infomation exporter
</pre>
</div>
<p>
を用意しておく.
</p>

<p>
あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
必要に応じて GnomeKeyring による認証が行なわれる.
cron で実行されるスクリプトは, 例えば
</p>
<div class="org-src-container">
<pre class="src src-sh">#!/bin/sh
# -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-
# $Lastupdate: 2014-07-15 11:52:22$
# Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;
# License: WTFPL
################################################################################
# for personal settings
OFFLINEIMAP_PID=~/Mail/offlineimap/pid
OFFLINEIMAP_CONF=~/.offlineimaprc
UI=quiet
echo "******************************************************************"
echo `LANG=C date`
echo "******************************************************************"
# for gnome-keyring:
. ${HOME}/.Xdbus
# check network is avaliable
nm-online -x || exit 0
# check another offlineimap
[ $(ps -p `cat $OFFLINEIMAP_PID` -o pid --no-heading) ] \
  || nice -n 19 offlineimap -c $OFFLINEIMAP_CONF -u $UI -o  2&gt;&amp;1
</pre>
</div>
<p>
とか.
</p>
</div>
</div>
</div>
</div>
</div>
