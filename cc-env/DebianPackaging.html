---
title: パッケージ作成環境&#58; sbuild, lintian, piuparts, autopkgtest
date: 2017-02-26 16:31:47
layout: cc-env
lang: ja
ref: cc-env/DebianPackaging
permalink: /cc-env/DebianPackaging.html
---
<div id="toc-wrapper">
<nav id="table-of-contents">
<h2>&#30446;&#27425;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga984f73">はじめに</a></li>
<li><a href="#org6bb6b14"><code>sbuild</code>: clean room build 環境</a>
<ul>
<li><a href="#org58ae8dd">インストールと設定</a></li>
</ul>
</li>
<li><a href="#org590e009"><code>lintian</code>: パッケージの品質のチェック</a></li>
<li><a href="#orgd973f90"><code>piuparts</code>: パッケージとしてのテスト</a></li>
<li><a href="#org923b744"><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</a></li>
</ul>
</div>
</nav>
</div>
<a href="#toc-toggle" class="btn toc-btn" id="toc-toggle">&#30446;&#27425;</a>
<p>
Related <a href='index.html'>Index</a> <a href="index.html#ID-591f6b0d-55ff-48eb-b095-401cdfa0d536">Debian</a>
</p>
<div id="outline-container-orga984f73" class="outline-2">
<h2 id="orga984f73">はじめに</h2>
<div class="outline-text-2" id="text-orga984f73">
<p>
Debian パッケージを作成するため
</p>
<ul class="org-ul">
<li><a href="#org6bb6b14"><code>sbuild</code>: clean room build 環境</a> :ビルド時の依存環境をテストしつつビルドする</li>
<li><a href="#org590e009"><code>lintian</code>: パッケージの品質のチェック</a></li>
<li><a href="#orgd973f90"><code>piuparts</code>: パッケージとしてのテスト</a></li>
<li><a href="#org923b744"><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</a></li>
</ul>
<p>
ができるようにする.
今は sbuild の chroot 環境可ですが,
そのうち lxc を使ってそちらに投げるようにしたい.
</p>
</div>
</div>
<div id="outline-container-org6bb6b14" class="outline-2">
<h2 id="org6bb6b14"><a id="ID-74d27536-cf49-4780-8b6d-2e7b22027785"></a><code>sbuild</code>: clean room build 環境</h2>
<div class="outline-text-2" id="text-org6bb6b14">
<p>
clean room build 環境としては
</p>
<ul class="org-ul">
<li>pbuilder/cowbuilder/qemubuilder</li>
<li>sbuild</li>
</ul>
<p>
の二通りがあります. どちらが良いのか, は完全に好みの問題だと思いますが
Debian 公式のビルドインフラが sbuild なので, 私は sbuild を使っています.
sbuild に関しては <a href="https://wiki.debian.org/sbuild">sbuild - Debian Wiki</a> を参照下さい.
</p>
</div>
<div id="outline-container-org58ae8dd" class="outline-3">
<h3 id="org58ae8dd">インストールと設定</h3>
<div class="outline-text-3" id="text-org58ae8dd">
<p>
ほぼ, 上述の wiki の通り
</p>
<pre class="example">
sudo apt-get install sbuild
sudo sbuild-adduser $LOGNAME
newgrp sbuild
</pre>
<p>
chroot の作成は以下
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FF7F7F;">for</span> a<span style="color: #FF7F7F;"> in</span> amd64 i386; <span style="color: #FF7F7F;">do</span>
  <span style="color: #FF7F7F;">for</span> d<span style="color: #FF7F7F;"> in</span> stable testing unstable ; <span style="color: #FF7F7F;">do</span>
    sudo <span style="color: #7F7FFF;">LANG</span>=C sbuild-createchroot --arch=$<span style="color: #7F7FFF;">a</span> --include=eatmydata,gnupg $<span style="color: #7F7FFF;">d</span> <span style="color: #7FFF7F;">\</span>
        /srv/chroot/$<span style="color: #7F7FFF;">d</span>-$<span style="color: #7F7FFF;">a</span>-sbuild http://dennou-k.gfd-dennou.org/debian
  <span style="color: #FF7F7F;">done</span>
<span style="color: #FF7F7F;">done</span>
</pre>
</div>
<p>
これで, <code>/srv/chroot/</code> 以下に sbuild 用の chroot 環境ができる.
ついでに <code>/etc/schroot/chroot.d/</code> 以下に sbuild 用の設定ファイルができるので,
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #7F7FFF;">union-type</span>=overlay
</pre>
</div>
<p>
を設定しておくと良い(overlayfs で動作する):
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FF7F7F;">for</span> conf<span style="color: #FF7F7F;"> in</span> $(grep -l &#8217;^union-type=&#8217; /etc/schroot/chroot.d/*-sbuild*); <span style="color: #FF7F7F;">do</span>
    <span style="color: #FF7F7F;">if</span> <span style="color: #7FFFFF; font-weight: bold;">!</span> grep -q <span style="color: #7FFF7F;">"^union-overlay-directory="</span> <span style="color: #7FFF7F;">"$conf"</span> ; <span style="color: #FF7F7F;">then</span>
        <span style="color: #7FBFFF;">echo</span> &#8217;union-overlay-directory=/dev/shm&#8217; | sudo tee --append <span style="color: #7FFF7F;">"$conf"</span>
    <span style="color: #FF7F7F;">fi</span>
<span style="color: #FF7F7F;">done</span>
</pre>
</div>
<p>
sbuild の設定は <code>~/.sbuildrc</code> に以下の通りに書いておく
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">-*- mode: cperl -*-</span>
<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">basic</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">architecture: all &#12418; build &#12377;&#12427;</span>
<span style="color: #7F7FFF;">$build_arch_all</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">&#12487;&#12501;&#12457;&#12523;&#12488;&#12391; source packag &#12418; build &#12377;&#12427;</span>
<span style="color: #7F7FFF;">$build_source</span> = 1;
<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">debsign</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">GPG key id</span>
<span style="color: #7F7FFF;">$key_id</span> = <span style="color: #7FFF7F;">'66A4EA704FE240558D6AC2E69394F354891D7E07'</span>;
<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">lintinan</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; lintian &#12434;&#36208;&#12425;&#12379;&#12427;</span>
<span style="color: #7F7FFF;">$run_lintian</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">lintian &#12398; option. &#12362;&#22909;&#12415;&#12391;&#12290;</span>
<span style="color: #7F7FFF;">$lintian_opts</span> = [<span style="color: #7FFF7F;">'-i'</span>, <span style="color: #7FFF7F;">'-I'</span>];
<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">piuparts</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; piuparts &#12434;&#36208;&#12425;&#12379;&#12427;</span>
<span style="color: #7F7FFF;">$run_piuparts</span> = 0;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">piuparts &#12398; option&#12290;&#12371;&#12371;&#12391;&#12399; schroot &#12391;&#36208;&#12425;&#12379;&#12427;</span>
<span style="color: #7F7FFF;">$piuparts_opts</span> = [<span style="color: #7FFF7F;">'-N'</span>, <span style="color: #7FFF7F;">'-d'</span>, <span style="color: #7FFF7F;">'%r'</span>, <span style="color: #7FFF7F;">'--keep-sources-list'</span>, <span style="color: #7FFF7F;">'--schroot'</span>, <span style="color: #7FFF7F;">'%r-%a-sbuild'</span>];
<span style="color: #a5a5a6;">#</span>
<span style="color: #7F7FFF;">$piuparts_root_args</span> = [<span style="color: #7FFF7F;">'sudo'</span>, <span style="color: #7FFF7F;">'--'</span>];
<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">autopkgtest</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; autopkgtest &#12434;&#23455;&#34892;&#12377;&#12427;</span>
<span style="color: #7F7FFF;">$run_autopkgtest</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">option</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">$autopkgtest_opts = ['--user', 'debci', '-U', '--', 'lxc', 'adt-sid-%a'];</span>
<span style="color: #7F7FFF;">$autopkgtest_opts</span> = [<span style="color: #7FFF7F;">'-U'</span>, <span style="color: #7FFF7F;">'--'</span>, <span style="color: #7FFF7F;">'schroot'</span>, <span style="color: #7FFF7F;">'%r-%a-sbuild'</span>];
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">root_args</span>
<span style="color: #7F7FFF;">$autopkgtest_root_args</span> = [<span style="color: #7FFF7F;">'sudo'</span>, <span style="color: #7FFF7F;">'--'</span>];
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">#</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;"># autopkgtest</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">$external_commands =</span>
<span style="color: #FFFF7F;">#</span><span style="color: #a5a5a6;">   </span><span style="color: #a5a5a6;">{</span>
<span style="color: #a5a5a6;">#    </span><span style="color: #a5a5a6;">'post-build-commands' =&gt;</span>
<span style="color: #a5a5a6;">#    </span><span style="color: #a5a5a6;">[</span>
<span style="color: #a5a5a6;">#     </span><span style="color: #a5a5a6;">[</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;">'autopkgtest', '--user', 'debci', '-U', '%d',</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;">'--', 'lxc', 'adt-sid-%a;',</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;"># '%c',</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;"># if autopkgtest's exit code is 8 then the package had no tests</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;"># but this isn't a failure, so catch it</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;">'aptexit=$?;',</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;">'if', 'test', '$aptexit', '=', '8;', 'then',</span>
<span style="color: #a5a5a6;">#      </span><span style="color: #a5a5a6;">'exit', '0;', 'else', 'exit', '$aptexit;', 'fi'</span>
<span style="color: #a5a5a6;">#     </span><span style="color: #a5a5a6;">],</span>
<span style="color: #a5a5a6;">#    </span><span style="color: #a5a5a6;">],</span>
<span style="color: #a5a5a6;">#   </span><span style="color: #a5a5a6;">};</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org590e009" class="outline-2">
<h2 id="org590e009"><a id="ID-0b5136f9-4bea-4417-849a-96f5f95b6504"></a><code>lintian</code>: パッケージの品質のチェック</h2>
<div class="outline-text-2" id="text-org590e009">
<p>
作成したパッケージが Debian Policy に準拠しているかを
チェックするパッケージである lintian を導入します.
</p>
<pre class="example">
% sudo apt-get install lintian
</pre>
<p>
設定は以下の通り. <code>pedantic</code> と <code>info</code> は, まあ趣味でしょうか.
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #7F7FFF;">display-info</span> = yes
<span style="color: #7F7FFF;">pedantic</span> = yes
<span style="color: #7F7FFF;">color</span> = auto
<span style="color: #7F7FFF;">show-overrides</span> = yes
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd973f90" class="outline-2">
<h2 id="orgd973f90"><a id="ID-bcb9e308-7a2d-4bab-8876-30b8eedaf43c"></a><code>piuparts</code>: パッケージとしてのテスト</h2>
<div class="outline-text-2" id="text-orgd973f90">
<p>
ビルドしたパッケージについて
インストール, アップグレード, リムーブ, パージのテストを行なえる
piuparts を導入しておく.
</p>
<pre class="example">
% sudo apt-get install piuparts
</pre>
<p>
実際の呼び出しは sbuild で行なうので, 特に設定していない
</p>
</div>
</div>
<div id="outline-container-org923b744" class="outline-2">
<h2 id="org923b744"><a id="ID-d2393bd8-c286-44ad-a23a-b50893ee82f3"></a><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</h2>
<div class="outline-text-2" id="text-org923b744">
<p>
autopkgtest パッケージを導入しておく.
テスト環境は sbuild で作成した chroot を使う.
呼び出しも sbuild から行なうのて, 特に別途設定はしていない.
</p>
</div>
</div>
