---
title: パッケージ作成環境&#58; sbuild, lintian, piuparts, autopkgtest
date: 2017-09-09 17:35:29
layout: cc-env
lang: ja
ref: cc-env/DebianPackaging
permalink: /cc-env/DebianPackaging.html
---
<div id="toc-wrapper">
<nav id="table-of-contents">
<h2>&#30446;&#27425;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga984f73">はじめに</a></li>
<li><a href="#org6bb6b14"><span class="todo TODO">TODO</span> <code>sbuild</code>: clean room build 環境</a>
<ul>
<li><a href="#org58ae8dd">インストールと設定</a></li>
</ul>
</li>
<li><a href="#org590e009"><code>lintian</code>: パッケージの品質のチェック</a></li>
<li><a href="#orgd973f90"><code>piuparts</code>: パッケージとしてのテスト</a></li>
<li><a href="#org923b744"><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</a>
<ul>
<li><a href="#org336e175">初期設定</a></li>
<li><a href="#org5d833fe">sbuild からの呼び出し</a></li>
</ul>
</li>
<li><a href="#orgfd061e9"><code>~/.sbuildrc</code></a></li>
<li><a href="#org38e5d92"><code>~/.sbuild.d/sbuild-debci-rdepends</code></a></li>
</ul>
</div>
</nav>
</div>
<a href="#toc-toggle" class="btn toc-btn" id="toc-toggle">&#30446;&#27425;</a>
<p>
Related <a href='index.html'>Index</a> <a href="index.html#ID-591f6b0d-55ff-48eb-b095-401cdfa0d536">Debian</a>
</p>
<div id="outline-container-orga984f73" class="outline-2">
<h2 id="orga984f73">はじめに</h2>
<div class="outline-text-2" id="text-orga984f73">
<p>
Debian パッケージを作成するため
</p>
<ul class="org-ul">
<li><a href="#org6bb6b14"><code>sbuild</code>: clean room build 環境</a> :ビルド時の依存環境をテストしつつビルドする</li>
<li><a href="#org590e009"><code>lintian</code>: パッケージの品質のチェック</a></li>
<li><a href="#orgd973f90"><code>piuparts</code>: パッケージとしてのテスト</a></li>
<li><a href="#org923b744"><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</a></li>
</ul>
<p>
ができるようにしておきます.
</p>
</div>
</div>
<div id="outline-container-org6bb6b14" class="outline-2">
<h2 id="org6bb6b14"><a id="ID-74d27536-cf49-4780-8b6d-2e7b22027785"></a><span class="todo TODO">TODO</span> <code>sbuild</code>: clean room build 環境</h2>
<div class="outline-text-2" id="text-org6bb6b14">
<p>
clean room build 環境としては
</p>
<ul class="org-ul">
<li>pbuilder/cowbuilder/qemubuilder</li>
<li>sbuild</li>
</ul>
<p>
の二通りがあります. どちらが良いのか, は完全に好みの問題だと思いますが
Debian 公式のビルドインフラが sbuild なので, 私は sbuild を使っています.
sbuild に関しては <a href="https://wiki.debian.org/sbuild">sbuild - Debian Wiki</a> を参照下さい.
</p>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> sbuild の build 環境に lxc って使えたりしないかな&#x2026;?</li>
</ul>
</div>
<div id="outline-container-org58ae8dd" class="outline-3">
<h3 id="org58ae8dd">インストールと設定</h3>
<div class="outline-text-3" id="text-org58ae8dd">
<p>
ほぼ, 上述の wiki の通り:
</p>
<pre class="example">
sudo apt-get install sbuild
sudo sbuild-adduser $LOGNAME
newgrp sbuild
</pre>
<p>
chroot の作成は以下
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FF7F7F;">for</span> a<span style="color: #FF7F7F;"> in</span> amd64 i386; <span style="color: #FF7F7F;">do</span>
  <span style="color: #FF7F7F;">for</span> d<span style="color: #FF7F7F;"> in</span> stable testing unstable ; <span style="color: #FF7F7F;">do</span>
    sudo <span style="color: #7F7FFF;">LANG</span>=C sbuild-createchroot --arch=$<span style="color: #7F7FFF;">a</span> --include=eatmydata,gnupg $<span style="color: #7F7FFF;">d</span> <span style="color: #7FFF7F;">\</span>
        /srv/chroot/$<span style="color: #7F7FFF;">d</span>-$<span style="color: #7F7FFF;">a</span>-sbuild http://dennou-k.gfd-dennou.org/debian
  <span style="color: #FF7F7F;">done</span>
<span style="color: #FF7F7F;">done</span>
</pre>
</div>
<p>
これで, <code>/srv/chroot/</code> 以下に sbuild 用の chroot 環境ができる.
ついでに <code>/etc/schroot/chroot.d/</code> 以下に sbuild 用の設定ファイルができるので,
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #7F7FFF;">union-type</span>=overlay
<span style="color: #7F7FFF;">union-overlay-directory</span>=/dev/shm
</pre>
</div>
<p>
を設定しておくと良い(overlayfs で動作します)
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #FF7F7F;">for</span> conf<span style="color: #FF7F7F;"> in</span> $(grep -l &#8217;^union-type=&#8217; /etc/schroot/chroot.d/*-sbuild*); <span style="color: #FF7F7F;">do</span>
    <span style="color: #FF7F7F;">if</span> <span style="color: #7FFFFF; font-weight: bold;">!</span> grep -q <span style="color: #7FFF7F;">"^union-type="</span> <span style="color: #7FFF7F;">"$conf"</span> ; <span style="color: #FF7F7F;">then</span>
        <span style="color: #7FBFFF;">echo</span>  <span style="color: #7FFF7F;">'union-type=overlay'</span> | sudo tee  --append <span style="color: #7FFF7F;">"$conf"</span>
        <span style="color: #7FBFFF;">echo</span> &#8217;union-overlay-directory=/dev/shm&#8217; | sudo tee --append <span style="color: #7FFF7F;">"$conf"</span>
    <span style="color: #FF7F7F;">fi</span>
<span style="color: #FF7F7F;">done</span>
</pre>
</div>
<p>
sbuild の設定は <code>~/.sbuildrc</code> に書いておく.
末尾にあるのでそちらを参照のこと．
</p>
</div>
</div>
</div>
<div id="outline-container-org590e009" class="outline-2">
<h2 id="org590e009"><a id="ID-0b5136f9-4bea-4417-849a-96f5f95b6504"></a><code>lintian</code>: パッケージの品質のチェック</h2>
<div class="outline-text-2" id="text-org590e009">
<p>
作成したパッケージが Debian Policy に準拠しているかを
チェックするパッケージである lintian を導入.
</p>
<pre class="example">
% sudo apt-get install lintian
</pre>
<p>
設定は以下の通り. <code>pedantic</code> と <code>info</code> は, まあ趣味でしょうか.
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #7F7FFF;">display-info</span> = yes
<span style="color: #7F7FFF;">pedantic</span> = yes
<span style="color: #7F7FFF;">color</span> = auto
<span style="color: #7F7FFF;">show-overrides</span> = yes
</pre>
</div>

<p>
sbuild からの呼び出しは <code>~/.sbuildrc</code> において
</p>
<div class="org-src-container">
<pre class="src src-perl"><span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">lintinan</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; lintian &#12434;&#36208;&#12425;&#12379;&#12427;</span>
$<span style="color: #7F7FFF;">run_lintian</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">lintian &#12398; option. &#12362;&#22909;&#12415;&#12391;&#12290;</span>
$<span style="color: #7F7FFF;">lintian_opts</span> = [<span style="color: #7FFF7F;">'-i'</span>, <span style="color: #7FFF7F;">'-I'</span>];
</pre>
</div>
<p>
とでもしておくと良いだろう.
</p>
</div>
</div>
<div id="outline-container-orgd973f90" class="outline-2">
<h2 id="orgd973f90"><a id="ID-bcb9e308-7a2d-4bab-8876-30b8eedaf43c"></a><code>piuparts</code>: パッケージとしてのテスト</h2>
<div class="outline-text-2" id="text-orgd973f90">
<p>
ビルドしたパッケージについて
インストール, アップグレード, リムーブ, パージのテストを行なえる
piuparts を導入しておく.
</p>
<pre class="example">
% sudo apt-get install piuparts
</pre>
<p>
実際の呼び出しは sbuild から行なう.
</p>
<div class="org-src-container">
<pre class="src src-perl"><span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">piuparts</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; piuparts &#12434;&#36208;&#12425;&#12379;&#12427;</span>
$<span style="color: #7F7FFF;">run_piuparts</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">piuparts &#12398; option&#12290;&#12371;&#12371;&#12391;&#12399; sbuild &#29992;&#12395;&#20316;&#25104;&#12375;&#12383; schroot &#12391;&#36208;&#12425;&#12379;&#12427;</span>
$<span style="color: #7F7FFF;">piuparts_opts</span> = [<span style="color: #7FFF7F;">'-N'</span>, <span style="color: #7FFF7F;">'-d'</span>, <span style="color: #7FFF7F;">'%r'</span>, <span style="color: #7FFF7F;">'--keep-sources-list'</span>, <span style="color: #7FFF7F;">'--schroot'</span>, <span style="color: #7FFF7F;">'%r-%a-sbuild'</span>];
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">root_args</span>
$<span style="color: #7F7FFF;">piuparts_root_args</span> = [<span style="color: #7FFF7F;">'sudo'</span>, <span style="color: #7FFF7F;">'--'</span>];
</pre>
</div>
</div>
</div>
<div id="outline-container-org923b744" class="outline-2">
<h2 id="org923b744"><a id="ID-d2393bd8-c286-44ad-a23a-b50893ee82f3"></a><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</h2>
<div class="outline-text-2" id="text-org923b744">
<p>
autopkgtest パッケージを導入しておく.
</p>
</div>
<div id="outline-container-org336e175" class="outline-3">
<h3 id="org336e175">初期設定</h3>
<div class="outline-text-3" id="text-org336e175">
<p>
autopkgtest 環境として, schroot を使うか lxc を使うか, がある.
当然ながら schroot の方が overhead が少ないのだが,
<a href="https://ci.debian.net/">Debian Continuous Integration</a> での動作テストもあるので,
debci に揃えることに.
</p>

<p>
LXC の基本設定や dnsmasq での DHCP 取得ができるようになっていると,
あとは debci setup で良い&#x2026;のだと思う. <strong>本来は</strong>
</p>
<pre class="example">
% sudo apt install debci
% sudo MIRROR="http://dennou-k.gfd-dennou.org/debian" \
   debci setup -s unstable --backend lxc -a amd64
</pre>
<p>
ここではまった.
</p>
<ul class="org-ul">
<li>今使っている環境が btrfs</li>
<li>debci setup → autopkgtest-build-lxc が呼ばれる</li>
<li>autopkgtest-build-lxc では lxc-create で "-B best" が呼ばれている</li>
<li>btrfs と lxc-destroy に関するバグ? なのか, コンテナの差分更新後 lxc-destroy ができずに失敗する</li>
</ul>
<p>
というオチに.
</p>

<p>
結局
</p>
<div class="org-src-container">
<pre class="src src-diff"><span style="font-weight: bold;">--- </span><span style="font-weight: bold;">/usr/bin/autopkgtest-build-lxc.orig</span><span style="font-weight: bold;"> 2017-09-07 20:15:12.615081394 +0900</span>
<span style="font-weight: bold;">+++ </span><span style="font-weight: bold;">/usr/bin/autopkgtest-build-lxc</span><span style="font-weight: bold;">  2017-09-07 20:16:31.584016755 +0900</span>
<span style="font-weight: bold;">@@ -150,14 +150,14 @@</span>

 if [ ! -e $LXCDIR/$NAME ]; then
     # first-time run: just create the container
-    $LXC_CREATE_PREFIX lxc-create -B best --name=$NAME $LXC_ARGS
+    $LXC_CREATE_PREFIX lxc-create --name=$NAME $LXC_ARGS
     setup $NAME
 else
     # remove LXC rootfs caches; on btrfs this might be a subvolume, otherwise
     # rm it
     btrfs subvolume delete /var/cache/lxc/$RELEASE/rootfs-* 2&gt;/dev/null || rm -rf /var/cache/lxc/$RELEASE/rootfs-*
     # create a new rootfs in a temp container
-    $LXC_CREATE_PREFIX lxc-create -B best --name=${NAME}.new $LXC_ARGS
+    $LXC_CREATE_PREFIX lxc-create --name=${NAME}.new $LXC_ARGS
     setup ${NAME}.new
     sed -i "s/${NAME}.new/${NAME}/" $LXCDIR/${NAME}.new/rootfs/etc/hostname $LXCDIR/${NAME}.new/rootfs/etc/hosts
     # replace the original rootfs; can't make this more atomic unfortunately
</pre>
</div>
<p>
なんて事をして,
</p>
<pre class="example">
% sudo dpkg-divert \
  --divert /usr/bin/autopkgtest-build-lxc.orig
  --rename /usr/bin/autopkgtest-build-lxc
</pre>
<p>
としてお茶を濁す.
</p>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 設定ファイルがあったらそっちを優先して欲しいのだが.</li>
</ul>
</div>
</div>
<div id="outline-container-org5d833fe" class="outline-3">
<h3 id="org5d833fe">sbuild からの呼び出し</h3>
<div class="outline-text-3" id="text-org5d833fe">
<p>
面倒なのは lxc を使う場合には <code>stretch</code>, <code>buster</code>, <code>sid</code> とコードネームなのに対して,
sbuild/schroot の release は <code>unstable</code> だったりするところ.
</p>

<p>
sbuild 自体にも autopkgtest の呼び出しはあるが, ここでは external<sub>commands</sub> で
呼び出すことにする.
</p>
<div class="org-src-container">
<pre class="src src-perl"><span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">autopkgtest</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; autopkgtest &#12398;&#23455;&#34892; &#8658; &#23455;&#34892;&#12375;&#12394;&#12356;. post-build-commands &#12391;&#23455;&#34892;</span>
$<span style="color: #7F7FFF;">run_autopkgtest</span> = 0;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">sbuild &#29992;&#12395;&#20316;&#25104;&#12375;&#12383; schroot &#12391;&#36208;&#12425;&#12379;&#12427;&#22580;&#21512;&#12399;&#20197;&#19979;&#12434;&#26377;&#21177;&#12395;</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">$autopkgtest_opts = ['-U', '--', 'schroot', '%r-%a-sbuild'];</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">$autopkgtest_root_args = ['sudo', '--'];</span>
</pre>
</div>
<p>
外部コマンドの呼び出しは以下
</p>
<div class="org-src-container">
<pre class="src src-perl"><span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">&#22806;&#37096;&#12473;&#12463;&#12522;&#12503;&#12488;&#12391; autopkgtest, rdepends &#12398; autopkgstest</span>
$<span style="color: #7F7FFF;">external_commands</span> = {
                      <span style="color: #7FFF7F;">'post-build-commands'</span> =&gt;
                      [<span style="color: #7FFF7F;">'/home/uwabami/.sbuild.d/sbuild-debci-rdepends %c %e'</span>],
                     };
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfd061e9" class="outline-2">
<h2 id="orgfd061e9"><code>~/.sbuildrc</code></h2>
<div class="outline-text-2" id="text-orgfd061e9">
<p>
現在の <code>~/.sbuildrc</code> は以下の通り
</p>
<div class="org-src-container">
<pre class="src src-perl"><span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">-*- mode: cperl -*-</span>
<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">basic</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">architecture: all &#12418; build &#12377;&#12427;</span>
$<span style="color: #7F7FFF;">build_arch_all</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">&#12487;&#12501;&#12457;&#12523;&#12488;&#12391; source packag &#12418; build &#12377;&#12427;</span>
$<span style="color: #7F7FFF;">build_source</span> = 1;

<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">debsign</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">GPG key id</span>
$<span style="color: #7F7FFF;">key_id</span> = <span style="color: #7FFF7F;">'66A4EA704FE240558D6AC2E69394F354891D7E07'</span>;

<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">lintinan</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; lintian &#12434;&#36208;&#12425;&#12379;&#12427;</span>
$<span style="color: #7F7FFF;">run_lintian</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">lintian &#12398; option.</span>
$<span style="color: #7F7FFF;">lintian_opts</span> = [<span style="color: #7FFF7F;">'-i'</span>, <span style="color: #7FFF7F;">'-I'</span>];

<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">piuparts</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; piuparts &#12434;&#36208;&#12425;&#12379;&#12427;</span>
$<span style="color: #7F7FFF;">run_piuparts</span> = 1;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">piuparts &#12398; option. &#12371;&#12371;&#12391;&#12399; sbuild &#29992;&#12395;&#20316;&#25104;&#12375;&#12383; schroot &#12391;&#36208;&#12425;&#12379;&#12427;</span>
$<span style="color: #7F7FFF;">piuparts_opts</span> = [<span style="color: #7FFF7F;">'-N'</span>, <span style="color: #7FFF7F;">'--warn-on-leftovers-after-purge'</span>, <span style="color: #7FFF7F;">'-d'</span>, <span style="color: #7FFF7F;">'%r'</span>, <span style="color: #7FFF7F;">'--keep-sources-list'</span>, <span style="color: #7FFF7F;">'--schroot'</span>, <span style="color: #7FFF7F;">'%r-%a-sbuild'</span>];
$<span style="color: #7F7FFF;">piuparts_root_args</span> = [<span style="color: #7FFF7F;">'sudo'</span>, <span style="color: #7FFF7F;">'--'</span>];

<span style="color: #a5a5a6;">## </span><span style="color: #a5a5a6;">autopkgtest</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">build &#24460;&#12395; autopkgtest &#12398;&#23455;&#34892; &#8658; &#23455;&#34892;&#12375;&#12394;&#12356;. post-build-commands &#12391;&#23455;&#34892;</span>
$<span style="color: #7F7FFF;">run_autopkgtest</span> = 0;
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">sbuild &#29992;&#12395;&#20316;&#25104;&#12375;&#12383; schroot &#12391;&#36208;&#12425;&#12379;&#12427;&#22580;&#21512;&#12399;&#20197;&#19979;&#12434;&#26377;&#21177;&#12395;</span>
$<span style="color: #7F7FFF;">autopkgtest_opts</span> = [<span style="color: #7FFF7F;">'-U'</span>, <span style="color: #7FFF7F;">'--'</span>, <span style="color: #7FFF7F;">'schroot'</span>, <span style="color: #7FFF7F;">'%r-%a-sbuild'</span>];
$<span style="color: #7F7FFF;">autopkgtest_root_args</span> = [<span style="color: #7FFF7F;">'sudo'</span>, <span style="color: #7FFF7F;">'--'</span>];

<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">&#22806;&#37096;&#12473;&#12463;&#12522;&#12503;&#12488;&#12391; autopkgtest, rdepends &#12398; autopkgstest</span>
<span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">$external_commands = {</span>
<span style="color: #a5a5a6;">#                       </span><span style="color: #a5a5a6;">'post-build-commands' =&gt;</span>
<span style="color: #a5a5a6;">#                       </span><span style="color: #a5a5a6;">['/home/uwabami/.sbuild.d/sbuild-debci-rdepends %c %e'],</span>
<span style="color: #a5a5a6;">#                      </span><span style="color: #a5a5a6;">};</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org38e5d92" class="outline-2">
<h2 id="org38e5d92"><code>~/.sbuild.d/sbuild-debci-rdepends</code></h2>
<div class="outline-text-2" id="text-org38e5d92">
<p>
post-build-commands で呼び出す autopkgtest の呼び出しは以下
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a5a5a6;">#</span><span style="color: #a5a5a6;">!/bin/</span><span style="color: #FF7F7F;">sh</span>

<span style="color: #BF7FFF;">highlight</span>() {
    <span style="color: #7F7FFF;">msg</span>=<span style="color: #7FFF7F;">"$@"</span>
    printf <span style="color: #7FFF7F;">"\033[01;33m${msg}\033[m\n"</span>
}

<span style="color: #BF7FFF;">banner</span>() {
    highlight <span style="color: #7FFF7F;">"================================================="</span>
    highlight <span style="color: #7FFF7F;">"= %s"</span> <span style="color: #7FFF7F;">"$@"</span>
    highlight <span style="color: #7FFF7F;">"================================================="</span>
    <span style="color: #7FBFFF;">echo</span> <span style="color: #a5a5a6;"># </span><span style="color: #a5a5a6;">blank line</span>
}
<span style="color: #BF7FFF;">warning</span>() {
    <span style="color: #7F7FFF;">msg</span>=<span style="color: #7FFF7F;">"$@"</span>
    printf <span style="color: #7FFF7F;">"\n"</span>
    printf <span style="color: #7FFF7F;">"\033[0;37;41mWARNING: ${msg}\033[m\n"</span>
    printf <span style="color: #7FFF7F;">"\n"</span>
    <span style="color: #FF7F7F;">exit</span> 1
}

<span style="color: #7F7FFF;">debs</span>=<span style="color: #7FFF7F;">"$(dcmd --deb $1)"</span>
<span style="color: #7F7FFF;">binaries</span>=<span style="color: #7FFF7F;">"$(for p in `dcmd --package $1 | sort -u ` ; do basename $p ; done)"</span>
<span style="color: #7F7FFF;">rdeps</span>=<span style="color: #7FFF7F;">"$(chdist apt-cache unstable rdepends $binaries | sed -e '/^\s/!d; s/|//' | sort -u | xargs chdist apt-cache unstable show | grep-dctrl -s Package,Source '' | awk '{ if ($1=="Package:") { pkg = $2 }; if ($1=="Source:") { pkg = $2 }; if ($1=="") { print(pkg) } } END { print(pkg) }' | sort -u | grep -v "^${source}\$")"</span>
<span style="color: #7F7FFF;">arch_dist</span>=$( <span style="color: #7FBFFF;">echo</span> $<span style="color: #7F7FFF;">6</span> | sed -e <span style="color: #7FFF7F;">'s/-sbuild-.*//g'</span>)

<span style="color: #FF7F7F;">case</span> $<span style="color: #7F7FFF;">arch_dist</span><span style="color: #FF7F7F;"> in</span>
    unstable-amd64*)
        <span style="color: #7F7FFF;">ad</span>=sid-amd64
        ;;
    testing-amd64*)
        <span style="color: #7F7FFF;">ad</span>=buster-amd64
        ;;
    stable-amd64*)
        <span style="color: #7F7FFF;">ad</span>=stretch-amd64
        ;;
    unstable-i386*)
        <span style="color: #7F7FFF;">ad</span>=sid-386
        ;;
    testing-i3864*)
        <span style="color: #7F7FFF;">ad</span>=buster-i386
        ;;
    stable-i3864*)
        <span style="color: #7F7FFF;">ad</span>=stretch-i386
        ;;
    *)
        warning <span style="color: #7FFF7F;">"Unknown test suite "</span>
        <span style="color: #FF7F7F;">exit</span> 1
        ;;
<span style="color: #FF7F7F;">esac</span>

<span style="color: #7F7FFF;">rc</span>=0
autopkgtest --user debci $<span style="color: #7F7FFF;">1</span> -- lxc --sudo autopkgtest-$<span style="color: #7F7FFF;">ad</span> || <span style="color: #7F7FFF;">rc</span>=$<span style="color: #7F7FFF;">?</span>
<span style="color: #FF7F7F;">if</span> [ $<span style="color: #7F7FFF;">rc</span> -ne 0 -a $<span style="color: #7F7FFF;">rc</span> -ne 2 -a $<span style="color: #7F7FFF;">rc</span> -ne 8 ]; <span style="color: #FF7F7F;">then</span>
    warning <span style="color: #7FFF7F;">"Tests for $1 failed! Please verify before uploading"</span>
    <span style="color: #FF7F7F;">exit</span> 1
<span style="color: #FF7F7F;">fi</span>

<span style="color: #FF7F7F;">if</span> [ -n <span style="color: #7FFF7F;">"$rdeps"</span> ]; <span style="color: #FF7F7F;">then</span>
    banner <span style="color: #7FFF7F;">"Found reverse dependencies!"</span>
    printf <span style="color: #7FFF7F;">"Reverse dependencies: "</span>
    <span style="color: #7FBFFF;">echo</span> <span style="color: #7FFF7F;">"$rdeps"</span> | xargs echo
    <span style="color: #7FBFFF;">echo</span>
    <span style="color: #FF7F7F;">for</span> pkg<span style="color: #FF7F7F;"> in</span> $<span style="color: #7F7FFF;">rdeps</span>; <span style="color: #FF7F7F;">do</span>
        <span style="color: #FF7F7F;">if</span> chdist apt-cache unstable showsrc <span style="color: #7FFF7F;">"$pkg"</span> | grep -q ^Testsuite:; <span style="color: #FF7F7F;">then</span>
            <span style="color: #7F7FFF;">rc</span>=0
            autopkgtest --user debci $<span style="color: #7F7FFF;">debs</span> <span style="color: #7FFF7F;">"$pkg"</span> -- lxc --sudo autopkgtest-$<span style="color: #7F7FFF;">ad</span> || <span style="color: #7F7FFF;">rc</span>=$<span style="color: #7F7FFF;">?</span>
            <span style="color: #FF7F7F;">if</span> [ $<span style="color: #7F7FFF;">rc</span> -ne 0 -a $<span style="color: #7F7FFF;">rc</span> -ne 2 -a $<span style="color: #7F7FFF;">rc</span> -ne 8 ]; <span style="color: #FF7F7F;">then</span>
                <span style="color: #7F7FFF;">failed_rdeps</span>=<span style="color: #7FFF7F;">"$failed_rdeps $pkg"</span>
            <span style="color: #FF7F7F;">fi</span>
        <span style="color: #FF7F7F;">else</span>
            <span style="color: #7FBFFF;">echo</span> <span style="color: #7FFF7F;">"I: ${pkg} does not declare a DEP-8 test suite. Maybe try a manual test5A"</span>
        <span style="color: #FF7F7F;">fi</span>
    <span style="color: #FF7F7F;">done</span>
    <span style="color: #FF7F7F;">for</span> pkg<span style="color: #FF7F7F;"> in</span> $<span style="color: #7F7FFF;">failed_rdeps</span>; <span style="color: #FF7F7F;">do</span>
        warning <span style="color: #7FFF7F;">"Tests for $pkg failed! Please verify before uploading"</span>
        <span style="color: #FF7F7F;">exit</span> 1
    <span style="color: #FF7F7F;">done</span>
<span style="color: #FF7F7F;">else</span>
    <span style="color: #7FBFFF;">echo</span> <span style="color: #7FFF7F;">"I: no reverse dependencies found"</span>
<span style="color: #FF7F7F;">fi</span>
</pre>
</div>
</div>
</div>
