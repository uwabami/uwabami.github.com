---
title: パッケージ作成環境&#58; sbuild, lintian, piuparts, autopkgtest
date: 2017-02-27 14:31:26
layout: cc-env
lang: ja
ref: cc-env/DebianPackaging
permalink: /cc-env/DebianPackaging.html
---
<div id="toc-wrapper">
<nav id="table-of-contents">
<h2>&#30446;&#27425;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga984f73">はじめに</a></li>
<li><a href="#org6bb6b14"><code>sbuild</code>: clean room build 環境</a>
<ul>
<li><a href="#org58ae8dd">インストールと設定</a></li>
</ul>
</li>
<li><a href="#org590e009"><code>lintian</code>: パッケージの品質のチェック</a></li>
<li><a href="#orgd973f90"><code>piuparts</code>: パッケージとしてのテスト</a></li>
<li><a href="#org923b744"><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</a></li>
</ul>
</div>
</nav>
</div>
<a href="#toc-toggle" class="btn toc-btn" id="toc-toggle">&#30446;&#27425;</a>
<p>
Related <a href='index.html'>Index</a> <a href="index.html#ID-591f6b0d-55ff-48eb-b095-401cdfa0d536">Debian</a>
</p>
<div id="outline-container-orga984f73" class="outline-2">
<h2 id="orga984f73">はじめに</h2>
<div class="outline-text-2" id="text-orga984f73">
<p>
Debian パッケージを作成するため
</p>
<ul class="org-ul">
<li><a href="#org6bb6b14"><code>sbuild</code>: clean room build 環境</a> :ビルド時の依存環境をテストしつつビルドする</li>
<li><a href="#org590e009"><code>lintian</code>: パッケージの品質のチェック</a></li>
<li><a href="#orgd973f90"><code>piuparts</code>: パッケージとしてのテスト</a></li>
<li><a href="#org923b744"><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</a></li>
</ul>
<p>
ができるようにする.
今は sbuild の chroot 環境可ですが,
そのうち lxc を使ってそちらに投げるようにしたい.
</p>
</div>
</div>
<div id="outline-container-org6bb6b14" class="outline-2">
<h2 id="org6bb6b14"><a id="ID-74d27536-cf49-4780-8b6d-2e7b22027785"></a><code>sbuild</code>: clean room build 環境</h2>
<div class="outline-text-2" id="text-org6bb6b14">
<p>
clean room build 環境としては
</p>
<ul class="org-ul">
<li>pbuilder/cowbuilder/qemubuilder</li>
<li>sbuild</li>
</ul>
<p>
の二通りがあります. どちらが良いのか, は完全に好みの問題だと思いますが
Debian 公式のビルドインフラが sbuild なので, 私は sbuild を使っています.
sbuild に関しては <a href="https://wiki.debian.org/sbuild">sbuild - Debian Wiki</a> を参照下さい.
</p>
</div>
<div id="outline-container-org58ae8dd" class="outline-3">
<h3 id="org58ae8dd">インストールと設定</h3>
<div class="outline-text-3" id="text-org58ae8dd">
<p>
ほぼ, 上述の wiki の通り
</p>
<pre class="example">
sudo apt-get install sbuild
sudo sbuild-adduser $LOGNAME
newgrp sbuild
</pre>
<p>
chroot の作成は以下
</p>
<div class="org-src-container">
<pre class="src src-sh">for a in amd64 i386; do
  for d in stable testing unstable ; do
    sudo LANG=C sbuild-createchroot --arch=$a --include=eatmydata,gnupg $d \
        /srv/chroot/$d-$a-sbuild http://dennou-k.gfd-dennou.org/debian
  done
done
</pre>
</div>
<p>
これで, <code>/srv/chroot/</code> 以下に sbuild 用の chroot 環境ができる.
ついでに <code>/etc/schroot/chroot.d/</code> 以下に sbuild 用の設定ファイルができるので,
</p>
<div class="org-src-container">
<pre class="src src-conf">union-type=overlay
</pre>
</div>
<p>
を設定しておくと良い(overlayfs で動作する):
</p>
<div class="org-src-container">
<pre class="src src-sh">for conf in $(grep -l ’^union-type=’ /etc/schroot/chroot.d/*-sbuild*); do
    if ! grep -q "^union-overlay-directory=" "$conf" ; then
        echo ’union-overlay-directory=/dev/shm’ | sudo tee --append "$conf"
    fi
done
</pre>
</div>
<p>
sbuild の設定は <code>~/.sbuildrc</code> に以下の通りに書いておく
</p>
<div class="org-src-container">
<pre class="src src-conf"># -*- mode: cperl -*-
## basic
# architecture: all も build する
$build_arch_all = 1;
# デフォルトで source packag も build する
$build_source = 1;
## debsign
# GPG key id
$key_id = '66A4EA704FE240558D6AC2E69394F354891D7E07';
## lintinan
# build 後に lintian を走らせる
$run_lintian = 1;
# lintian の option. お好みで。
$lintian_opts = ['-i', '-I'];
## piuparts
# build 後に piuparts を走らせる
$run_piuparts = 0;
# piuparts の option。ここでは schroot で走らせる
$piuparts_opts = ['-N', '-d', '%r', '--keep-sources-list', '--schroot', '%r-%a-sbuild'];
#
$piuparts_root_args = ['sudo', '--'];
## autopkgtest
# build 後に autopkgtest を実行する
$run_autopkgtest = 1;
# option
# $autopkgtest_opts = ['--user', 'debci', '-U', '--', 'lxc', 'adt-sid-%a'];
$autopkgtest_opts = ['-U', '--', 'schroot', '%r-%a-sbuild'];
# root_args
$autopkgtest_root_args = ['sudo', '--'];
# #
# # autopkgtest
# $external_commands =
#   {
#    'post-build-commands' =&gt;
#    [
#     [
#      'autopkgtest', '--user', 'debci', '-U', '%d',
#      '--', 'lxc', 'adt-sid-%a;',
#      # '%c',
#      # if autopkgtest's exit code is 8 then the package had no tests
#      # but this isn't a failure, so catch it
#      'aptexit=$?;',
#      'if', 'test', '$aptexit', '=', '8;', 'then',
#      'exit', '0;', 'else', 'exit', '$aptexit;', 'fi'
#     ],
#    ],
#   };
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org590e009" class="outline-2">
<h2 id="org590e009"><a id="ID-0b5136f9-4bea-4417-849a-96f5f95b6504"></a><code>lintian</code>: パッケージの品質のチェック</h2>
<div class="outline-text-2" id="text-org590e009">
<p>
作成したパッケージが Debian Policy に準拠しているかを
チェックするパッケージである lintian を導入します.
</p>
<pre class="example">
% sudo apt-get install lintian
</pre>
<p>
設定は以下の通り. <code>pedantic</code> と <code>info</code> は, まあ趣味でしょうか.
</p>
<div class="org-src-container">
<pre class="src src-conf">display-info = yes
pedantic = yes
color = auto
show-overrides = yes
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd973f90" class="outline-2">
<h2 id="orgd973f90"><a id="ID-bcb9e308-7a2d-4bab-8876-30b8eedaf43c"></a><code>piuparts</code>: パッケージとしてのテスト</h2>
<div class="outline-text-2" id="text-orgd973f90">
<p>
ビルドしたパッケージについて
インストール, アップグレード, リムーブ, パージのテストを行なえる
piuparts を導入しておく.
</p>
<pre class="example">
% sudo apt-get install piuparts
</pre>
<p>
実際の呼び出しは sbuild で行なうので, 特に設定していない
</p>
</div>
</div>
<div id="outline-container-org923b744" class="outline-2">
<h2 id="org923b744"><a id="ID-d2393bd8-c286-44ad-a23a-b50893ee82f3"></a><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</h2>
<div class="outline-text-2" id="text-org923b744">
<p>
autopkgtest パッケージを導入しておく.
テスト環境は sbuild で作成した chroot を使う.
呼び出しも sbuild から行なうので, 特に別途設定はしていない.
</p>
</div>
</div>
