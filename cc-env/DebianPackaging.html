<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>パッケージ作成環境: sbuild, lintian, piuparts, autopkgtest</title>
<meta name="description" content="My Interest: Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian">
<link rel="stylesheet" href="/css/main.css" >
<link rel="canonical" href="/cc-env/DebianPackaging.html">

<link rel="alternate" hreflang="ja" href="/cc-env/DebianPackaging.html" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
    <script src="/assets/js/html5shiv.min.js"></script>
    <script src="/assets/js/respond.min.js"></script>
<![endif]-->
<link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="/css/cc-env.css" >
  </head>
  <body>
    <span id="page-top"></span>
    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/index.html">Youhei SASAKI's official site</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
        
        <li><a class="page-link" href="/research/index.html">Research</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Software<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="/software/index.html">Repository</a></li>
            <li><a href="/cc-env/index.html">Computer Memo</a></li>
          </ul>
        </li>
        <li><a class="page-link" href="https://uwabami.junkhub.org/log">Blog</a></li>
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
        
          
        
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

    <div class="container">
      <div class="content">
        <div class="row">
          <div class="page-header col-xs-12">
            
            <h1>パッケージ作成環境: sbuild, lintian, piuparts, autopkgtest</h1>
            
            <ul class="breadcrumb">
  
  <li><a href="/index.html">Top</a></li>
  
  
    
    
      
  <li><a href="/cc-env/index.html">Cc-env</a></li>
      
    
  
    
    
  
</ul>

          </div>
          <div class="col-xs-12">
            <p>Related <a href="wiki:index">Index</a> <a href="id:591f6b0d-55ff-48eb-b095-401cdfa0d536">Debian</a></p>
<h2><a id="はじめに"><span class='anchor'>_</span></a>はじめに</h2>
<p>Debian パッケージを作成するため</p>
<ul>
  <li><a href="id:74d27536-cf49-4780-8b6d-2e7b22027785">=sbuild=: clean room build 環境</a> :ビルド時の依存環境をテストしつつビルドする</li>
  <li><a href="id:0b5136f9-4bea-4417-849a-96f5f95b6504">=lintian=: パッケージの品質のチェック</a></li>
  <li><a href="id:bcb9e308-7a2d-4bab-8876-30b8eedaf43c">=piuparts=: パッケージとしてのテスト</a></li>
  <li><a href="id:d2393bd8-c286-44ad-a23a-b50893ee82f3">=autopkgtest=: ビルドしたバイナリの実行テスト</a></li>
</ul>
<p>ができるようにしておきます.</p>
<h2><a id="=sbuild=: clean room build 環境"><span class='anchor'>_</span></a><code>sbuild</code>: clean room build 環境</h2>clean room build 環境としては
<ul>
  <li>pbuilder/cowbuilder/qemubuilder</li>
  <li>sbuild</li>
</ul>
<p>の二通りがあります. どちらが良いのか, は完全に好みの問題だと思いますが
  Debian 公式のビルドインフラが sbuild なので, 私は sbuild を使っています.
  sbuild に関しては <a href="https://wiki.debian.org/sbuild">sbuild - Debian Wiki</a> を参照下さい.</p>
<ul>
  <li>[ ] sbuild の build 環境に lxc って使えたりしないかな&#8230;?</li>
</ul>
<h3><a id="インストールと設定"><span class='anchor'>_</span></a>インストールと設定</h3>
<p>ほぼ, 上述の wiki の通り:</p>
<pre class="example">
sudo apt-get install sbuild
sudo sbuild-adduser $LOGNAME
newgrp sbuild
</pre>
<p>chroot の作成は以下</p>
<div class="highlight"><pre><span></span><span class="k">for</span> a in amd64 i386<span class="p">;</span> <span class="k">do</span>
  <span class="k">for</span> d in stable testing unstable <span class="p">;</span> <span class="k">do</span>
    sudo <span class="nv">LANG</span><span class="o">=</span>C sbuild-createchroot --arch<span class="o">=</span><span class="nv">$a</span> --include<span class="o">=</span>eatmydata,gnupg <span class="nv">$d</span> <span class="se">\</span>
        /srv/chroot/<span class="nv">$d</span>-<span class="nv">$a</span>-sbuild http://dennou-k.gfd-dennou.org/debian
  <span class="k">done</span>
<span class="k">done</span>
</pre></div>
<p>これで, <code>/srv/chroot/</code> 以下に sbuild 用の chroot 環境ができる.
  ついでに <code>/etc/schroot/chroot.d/</code> 以下に sbuild 用の設定ファイルができるので,</p>
<div class="highlight"><pre><span></span><span class="n">union</span><span class="o">-</span><span class="n">type</span><span class="o">=</span><span class="n">overlay</span>
<span class="n">union</span><span class="o">-</span><span class="n">overlay</span><span class="o">-</span><span class="n">directory</span><span class="o">=</span><span class="sr">/dev/s</span><span class="n">hm</span>
</pre></div>
<p>を設定しておくと良い(overlayfs で動作します)</p>
<div class="highlight"><pre><span></span><span class="k">for</span> conf in <span class="k">$(</span>grep -l ’^union-type<span class="o">=</span>’ /etc/schroot/chroot.d/*-sbuild*<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> ! grep -q <span class="s2">&quot;^union-type=&quot;</span> <span class="s2">&quot;</span><span class="nv">$conf</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span>  <span class="s1">&#39;union-type=overlay&#39;</span> <span class="p">|</span> sudo tee  --append <span class="s2">&quot;</span><span class="nv">$conf</span><span class="s2">&quot;</span>
        <span class="nb">echo</span> ’union-overlay-directory<span class="o">=</span>/dev/shm’ <span class="p">|</span> sudo tee --append <span class="s2">&quot;</span><span class="nv">$conf</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
<p>sbuild の設定は <code>~/.sbuildrc</code> に書いておく.
  末尾にあるのでそちらを参照のこと．</p>
<h2><a id="=lintian=: パッケージの品質のチェック"><span class='anchor'>_</span></a><code>lintian</code>: パッケージの品質のチェック</h2>作成したパッケージが Debian Policy に準拠しているかを
  チェックするパッケージである lintian を導入.
<pre class="example">
% sudo apt-get install lintian
</pre>
<p>設定は以下の通り. <code>pedantic</code> と <code>info</code> は, まあ趣味でしょうか.</p>
<p>sbuild からの呼び出しは <code>~/.sbuildrc</code> において</p>
<div class="highlight"><pre><span></span><span class="c1">## lintinan</span>
<span class="c1"># build 後に lintian を走らせる</span>
<span class="nv">$run_lintian</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1"># lintian の option. お好みで。</span>
<span class="nv">$lintian_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-i&#39;</span><span class="p">,</span> <span class="s">&#39;-I&#39;</span><span class="p">];</span>
</pre></div>
<p>とでもしておくと良いだろう.</p>
<h2><a id="=piuparts=: パッケージとしてのテスト"><span class='anchor'>_</span></a><code>piuparts</code>: パッケージとしてのテスト</h2>ビルドしたパッケージについて
  インストール, アップグレード, リムーブ, パージのテストを行なえる
  piuparts を導入しておく.
<pre class="example">
% sudo apt-get install piuparts
</pre>
<p>実際の呼び出しは sbuild から行なう.</p>
<div class="highlight"><pre><span></span><span class="c1">## piuparts</span>
<span class="c1"># build 後に piuparts を走らせる</span>
<span class="nv">$run_piuparts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1"># piuparts の option。ここでは sbuild 用に作成した schroot で走らせる</span>
<span class="nv">$piuparts_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-N&#39;</span><span class="p">,</span> <span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;%r&#39;</span><span class="p">,</span> <span class="s">&#39;--keep-sources-list&#39;</span><span class="p">,</span> <span class="s">&#39;--schroot&#39;</span><span class="p">,</span> <span class="s">&#39;%r-%a-sbuild&#39;</span><span class="p">];</span>
<span class="c1"># root_args</span>
<span class="nv">$piuparts_root_args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;sudo&#39;</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">];</span>
</pre></div>
<h2><a id="=autopkgtest=: ビルドしたバイナリの実行テスト"><span class='anchor'>_</span></a><code>autopkgtest</code>: ビルドしたバイナリの実行テスト</h2>autopkgtest パッケージを導入しておく.
<h3><a id="初期設定"><span class='anchor'>_</span></a>初期設定</h3>
<p>autopkgtest 環境として, schroot を使うか lxc を使うか, がある.
  当然ながら schroot の方が overhead が少ないのだが,
  <a href="https://ci.debian.net/">Debian Continuous Integration</a> での動作テストもあるので,
  debci に揃えることに.</p>
<p>LXC の基本設定や dnsmasq での DHCP 取得ができるようになっていると,
  あとは debci setup で良い&#8230;のだと思う. <strong>本来は</strong></p>
<pre class="example">
% sudo apt install debci
% sudo MIRROR=&quot;http://dennou-k.gfd-dennou.org/debian&quot; \
   debci setup -s unstable --backend lxc -a amd64
</pre>
<p>ここではまった.</p>
<ul>
  <li>今使っている環境が btrfs</li>
  <li>debci setup → autopkgtest-build-lxc が呼ばれる</li>
  <li>autopkgtest-build-lxc では lxc-create で &#8220;-B best&#8221; が呼ばれている</li>
  <li>btrfs と lxc-destroy に関するバグ? なのか, コンテナの差分更新後 lxc-destroy ができずに失敗する</li>
</ul>
<p>というオチに.</p>
<p>結局</p>
<div class="highlight"><pre><span></span><span class="gd">--- /usr/bin/autopkgtest-build-lxc.orig	2017-09-07 20:15:12.615081394 +0900</span>
<span class="gi">+++ /usr/bin/autopkgtest-build-lxc	2017-09-07 20:16:31.584016755 +0900</span>
<span class="gu">@@ -150,14 +150,14 @@</span>

 if [ ! -e $LXCDIR/$NAME ]; then
     # first-time run: just create the container
<span class="gd">-    $LXC_CREATE_PREFIX lxc-create -B best --name=$NAME $LXC_ARGS</span>
<span class="gi">+    $LXC_CREATE_PREFIX lxc-create --name=$NAME $LXC_ARGS</span>
     setup $NAME
 else
     # remove LXC rootfs caches; on btrfs this might be a subvolume, otherwise
     # rm it
     btrfs subvolume delete /var/cache/lxc/$RELEASE/rootfs-* 2&gt;/dev/null || rm -rf /var/cache/lxc/$RELEASE/rootfs-*
     # create a new rootfs in a temp container
<span class="gd">-    $LXC_CREATE_PREFIX lxc-create -B best --name=$&#123;NAME}.new $LXC_ARGS</span>
<span class="gi">+    $LXC_CREATE_PREFIX lxc-create --name=$&#123;NAME}.new $LXC_ARGS</span>
     setup $&#123;NAME}.new
     sed -i &quot;s/$&#123;NAME}.new/$&#123;NAME}/&quot; $LXCDIR/$&#123;NAME}.new/rootfs/etc/hostname $LXCDIR/$&#123;NAME}.new/rootfs/etc/hosts
     # replace the original rootfs; can&#39;t make this more atomic unfortunately
</pre></div>
<p>なんて事をして,</p>
<pre class="example">
% sudo dpkg-divert \
  --divert /usr/bin/autopkgtest-build-lxc.orig
  --rename /usr/bin/autopkgtest-build-lxc
</pre>
<p>としてお茶を濁す.</p>
<ul>
  <li>[ ] 設定ファイルがあったらそっちを優先して欲しいのだが.</li>
</ul>
<h3><a id="sbuild からの呼び出し"><span class='anchor'>_</span></a>sbuild からの呼び出し</h3>
<p>面倒なのは lxc を使う場合には <code>stretch</code>, <code>buster</code>, <code>sid</code> とコードネームなのに対して,
  sbuild/schroot の release は <code>unstable</code> だったりするところ.</p>
<p>sbuild 自体にも autopkgtest の呼び出しはあるが, ここでは <code>external_commands</code> で
  呼び出すことにする.</p>
<div class="highlight"><pre><span></span><span class="c1">## autopkgtest</span>
<span class="c1"># build 後に autopkgtest の実行 ⇒ 実行しない. post-build-commands で実行</span>
<span class="nv">$run_autopkgtest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1"># sbuild 用に作成した schroot で走らせる場合は以下を有効に</span>
<span class="c1"># $autopkgtest_opts = [&#39;-U&#39;, &#39;--&#39;, &#39;schroot&#39;, &#39;%r-%a-sbuild&#39;];</span>
<span class="c1"># $autopkgtest_root_args = [&#39;sudo&#39;, &#39;--&#39;];</span>
</pre></div>
<p>外部コマンドの呼び出しは以下</p>
<div class="highlight"><pre><span></span><span class="c1"># 外部スクリプトで autopkgtest, rdepends の autopkgstest</span>
<span class="nv">$external_commands</span> <span class="o">=</span> <span class="p">&#123;</span>
                      <span class="s">&#39;post-build-commands&#39;</span> <span class="o">=&gt;</span>
                      <span class="p">[</span><span class="s">&#39;/home/uwabami/.sbuild.d/sbuild-debci-rdepends %c %e&#39;</span><span class="p">],</span>
                     <span class="p">};</span>
</pre></div>
<h2><a id="=~/.sbuildrc="><span class='anchor'>_</span></a><code>~/.sbuildrc</code></h2>
<p>現在の <code>~/.sbuildrc</code> は以下の通り</p>
<h2><a id="=~/.sbuild.d/sbuild-debci-rdepends="><span class='anchor'>_</span></a><code>~/.sbuild.d/sbuild-debci-rdepends</code></h2>
<p>post-build-commands で呼び出す autopkgtest の呼び出しは以下</p>


          </div>
          <a href="#page-top" class="pagetop btn top-btn">Top</a>
        </div> <!-- /.row -->
      </div> <!-- /.content -->
    </div> <!-- /.container -->
    <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-xs-12">
        <p>
          
          &copy; 2006 - 2018
          <a href="mailto:uwabami@gfd-dennou.org"></a>,
          Lastupdate: 2018-10-16 19:46:16
          <br />
          <span class="generator"> Powered by
            <a href="http://orgmode.org/" target="_blank" title="Org-mode">Org-mode</a>
            +
            <a href="http://jekyllrb.com/" target="_blank" title="Jekyll" >Jekyll</a>
            +
            <a href="http://nkmr6194.github.io/Umi/" target="_blank">Umi</a> &amp;
            <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>
          </span>
        </p>
      </div> <!-- /.col-sm-12 -->
    </div> <!-- /.row -->
  </div> <!-- /.container -->
</footer>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90872419-1', 'auto');
  ga('send', 'pageview');
</script>

    <script src="/assets/js/org-toc.js"></script>
  </body>
</html>
