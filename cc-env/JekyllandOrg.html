---
title: このサイトができるまで
date: 2017-01-16 23:59:32
layout: default
lang: ja
ref: cc-env/JekyllandOrg
permalink: /cc-env/JekyllandOrg.html
---
<div id="outline-container-org7e12038" class="outline-2">
<h2 id="org7e12038">はじめに</h2>
<div class="outline-text-2" id="text-org7e12038">
<div class="alert alert-danger">
<p>
<strong>以下，最近は使っていないので，今でも動くのは定かではありません．patch welcome!</strong>
</p>
</div>

<p>
このサイトは、記事を Emacs の <a href="http://orgmode.org/">Org mode</a> で書いて、
<a href="http://jekyllrb.com/">Jekyll</a> で HTML に変換しています。
<code>org</code> ファイルそのものに(なるべく)手を加えることなく、
それなりに一貫性を持ってコンテンツを作成するために、
幾つかプラグインを書いています。その解説など。
</p>
</div>
</div>
<div id="outline-container-org2983920" class="outline-2">
<h2 id="org2983920">作ったモノ</h2>
<div class="outline-text-2" id="text-org2983920">
<p>
コードの詳細は Github をご覧下さい。
</p>
<ul class="org-ul">
<li><a href="https://github.com/uwabami/jekyll-org-converter">Github::uwabami/jekyll-org-converter</a></li>
</ul>
</div>
</div>
<div id="outline-container-org6c345f8" class="outline-2">
<h2 id="org6c345f8">使い方</h2>
<div class="outline-text-2" id="text-org6c345f8">
<p>
jekyll の <code>_plugin</code> に submodule としてでも放り込んで下さい。
</p>

<p>
org ファイルを html へ出力する際のタグのカスタマイズをしたい場合には、
<code>_html_tags.yml</code> を作成しておきます(リポジトリに example を置いてあります)。
</p>

<p>
原稿となる org ファイルには、最低限
</p>
<div class="org-src-container">
<pre class="src src-org">    #+TITLE:
    #+DATE:
<span style="color: #e5e5e6;">    #+LAYOUT:</span>
</pre>
</div>
<p>
を記載しておいて下さい。これが Jekyll の Front Matter になります。
他にも <code>#+HTML</code> および <code>#+LATEX</code> 以外の Option が書け、
downcase したのち Front Matter として使用できます。
</p>
</div>
</div>
<div id="outline-container-org2b11e04" class="outline-2">
<h2 id="org2b11e04">解説(?)</h2>
<div class="outline-text-2" id="text-org2b11e04">
<p>
解説するようなモンでもないですけれど。
</p>
</div>
<div id="outline-container-org7b06481" class="outline-3">
<h3 id="org7b06481">org ファイルの変換</h3>
<div class="outline-text-3" id="text-org7b06481">
<p>
ファイルの HTML への変換には <a href="https://github.com/wallyqs/org-ruby">wallyqs/org-ruby</a> を使っています。
</p>
<ul class="org-ul">
<li>利点: Emacs の org-exporter のカスタマイズを行なう必要が無い。</li>
<li>利点: jekyll に自然に組み込める</li>
<li>欠点: org-exporter での code block 実行結果の export が使えなくなる</li>
</ul>

<p>
org-exporter による「code block 実行結果の埋め込み」を使いたい場合には、
org-exporter での html 出力をカスタマイズした後に、jekyll で処理することになります。
このアプローチは <a href="http://juanreyero.com/open/org-jekyll/">org-jekyll, export blog posts from org-mode</a> でしょう。
また、Github Pages でコンテンツを公開することを考える場合には、
plugin が使えないため、
リンク先のアプローチを取る必要があります。
</p>

<p>
以前は同様の事を行なっていたのですが、
</p>
<ol class="org-ol">
<li>jekyll を動作させるサーバ上の Emacs のバージョンと手元のバージョンとの乖離</li>
<li>org のファイルと html ファイルの双方をリポジトリで管理する無駄さ</li>
</ol>
<p>
から、結局 org ファイルを直接 jekyll で処理することにしました。
</p>
</div>
</div>
<div id="outline-container-org34845b9" class="outline-3">
<h3 id="org34845b9">org-ruby の拡張(?)</h3>
<div class="outline-text-3" id="text-org34845b9">
<p>
最新の org-ruby では org-mode の search link を export してくれません。
そんな訳で monkey patch です。
<code>Orgmode::HtmlOutputBuffer.inline_formatting</code> が割と大きな method なので、
小さな monkey patch のつもりが、ほぼコピペになってしまいました…。
</p>
<div class="org-src-container">
<pre class="src src-ruby">     <span style="color: #e5e5e6;">#</span><span style="color: #e5e5e6;">! /usr/bin/env ruby</span>
     <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">-*- mode: ruby; coding: utf-8 -*-</span>
     <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">file: org_monkey.rb</span>
     <span style="color: #e5e5e6;">#</span>
     <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">Monkey Patch: Add support org search link</span>
     <span style="color: #7FBFFF;">require</span> <span style="color: #7FFF7F;">'org-ruby'</span>

     <span style="color: #FF7F7F;">module</span> <span style="color: #FFFF7F;">Orgmode</span>
       <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">monkey patch Orgmode::to_html inline_formatter</span>
       <span style="color: #FF7F7F;">class</span> <span style="color: #FFFF7F;">HtmlOutputBuffer</span> &lt; <span style="color: #FFFF7F;">OutputBuffer</span>

         <span style="color: #7FBFFF;">alias_method</span> <span style="color: #FFBF7F;">:_orig_add_line_attributes</span>, <span style="color: #FFBF7F;">:add_line_attributes</span>
         <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">add_line_attributes</span>(headline)
           _orig_add_line_attributes(headline)
           <span style="color: #7F7FFF;">@output</span> &lt;&lt; <span style="color: #7FFF7F;">"&lt;a id=\"</span><span style="color: #7F7FFF;">#{headline.headline_text}</span><span style="color: #7FFF7F;">\"&gt;&lt;span class='anchor'&gt;_&lt;/span&gt;&lt;/a&gt;"</span>
         <span style="color: #FF7F7F;">end</span>

         <span style="color: #7FBFFF;">alias_method</span> <span style="color: #FFBF7F;">:_orig_inline_formatting</span>, <span style="color: #FFBF7F;">:inline_formatting</span>
         <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">inline_formatting</span>(str)
           <span style="color: #7F7FFF;">@re_help</span>.rewrite_emphasis str <span style="color: #FF7F7F;">do</span> |marker, s|
             <span style="color: #FF7F7F;">if</span> marker == <span style="color: #7FFF7F;">"="</span> <span style="color: #FF7F7F;">or</span> marker == <span style="color: #7FFF7F;">"~"</span>
               s = escapeHTML s
               <span style="color: #7FFF7F;">"&lt;</span><span style="color: #7F7FFF;">#{Tags[marker][:open]}</span><span style="color: #7FFF7F;">&gt;</span><span style="color: #7F7FFF;">#{s}</span><span style="color: #7FFF7F;">&lt;/</span><span style="color: #7F7FFF;">#{Tags[marker][:close]}</span><span style="color: #7FFF7F;">&gt;"</span>
             <span style="color: #FF7F7F;">else</span>
               quote_tags(<span style="color: #7FFF7F;">"&lt;</span><span style="color: #7F7FFF;">#{Tags[marker][:open]}</span><span style="color: #7FFF7F;">&gt;"</span>) + s +
                 quote_tags(<span style="color: #7FFF7F;">"&lt;/</span><span style="color: #7F7FFF;">#{Tags[marker][:close]}</span><span style="color: #7FFF7F;">&gt;"</span>)
             <span style="color: #FF7F7F;">end</span>
           <span style="color: #FF7F7F;">end</span>

           <span style="color: #FF7F7F;">if</span> <span style="color: #7F7FFF;">@options</span>[<span style="color: #FFBF7F;">:use_sub_superscripts</span>] <span style="color: #FF7F7F;">then</span>
             <span style="color: #7F7FFF;">@re_help</span>.rewrite_subp str <span style="color: #FF7F7F;">do</span> |type, text|
               <span style="color: #FF7F7F;">if</span> type == <span style="color: #7FFF7F;">"_"</span> <span style="color: #FF7F7F;">then</span>
                 quote_tags(<span style="color: #7FFF7F;">"&lt;sub&gt;"</span>) + text + quote_tags(<span style="color: #7FFF7F;">"&lt;/sub&gt;"</span>)
               <span style="color: #FF7F7F;">elsif</span> type == <span style="color: #7FFF7F;">"^"</span> <span style="color: #FF7F7F;">then</span>
                 quote_tags(<span style="color: #7FFF7F;">"&lt;sup&gt;"</span>) + text + quote_tags(<span style="color: #7FFF7F;">"&lt;/sup&gt;"</span>)
               <span style="color: #FF7F7F;">end</span>
             <span style="color: #FF7F7F;">end</span>
           <span style="color: #FF7F7F;">end</span>

           <span style="color: #7F7FFF;">@re_help</span>.rewrite_links str <span style="color: #FF7F7F;">do</span> |link, defi|
             [link, defi].compact.each <span style="color: #FF7F7F;">do</span> |text|
               <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">We don't support search links right now. Get rid of it.</span>
               <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">-&gt; Support search links!!</span>
               text.sub!(<span style="color: #7FFF7F;">/\A(file:[^\s]+)::([^\s]*?)\Z/</span>, <span style="color: #7FFF7F;">"\\1#\\2"</span>)
               text.sub!(<span style="color: #7FFF7F;">/\Afile:(?=[^\s]+\Z)/</span>, <span style="color: #7FFF7F;">""</span>)
             <span style="color: #FF7F7F;">end</span>

             <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">We don't add a description for images in links, because its</span>
             <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">empty value forces the image to be inlined.</span>
             defi ||= link <span style="color: #FF7F7F;">unless</span> link =~ <span style="color: #7F7FFF;">@re_help</span>.org_image_file_regexp

             <span style="color: #FF7F7F;">if</span> defi =~ <span style="color: #7F7FFF;">@re_help</span>.org_image_file_regexp
               defi = quote_tags <span style="color: #7FFF7F;">"&lt;img src=\"</span><span style="color: #7F7FFF;">#{defi}</span><span style="color: #7FFF7F;">\" alt=\"</span><span style="color: #7F7FFF;">#{defi}</span><span style="color: #7FFF7F;">\" /&gt;"</span>
             <span style="color: #FF7F7F;">end</span>

             <span style="color: #FF7F7F;">if</span> defi
               link = <span style="color: #7F7FFF;">@options</span>[<span style="color: #FFBF7F;">:link_abbrevs</span>][link] <span style="color: #FF7F7F;">if</span> <span style="color: #7F7FFF;">@options</span>[<span style="color: #FFBF7F;">:link_abbrevs</span>].has_key? link
               quote_tags(<span style="color: #7FFF7F;">"&lt;a href=\"</span><span style="color: #7F7FFF;">#{link}</span><span style="color: #7FFF7F;">\"&gt;"</span>) + defi + quote_tags(<span style="color: #7FFF7F;">"&lt;/a&gt;"</span>)
             <span style="color: #FF7F7F;">else</span>
               quote_tags <span style="color: #7FFF7F;">"&lt;img src=\"</span><span style="color: #7F7FFF;">#{link}</span><span style="color: #7FFF7F;">\" alt=\"</span><span style="color: #7F7FFF;">#{link}</span><span style="color: #7FFF7F;">\" /&gt;"</span>
             <span style="color: #FF7F7F;">end</span>
           <span style="color: #FF7F7F;">end</span>

           <span style="color: #FF7F7F;">if</span> <span style="color: #7F7FFF;">@output_type</span> == <span style="color: #FFBF7F;">:table_row</span>
             str.gsub! <span style="color: #7FFF7F;">/^\|\s*/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;td&gt;"</span>)
             str.gsub! <span style="color: #7FFF7F;">/\s*\|$/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;/td&gt;"</span>)
             str.gsub! <span style="color: #7FFF7F;">/\s*\|\s*/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;/td&gt;&lt;td&gt;"</span>)
           <span style="color: #FF7F7F;">end</span>

           <span style="color: #FF7F7F;">if</span> <span style="color: #7F7FFF;">@output_type</span> == <span style="color: #FFBF7F;">:table_header</span>
             str.gsub! <span style="color: #7FFF7F;">/^\|\s*/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;th&gt;"</span>)
             str.gsub! <span style="color: #7FFF7F;">/\s*\|$/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;/th&gt;"</span>)
             str.gsub! <span style="color: #7FFF7F;">/\s*\|\s*/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;/th&gt;&lt;th&gt;"</span>)
           <span style="color: #FF7F7F;">end</span>

           <span style="color: #FF7F7F;">if</span> <span style="color: #7F7FFF;">@options</span>[<span style="color: #FFBF7F;">:export_footnotes</span>] <span style="color: #FF7F7F;">then</span>
             <span style="color: #7F7FFF;">@re_help</span>.rewrite_footnote str <span style="color: #FF7F7F;">do</span> |name, defi|
               <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">TODO escape name for url?</span>
               <span style="color: #7F7FFF;">@footnotes</span>[name] = defi <span style="color: #FF7F7F;">if</span> defi
               quote_tags(<span style="color: #7FFF7F;">"&lt;sup&gt;&lt;a class=\"footref\" name=\"fnr.</span><span style="color: #7F7FFF;">#{name}</span><span style="color: #7FFF7F;">\" href=\"#fn.</span><span style="color: #7F7FFF;">#{name}</span><span style="color: #7FFF7F;">\"&gt;"</span>) +
                 name + quote_tags(<span style="color: #7FFF7F;">"&lt;/a&gt;&lt;/sup&gt;"</span>)
             <span style="color: #FF7F7F;">end</span>
           <span style="color: #FF7F7F;">end</span>

           <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">Two backslashes \\ at the end of the line make a line break without breaking paragraph.</span>
           <span style="color: #FF7F7F;">if</span> <span style="color: #7F7FFF;">@output_type</span> != <span style="color: #FFBF7F;">:table_row</span> <span style="color: #FF7F7F;">and</span> <span style="color: #7F7FFF;">@output_type</span> != <span style="color: #FFBF7F;">:table_header</span> <span style="color: #FF7F7F;">then</span>
             str.sub! <span style="color: #7FFF7F;">/\\\\$/</span>, quote_tags(<span style="color: #7FFF7F;">"&lt;br /&gt;"</span>)
           <span style="color: #FF7F7F;">end</span>

           escape_string! str
           <span style="color: #FFFF7F;">Orgmode</span>.special_symbols_to_html str
           str = <span style="color: #7F7FFF;">@re_help</span>.restore_code_snippets str
         <span style="color: #FF7F7F;">end</span>

         <span style="color: #7FBFFF;">alias_method</span> <span style="color: #FFBF7F;">:_orig_normalize_lang</span>, <span style="color: #FFBF7F;">:normalize_lang</span>
         <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">normalize_lang</span>(lang)
           <span style="color: #FF7F7F;">case</span> lang
           <span style="color: #FF7F7F;">when</span> <span style="color: #7FFF7F;">'conf'</span>
             <span style="color: #7FFF7F;">'ruby'</span>
           <span style="color: #FF7F7F;">else</span>
             _orig_normalize_lang(lang)
           <span style="color: #FF7F7F;">end</span>
         <span style="color: #FF7F7F;">end</span>
       <span style="color: #FF7F7F;">end</span>
     <span style="color: #FF7F7F;">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga033cb7" class="outline-3">
<h3 id="orga033cb7">任意の org ファイルを Jekyll で扱うために</h3>
<div class="outline-text-3" id="text-orga033cb7">
<p>
Jekyll の原稿として org ファイルを使用する際の不満は、
</p>
<ol class="org-ol">
<li>Jekyll の原稿として認識してもらうためには、
org ファイルに yaml で書かれた <a href="http://jekyllrb.com/docs/frontmatter/">Front Matter</a> が必要。
しかしながら、これは org としては美しくない。</li>
<li>Front Matter に記述する内容は、
そもそも org ファイルに存在する内容が多い( <code>#+TITLE</code> とか)。
つまり情報が重複している。</li>
</ol>
<p>
でした。
</p>

<p>
これらの不満を解消してくれるプラグインとしては、
既に <a href="https://github.com/eggcaker/jekyll-org">eggcaker/jekyll-org</a> があります。
ただし、これは <code>Post</code> 専用なので、
Jekyll の blog 記事の範疇に無いページ( いわゆる <code>Page</code> 等)は対象としていません。
</p>

<p>
そんな訳で、結局自分でプラグインを書きました。
</p>
</div>
<div id="outline-container-orgd9f8c00" class="outline-4">
<h4 id="orgd9f8c00"><code>Jekyll::Utils.has_yaml_header?</code> の上書き</h4>
<div class="outline-text-4" id="text-orgd9f8c00">
<p>
org ファイルに Front Matter 相当の情報が存在することを前提として処理、
すなわち、拡張子が <code>.org</code> の場合は常に <code>true</code> を返すようにします。
</p>
<div class="org-src-container">
<pre class="src src-ruby">     <span style="color: #e5e5e6;">#</span><span style="color: #e5e5e6;">!/usr/bin/env ruby</span>
     <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">-*- mode: ruby; coding: utf-8 -*-</span>
     <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">file: org_utils.rb</span>
     <span style="color: #FF7F7F;">module</span> <span style="color: #FFFF7F;">Jekyll</span>
       <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">Judge the file is Org mode?</span>
       <span style="color: #FF7F7F;">module</span> <span style="color: #FFFF7F;">Utils</span>
         <span style="color: #7FBFFF;">alias_method</span> <span style="color: #FFBF7F;">:_orig_has_yaml_header?</span>, <span style="color: #FFBF7F;">:has_yaml_header?</span>

         <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">has_yaml_header?</span>(file)
           <span style="color: #FF7F7F;">if</span> <span style="color: #FFFF7F;">File</span>.extname(file) =~ <span style="color: #7FFF7F;">/org/</span>
             <span style="color: #FFBF7F;">true</span>
           <span style="color: #FF7F7F;">else</span>
             _orig_has_yaml_header?(file)
           <span style="color: #FF7F7F;">end</span>
         <span style="color: #FF7F7F;">end</span>
       <span style="color: #FF7F7F;">end</span>
     <span style="color: #FF7F7F;">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org31845e6" class="outline-4">
<h4 id="org31845e6"><code>Jekyll::Convertible</code> の上書き</h4>
<div class="outline-text-4" id="text-org31845e6">
<p>
<code>org</code> ファイルの <code>#+TITLE</code> 等を FRONT<sub>MATTER</sub> として扱った上で、
html に出力します。
また <code>#+TITLE</code> が 2 回出力されるのを防ぐために、
org-ruby で処理する前に <code>#+TITLE</code> を削除しています。
</p>
<div class="org-src-container">
<pre class="src src-ruby">     <span style="color: #e5e5e6;">#</span><span style="color: #e5e5e6;">! /usr/bin/env ruby</span>
     <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">-*- mode: ruby; coding: utf-8 -*-</span>
     <span style="color: #7FBFFF;">require</span> <span style="color: #7FFF7F;">'org-ruby'</span>

     <span style="color: #FF7F7F;">module</span> <span style="color: #FFFF7F;">Jekyll</span>
       <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">Handling Org options as YAML front matter, escape liquid tag</span>
       <span style="color: #FF7F7F;">module</span> <span style="color: #FFFF7F;">Convertible</span>
         <span style="color: #7FBFFF;">alias_method</span> <span style="color: #FFBF7F;">:_orig_read_yaml</span>, <span style="color: #FFBF7F;">:read_yaml</span>

         <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">read_yaml</span>(base, name, opts = {})
           <span style="color: #FF7F7F;">if</span> name =~ <span style="color: #7FFF7F;">/org$/</span>
             content = <span style="color: #FFFF7F;">File</span>.read(site.in_source_dir(base, name),
                                 merged_file_read_opts(opts))
             <span style="color: #FF7F7F;">if</span> <span style="color: #FFFF7F;">File</span>.exist?(<span style="color: #7FFF7F;">'_html_tags.yml'</span>)
               org = <span style="color: #FFFF7F;">Orgmode</span>::<span style="color: #FFFF7F;">Parser</span>.new(content,
                                                 <span style="color: #FFBF7F;">markup_file:</span> <span style="color: #7FFF7F;">'_html_tags.yml'</span>)
             <span style="color: #FF7F7F;">else</span>
               org = <span style="color: #FFFF7F;">Orgmode</span>::<span style="color: #FFFF7F;">Parser</span>.new(content)
             <span style="color: #FF7F7F;">end</span>
             yaml_front_matter = {}
             org.in_buffer_settings.each_pair <span style="color: #FF7F7F;">do</span> |k, v|
               yaml_front_matter.merge!(k.downcase =&gt; v)
             <span style="color: #FF7F7F;">end</span>
             <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">remove '#+HTML'</span>
             yaml_front_matter = yaml_front_matter.delete_if { |k, v| k == <span style="color: #7FFF7F;">'html'</span> }
             <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">remove '#+LATEX'</span>
             yaml_front_matter = yaml_front_matter.delete_if { |k, v| k == <span style="color: #7FFF7F;">'latex'</span> }
             <span style="color: #FF7F7F;">self</span>.data = <span style="color: #FFFF7F;">SafeYAML</span>.load(yaml_front_matter.to_yaml + <span style="color: #7FFF7F;">"---\n"</span>)
             <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">remove '#+TITLE' avoid double exporting</span>
             org.in_buffer_settings.delete_if {|k, v| k == <span style="color: #7FFF7F;">'TITLE'</span> }
             <span style="color: #FF7F7F;">if</span> yaml_front_matter.key?(<span style="color: #7FFF7F;">'liquid'</span>)
               <span style="color: #FF7F7F;">self</span>.content = org.to_html
               <span style="color: #FF7F7F;">self</span>.content = <span style="color: #FF7F7F;">self</span>.content.gsub(<span style="color: #7FFF7F;">'&amp;#8216;'</span>, <span style="color: #7FFF7F;">"'"</span>)
               <span style="color: #FF7F7F;">self</span>.content = <span style="color: #FF7F7F;">self</span>.content.gsub(<span style="color: #7FFF7F;">'&amp;#8217;'</span>, <span style="color: #7FFF7F;">"'"</span>)
             <span style="color: #FF7F7F;">else</span>
               <span style="color: #FF7F7F;">self</span>.content = <span style="color: #7FFF7F;">&lt;&lt;ORG</span>
<span style="color: #7FFF7F;">     </span><span style="color: #7F7FFF;">#{org.to_html.gsub('{','&amp;#123;').gsub('{','&amp;#125;')}</span>
<span style="color: #7FFF7F;">     ORG</span>
<span style="color: #7FFF7F;">             end</span>
<span style="color: #7FFF7F;">           else</span>
<span style="color: #7FFF7F;">             _orig_read_yaml(base, name, opts)</span>
<span style="color: #7FFF7F;">           end</span>
<span style="color: #7FFF7F;">         end</span>
<span style="color: #7FFF7F;">       end</span>
<span style="color: #7FFF7F;">     end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9ac6cb6" class="outline-4">
<h4 id="org9ac6cb6"><code>Jekyll::OrgConverter</code> の追加</h4>
<div class="outline-text-4" id="text-org9ac6cb6">
<p>
Converter の追加は Jekyll 本家のドキュメントにもあるので、
割と簡単です。実際の処理は上書きした <code>Jekyll::Convertible</code> で行なわれています。
ただ、search link を処理するために、最後にリンクを置換しています。
</p>
<div class="org-src-container">
<pre class="src src-ruby">      <span style="color: #e5e5e6;">#</span><span style="color: #e5e5e6;">!/usr/bin/env ruby</span>
      <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">-*- mode: ruby; coding: utf-8 -*-</span>
      <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">file: org.rb</span>
      <span style="color: #7FBFFF;">require</span> <span style="color: #7FFF7F;">'org-ruby'</span>

      <span style="color: #FF7F7F;">module</span> <span style="color: #FFFF7F;">Jekyll</span>
        <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">Add New Converter handling org-mode</span>
        <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">main logic -&gt; @see org_convertible.rb</span>
        <span style="color: #FF7F7F;">class</span> <span style="color: #FFFF7F;">OrgConverter</span> &lt; <span style="color: #FFFF7F;">Converter</span>
          safe <span style="color: #FFBF7F;">true</span>
          priority <span style="color: #FFBF7F;">:low</span>

          <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">matches</span>(ext)
            ext =~ <span style="color: #7FFF7F;">/^\.org$/</span><span style="color: #FF4C4C;">i</span>
          <span style="color: #FF7F7F;">end</span>

          <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">output_ext</span>(ext)
            <span style="color: #7FFF7F;">'.html'</span>
          <span style="color: #FF7F7F;">end</span>

          <span style="color: #FF7F7F;">def</span> <span style="color: #BF7FFF;">convert</span>(content)
            <span style="color: #e5e5e6;"># </span><span style="color: #e5e5e6;">ad hoc file link conversion</span>
            content.gsub(<span style="color: #7FFF7F;">/&lt;a href="([^(http:\/\/|https:\/\/|mailto:)]\S+)\.org/</span>,
                         <span style="color: #7FFF7F;">"&lt;a href=\"\\1.html"</span>)
          <span style="color: #FF7F7F;">end</span>
        <span style="color: #FF7F7F;">end</span>
      <span style="color: #FF7F7F;">end</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org053d277" class="outline-2">
<h2 id="org053d277">まとめ…?</h2>
<div class="outline-text-2" id="text-org053d277">
<p>
まあ、ちゃんと動いているみたいですし、これで良いのかなぁ。
</p>

<p>
お気付きの点などございましたら、<a href="https://github.com/uwabami/jekyll-org-converter/issues">Issues</a> へお願いします。
</p>
</div>
</div>
