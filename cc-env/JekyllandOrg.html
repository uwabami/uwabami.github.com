---
title: このサイトができるまで
date: 2017-01-16 23:59:32
layout: cc-env
lang: ja
ref: cc-env/JekyllandOrg
permalink: /cc-env/JekyllandOrg.html
---
<div id="toc-wrapper">
<nav id="table-of-contents">
<h2>&#30446;&#27425;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgba9e615">はじめに</a></li>
<li><a href="#org654d35f">作ったモノ</a></li>
<li><a href="#orge025a38">使い方</a></li>
<li><a href="#org8113c2d">解説(?)</a>
<ul>
<li><a href="#orgf59705b">org ファイルの変換</a></li>
<li><a href="#org74a5378">org-ruby の拡張(?)</a></li>
<li><a href="#org6a4c908">任意の org ファイルを Jekyll で扱うために</a>
<ul>
<li><a href="#orgec12c06"><code>Jekyll::Utils.has_yaml_header?</code> の上書き</a></li>
<li><a href="#orgbda45a0"><code>Jekyll::Convertible</code> の上書き</a></li>
<li><a href="#org111075f"><code>Jekyll::OrgConverter</code> の追加</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4864e44">まとめ…?</a></li>
</ul>
</div>
</nav>
</div>
<a href="#toc-toggle" class="btn toc-btn" id="toc-toggle">&#30446;&#27425;</a>
<div id="outline-container-orgba9e615" class="outline-2">
<h2 id="orgba9e615">はじめに</h2>
<div class="outline-text-2" id="text-orgba9e615">
<div class="alert alert-danger">
<p>
<strong>以下，最近は使っていないので，今でも動くのは定かではありません．patch welcome!</strong>
</p>
</div>

<p>
このサイトは、記事を Emacs の <a href="http://orgmode.org/">Org mode</a> で書いて、
<a href="http://jekyllrb.com/">Jekyll</a> で HTML に変換しています。
<code>org</code> ファイルそのものに(なるべく)手を加えることなく、
それなりに一貫性を持ってコンテンツを作成するために、
幾つかプラグインを書いています。その解説など。
</p>
</div>
</div>
<div id="outline-container-org654d35f" class="outline-2">
<h2 id="org654d35f">作ったモノ</h2>
<div class="outline-text-2" id="text-org654d35f">
<p>
コードの詳細は Github をご覧下さい。
</p>
<ul class="org-ul">
<li><a href="https://github.com/uwabami/jekyll-org-converter">Github::uwabami/jekyll-org-converter</a></li>
</ul>
</div>
</div>
<div id="outline-container-orge025a38" class="outline-2">
<h2 id="orge025a38">使い方</h2>
<div class="outline-text-2" id="text-orge025a38">
<p>
jekyll の <code>_plugin</code> に submodule としてでも放り込んで下さい。
</p>

<p>
org ファイルを html へ出力する際のタグのカスタマイズをしたい場合には、
<code>_html_tags.yml</code> を作成しておきます(リポジトリに example を置いてあります)。
</p>

<p>
原稿となる org ファイルには、最低限
</p>
<div class="org-src-container">
<pre class="src src-org">    #+TITLE:
    #+DATE:
    #+LAYOUT:
</pre>
</div>
<p>
を記載しておいて下さい。これが Jekyll の Front Matter になります。
他にも <code>#+HTML</code> および <code>#+LATEX</code> 以外の Option が書け、
downcase したのち Front Matter として使用できます。
</p>
</div>
</div>
<div id="outline-container-org8113c2d" class="outline-2">
<h2 id="org8113c2d">解説(?)</h2>
<div class="outline-text-2" id="text-org8113c2d">
<p>
解説するようなモンでもないですけれど。
</p>
</div>
<div id="outline-container-orgf59705b" class="outline-3">
<h3 id="orgf59705b">org ファイルの変換</h3>
<div class="outline-text-3" id="text-orgf59705b">
<p>
ファイルの HTML への変換には <a href="https://github.com/wallyqs/org-ruby">wallyqs/org-ruby</a> を使っています。
</p>
<ul class="org-ul">
<li>利点: Emacs の org-exporter のカスタマイズを行なう必要が無い。</li>
<li>利点: jekyll に自然に組み込める</li>
<li>欠点: org-exporter での code block 実行結果の export が使えなくなる</li>
</ul>

<p>
org-exporter による「code block 実行結果の埋め込み」を使いたい場合には、
org-exporter での html 出力をカスタマイズした後に、jekyll で処理することになります。
このアプローチは <a href="http://juanreyero.com/open/org-jekyll/">org-jekyll, export blog posts from org-mode</a> でしょう。
また、Github Pages でコンテンツを公開することを考える場合には、
plugin が使えないため、
リンク先のアプローチを取る必要があります。
</p>

<p>
以前は同様の事を行なっていたのですが、
</p>
<ol class="org-ol">
<li>jekyll を動作させるサーバ上の Emacs のバージョンと手元のバージョンとの乖離</li>
<li>org のファイルと html ファイルの双方をリポジトリで管理する無駄さ</li>
</ol>
<p>
から、結局 org ファイルを直接 jekyll で処理することにしました。
</p>
</div>
</div>
<div id="outline-container-org74a5378" class="outline-3">
<h3 id="org74a5378">org-ruby の拡張(?)</h3>
<div class="outline-text-3" id="text-org74a5378">
<p>
最新の org-ruby では org-mode の search link を export してくれません。
そんな訳で monkey patch です。
<code>Orgmode::HtmlOutputBuffer.inline_formatting</code> が割と大きな method なので、
小さな monkey patch のつもりが、ほぼコピペになってしまいました…。
</p>
<div class="org-src-container">
<pre class="src src-ruby">     #! /usr/bin/env ruby
     # -*- mode: ruby; coding: utf-8 -*-
     # file: org_monkey.rb
     #
     # Monkey Patch: Add support org search link
     require 'org-ruby'

     module Orgmode
       # monkey patch Orgmode::to_html inline_formatter
       class HtmlOutputBuffer &lt; OutputBuffer

         alias_method :_orig_add_line_attributes, :add_line_attributes
         def add_line_attributes(headline)
           _orig_add_line_attributes(headline)
           @output &lt;&lt; "&lt;a id=\"#{headline.headline_text}\"&gt;&lt;span class='anchor'&gt;_&lt;/span&gt;&lt;/a&gt;"
         end

         alias_method :_orig_inline_formatting, :inline_formatting
         def inline_formatting(str)
           @re_help.rewrite_emphasis str do |marker, s|
             if marker == "=" or marker == "~"
               s = escapeHTML s
               "&lt;#{Tags[marker][:open]}&gt;#{s}&lt;/#{Tags[marker][:close]}&gt;"
             else
               quote_tags("&lt;#{Tags[marker][:open]}&gt;") + s +
                 quote_tags("&lt;/#{Tags[marker][:close]}&gt;")
             end
           end

           if @options[:use_sub_superscripts] then
             @re_help.rewrite_subp str do |type, text|
               if type == "_" then
                 quote_tags("&lt;sub&gt;") + text + quote_tags("&lt;/sub&gt;")
               elsif type == "^" then
                 quote_tags("&lt;sup&gt;") + text + quote_tags("&lt;/sup&gt;")
               end
             end
           end

           @re_help.rewrite_links str do |link, defi|
             [link, defi].compact.each do |text|
               # We don't support search links right now. Get rid of it.
               # -&gt; Support search links!!
               text.sub!(/\A(file:[^\s]+)::([^\s]*?)\Z/, "\\1#\\2")
               text.sub!(/\Afile:(?=[^\s]+\Z)/, "")
             end

             # We don't add a description for images in links, because its
             # empty value forces the image to be inlined.
             defi ||= link unless link =~ @re_help.org_image_file_regexp

             if defi =~ @re_help.org_image_file_regexp
               defi = quote_tags "&lt;img src=\"#{defi}\" alt=\"#{defi}\" /&gt;"
             end

             if defi
               link = @options[:link_abbrevs][link] if @options[:link_abbrevs].has_key? link
               quote_tags("&lt;a href=\"#{link}\"&gt;") + defi + quote_tags("&lt;/a&gt;")
             else
               quote_tags "&lt;img src=\"#{link}\" alt=\"#{link}\" /&gt;"
             end
           end

           if @output_type == :table_row
             str.gsub! /^\|\s*/, quote_tags("&lt;td&gt;")
             str.gsub! /\s*\|$/, quote_tags("&lt;/td&gt;")
             str.gsub! /\s*\|\s*/, quote_tags("&lt;/td&gt;&lt;td&gt;")
           end

           if @output_type == :table_header
             str.gsub! /^\|\s*/, quote_tags("&lt;th&gt;")
             str.gsub! /\s*\|$/, quote_tags("&lt;/th&gt;")
             str.gsub! /\s*\|\s*/, quote_tags("&lt;/th&gt;&lt;th&gt;")
           end

           if @options[:export_footnotes] then
             @re_help.rewrite_footnote str do |name, defi|
               # TODO escape name for url?
               @footnotes[name] = defi if defi
               quote_tags("&lt;sup&gt;&lt;a class=\"footref\" name=\"fnr.#{name}\" href=\"#fn.#{name}\"&gt;") +
                 name + quote_tags("&lt;/a&gt;&lt;/sup&gt;")
             end
           end

           # Two backslashes \\ at the end of the line make a line break without breaking paragraph.
           if @output_type != :table_row and @output_type != :table_header then
             str.sub! /\\\\$/, quote_tags("&lt;br /&gt;")
           end

           escape_string! str
           Orgmode.special_symbols_to_html str
           str = @re_help.restore_code_snippets str
         end

         alias_method :_orig_normalize_lang, :normalize_lang
         def normalize_lang(lang)
           case lang
           when 'conf'
             'ruby'
           else
             _orig_normalize_lang(lang)
           end
         end
       end
     end
</pre>
</div>
</div>
</div>
<div id="outline-container-org6a4c908" class="outline-3">
<h3 id="org6a4c908">任意の org ファイルを Jekyll で扱うために</h3>
<div class="outline-text-3" id="text-org6a4c908">
<p>
Jekyll の原稿として org ファイルを使用する際の不満は、
</p>
<ol class="org-ol">
<li>Jekyll の原稿として認識してもらうためには、
org ファイルに yaml で書かれた <a href="http://jekyllrb.com/docs/frontmatter/">Front Matter</a> が必要。
しかしながら、これは org としては美しくない。</li>
<li>Front Matter に記述する内容は、
そもそも org ファイルに存在する内容が多い( <code>#+TITLE</code> とか)。
つまり情報が重複している。</li>
</ol>
<p>
でした。
</p>

<p>
これらの不満を解消してくれるプラグインとしては、
既に <a href="https://github.com/eggcaker/jekyll-org">eggcaker/jekyll-org</a> があります。
ただし、これは <code>Post</code> 専用なので、
Jekyll の blog 記事の範疇に無いページ( いわゆる <code>Page</code> 等)は対象としていません。
</p>

<p>
そんな訳で、結局自分でプラグインを書きました。
</p>
</div>
<div id="outline-container-orgec12c06" class="outline-4">
<h4 id="orgec12c06"><code>Jekyll::Utils.has_yaml_header?</code> の上書き</h4>
<div class="outline-text-4" id="text-orgec12c06">
<p>
org ファイルに Front Matter 相当の情報が存在することを前提として処理、
すなわち、拡張子が <code>.org</code> の場合は常に <code>true</code> を返すようにします。
</p>
<div class="org-src-container">
<pre class="src src-ruby">     #!/usr/bin/env ruby
     # -*- mode: ruby; coding: utf-8 -*-
     # file: org_utils.rb
     module Jekyll
       # Judge the file is Org mode?
       module Utils
         alias_method :_orig_has_yaml_header?, :has_yaml_header?

         def has_yaml_header?(file)
           if File.extname(file) =~ /org/
             true
           else
             _orig_has_yaml_header?(file)
           end
         end
       end
     end
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbda45a0" class="outline-4">
<h4 id="orgbda45a0"><code>Jekyll::Convertible</code> の上書き</h4>
<div class="outline-text-4" id="text-orgbda45a0">
<p>
<code>org</code> ファイルの <code>#+TITLE</code> 等を FRONT<sub>MATTER</sub> として扱った上で、
html に出力します。
また <code>#+TITLE</code> が 2 回出力されるのを防ぐために、
org-ruby で処理する前に <code>#+TITLE</code> を削除しています。
</p>
<div class="org-src-container">
<pre class="src src-ruby">     #! /usr/bin/env ruby
     # -*- mode: ruby; coding: utf-8 -*-
     require 'org-ruby'

     module Jekyll
       # Handling Org options as YAML front matter, escape liquid tag
       module Convertible
         alias_method :_orig_read_yaml, :read_yaml

         def read_yaml(base, name, opts = {})
           if name =~ /org$/
             content = File.read(site.in_source_dir(base, name),
                                 merged_file_read_opts(opts))
             if File.exist?('_html_tags.yml')
               org = Orgmode::Parser.new(content,
                                                 markup_file: '_html_tags.yml')
             else
               org = Orgmode::Parser.new(content)
             end
             yaml_front_matter = {}
             org.in_buffer_settings.each_pair do |k, v|
               yaml_front_matter.merge!(k.downcase =&gt; v)
             end
             # remove '#+HTML'
             yaml_front_matter = yaml_front_matter.delete_if { |k, v| k == 'html' }
             # remove '#+LATEX'
             yaml_front_matter = yaml_front_matter.delete_if { |k, v| k == 'latex' }
             self.data = SafeYAML.load(yaml_front_matter.to_yaml + "---\n")
             # remove '#+TITLE' avoid double exporting
             org.in_buffer_settings.delete_if {|k, v| k == 'TITLE' }
             if yaml_front_matter.key?('liquid')
               self.content = org.to_html
               self.content = self.content.gsub('&amp;#8216;', "'")
               self.content = self.content.gsub('&amp;#8217;', "'")
             else
               self.content = &lt;&lt;ORG
     #{org.to_html.gsub('{','&amp;#123;').gsub('{','&amp;#125;')}
     ORG
             end
           else
             _orig_read_yaml(base, name, opts)
           end
         end
       end
     end
</pre>
</div>
</div>
</div>
<div id="outline-container-org111075f" class="outline-4">
<h4 id="org111075f"><code>Jekyll::OrgConverter</code> の追加</h4>
<div class="outline-text-4" id="text-org111075f">
<p>
Converter の追加は Jekyll 本家のドキュメントにもあるので、
割と簡単です。実際の処理は上書きした <code>Jekyll::Convertible</code> で行なわれています。
ただ、search link を処理するために、最後にリンクを置換しています。
</p>
<div class="org-src-container">
<pre class="src src-ruby">      #!/usr/bin/env ruby
      # -*- mode: ruby; coding: utf-8 -*-
      # file: org.rb
      require 'org-ruby'

      module Jekyll
        # Add New Converter handling org-mode
        # main logic -&gt; @see org_convertible.rb
        class OrgConverter &lt; Converter
          safe true
          priority :low

          def matches(ext)
            ext =~ /^\.org$/i
          end

          def output_ext(ext)
            '.html'
          end

          def convert(content)
            # ad hoc file link conversion
            content.gsub(/&lt;a href="([^(http:\/\/|https:\/\/|mailto:)]\S+)\.org/,
                         "&lt;a href=\"\\1.html")
          end
        end
      end
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org4864e44" class="outline-2">
<h2 id="org4864e44">まとめ…?</h2>
<div class="outline-text-2" id="text-org4864e44">
<p>
まあ、ちゃんと動いているみたいですし、これで良いのかなぁ。
</p>

<p>
お気付きの点などございましたら、<a href="https://github.com/uwabami/jekyll-org-converter/issues">Issues</a> へお願いします。
</p>
</div>
</div>
